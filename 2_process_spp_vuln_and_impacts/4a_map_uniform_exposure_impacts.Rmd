---
title: "Map cumulative impacts from uniform-exposure stressors"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 4, fig.width = 7)

library(raster)
library(oharac)
library(data.table)
library(tidyverse)
library(here)
source(here('common_fxns.R'))

```

# Summary

For most stressors, exposure is identical across all species and taxa, like nutrient pollution, light pollution, etc (as opposed to targeted fishing, bycatch, or thermal stress where the stressor intensity is dependent on the species).  For these stressors, with vulnerability maps by unweighted and FV-weighted mean, we can calculate impacts simply by multiplying mean vulnerability and stressor intensity.  For species-dependent stressors, see scripts 4a, 4b, and 4c.

# Data

See scripts 2, 3a, and 3b for vulnerability mapping scripts.

# Methods

## Determine stressor and vulnerability matchups

```{r stressors to vulnerability lookup}
str_vuln_lookup_f <- here('_data/stressor_vulnerability_lookup.csv')
if(!file.exists(str_vuln_lookup_f)) {
  str_vuln_lookup <- tribble(
    ~stressor,              ~vulnerability,
     'biomass_removal',      'biomass_removal', # not uniform exposure
     'sst_rise',             'sst_rise',        # not uniform exposure
     'bycatch',              'bycatch',         # not uniform exposure
     'sst_extremes',         'marine_heat_waves',
     'ocean_acidification',  'ocean_acidification',
     'sea_level_rise',       'sea_level_rise',
     'uv_radiation',         'uv_radiation',
     'fishing_benthic_dest', 'habitat_loss_degradation',
     'benth_str',            'habitat_loss_degradation',
     'direct_human',         'habitat_loss_degradation',
     'shipping_large',       'wildlife_strike',
     'light',                'light_pollution',
     'nutrient',             'eutrophication_nutrient_pollution',
     'microplastics',        'plastic_pollution_microplastic'
    )
  write_csv(str_vuln_lookup, str_vuln_lookup_f)
}

str_vuln_lookup_raw <- read_csv(str_vuln_lookup_f)
knitr::kable(str_vuln_lookup_raw)

str_vuln_lookup <- str_vuln_lookup_raw %>%
  filter(!stressor %in% c('biomass_removal', 'bycatch', 'sst_rise'))
```

Exposure to stressors `biomass_removal`, `sst_rise`, and `bycatch` are not uniform across all species, and will need to be dealt with in a more complex manner when calculating impact.

## Read in stressor layers

These do not change based on different vulnerability weighting schemes...

```{r}
str_fs <- list.files(here('_data/stressors_mol'), full.names = TRUE)
str_fs <- str_fs[str_detect(str_fs, paste(str_vuln_lookup$stressor, collapse = '|'))]

str_stack <- stack(str_fs) %>%
  setNames(basename(str_fs) %>% str_remove('_[0-9]{4}.tif'))
```

## Impacts by unweighted mean vulnerability

Using the average vulnerability value across all species, calculate impacts by stressor and overall.

### Loop over stressors

For each line in the above listing, determine the impact (mean and sd) of that stressor on the suite of species in each cell, based on that vulnerability.

```{r}
vuln_string <- paste(str_vuln_lookup$vulnerability, collapse = '|')

vuln1_mean_fs <- list.files(here('_output/vuln_maps/vuln_maps_unweighted'), 
                            pattern = 'mean.tif', full.names = TRUE)
vuln1_mean_fs <- vuln1_mean_fs[str_detect(vuln1_mean_fs, vuln_string)]

vuln1_mean_stack <- stack(vuln1_mean_fs) %>%
  setNames(basename(vuln1_mean_fs) %>% str_remove_all('vuln_unwt_|_mean.tif'))

vuln1_sd_fs <- list.files(here('_output/vuln_maps/vuln_maps_unweighted'), 
                          pattern = 'sdev.tif', full.names = TRUE)
vuln1_sd_fs <- vuln1_sd_fs[str_detect(vuln1_sd_fs, vuln_string)]

vuln1_sd_stack <- stack(vuln1_sd_fs) %>%
  setNames(basename(vuln1_sd_fs) %>% str_remove_all('vuln_unwt_|_sdev.tif'))
```

```{r loop impact by unweighted vulnerability}
for(i in 1:nrow(str_vuln_lookup)) {
  ### i <- 1
  s <- str_vuln_lookup$stressor[i]
  v <- str_vuln_lookup$vulnerability[i]
  
  f_stem <- here('_output/impact_maps/impact_maps_unweighted', 
                 'impact_unwt_%s_x_%s_%s.tif')
  f_out  <- sprintf(f_stem, s, v, c('mean', 'sdev'))
  
  if(any(!file.exists(f_out))) {
    message('Calculating mean/sd impacts for stressor ', s, ' by vuln ', v, '...')
    
    s_rast <- str_stack[[s]]
    v_mean_rast <- vuln1_mean_stack[[v]]
    v_sdev_rast <- vuln1_sd_stack[[v]]
    i_mean_rast <- s_rast * v_mean_rast
    i_sdev_rast <- s_rast * v_sdev_rast
    # values(i_rast) <- round(values(i_rast), 5)
    
    writeRaster(i_mean_rast, f_out[1], overwrite = TRUE)
    writeRaster(i_sdev_rast, f_out[2], overwrite = TRUE)
  }
  
  # p <- s_v_i_plot(s_rast, v_rast, i_rast, flag = 'unweighted all')

  # print(p)
}
```

```{r plot impacts by unweighted vuln, eval = FALSE, fig.height = 4, fig.width = 7}

imp_map_dir <- here('_output/impact_maps/impact_maps_unweighted')
imp_map_fs <- list.files(imp_map_dir, pattern = '_mean.tif', full.names = TRUE)

focal_strs <- c('microplastic', 'wildlife_strike',
                'nutrient_pollution', 'ocean_acidification', 'marine_heat_wave',
                'light_pollution')

for(f in focal_strs) { ### f <- focal_strs[1]
  str_name <- str_replace_all(f, '[^a-z]+', ' ') %>%
    str_squish() %>%
    str_to_title()
  
  message('Plotting impact maps for ', tolower(str_name), '...')
  imp_map_f <- imp_map_fs[str_detect(basename(imp_map_fs), f)]
  imp_rast <- raster::raster(imp_map_f)

  map_cols <- hcl.colors(n = 50)
  
  plot(imp_rast, col = map_cols, 
       main = paste0('Impact, unweighted vuln: ', f),
       legend = TRUE, axes = FALSE)  
}
```

## Impacts by FV-weighted vulnerability

Using the FV-weighted vulnerability value, calculate impacts by stressor and overall.

```{r}
vuln2_mean_fs <- list.files(here('_output/vuln_maps/vuln_maps_fv_weighted'), 
                       pattern = 'mean.tif', full.names = TRUE)
vuln2_mean_fs <- vuln2_mean_fs[str_detect(vuln2_mean_fs, vuln_string)]

vuln2_mean_stack <- stack(vuln2_mean_fs) %>%
  setNames(basename(vuln2_mean_fs) %>% str_remove_all('vuln_fvwt_|_mean.tif'))

vuln2_sd_fs <- list.files(here('_output/vuln_maps/vuln_maps_fv_weighted'), 
                       pattern = 'sdev.tif', full.names = TRUE)
vuln2_sd_fs <- vuln2_sd_fs[str_detect(vuln2_sd_fs, vuln_string)]

vuln2_sd_stack <- stack(vuln2_sd_fs) %>%
  setNames(basename(vuln2_sd_fs) %>% str_remove_all('vuln_fvwt_|_sdev.tif'))
```

```{r loop impact by fv-weighted vulnerability}
for(i in 1:nrow(str_vuln_lookup)) {
  ### i <- 2
  s <- str_vuln_lookup$stressor[i]
  v <- str_vuln_lookup$vulnerability[i]
  
  f_stem <- here('_output/impact_maps/impact_maps_fv_weighted', 
                 'impact_fvwt_%s_x_%s_%s.tif')
  f_out  <- sprintf(f_stem, s, v, c('mean', 'sdev'))
  
  if(any(!file.exists(f_out))) {
    message('Calculating FV-weighted mean/sd impacts for stressor ', s, 
            ' by vuln ', v, '...')
    
    s_rast <- str_stack[[s]]
    v_mean_rast <- vuln2_mean_stack[[v]]
    v_sdev_rast <- vuln2_sd_stack[[v]]
    i_mean_rast <- s_rast * v_mean_rast
    i_sdev_rast <- s_rast * v_sdev_rast
    # values(i_rast) <- round(values(i_rast), 5)
    
    writeRaster(i_mean_rast, f_out[1], overwrite = TRUE)
    writeRaster(i_sdev_rast, f_out[2], overwrite = TRUE)
  }
}
```

```{r plot impacts by fv-weighted vuln, eval = FALSE, fig.height = 4, fig.width = 7}

imp_map_dir <- here('_output/impact_maps/impact_maps_fv_weighted')
imp_map_fs <- list.files(imp_map_dir, pattern = 'mean.tif', full.names = TRUE)

for(f in focal_strs) { ### f <- focal_strs[1]
  str_name <- str_replace_all(f, '[^a-z]+', ' ') %>%
    str_squish() %>%
    str_to_title()
  
  message('Plotting impact maps for ', tolower(str_name), '...')
  imp_map_f <- imp_map_fs[str_detect(basename(imp_map_fs), f)]
  imp_rast <- raster::raster(imp_map_f)

  map_cols <- hcl.colors(n = 50)
  
  plot(imp_rast, col = map_cols, 
       main = paste0('Impact, FV-weighted vuln: ', f),
       legend = TRUE, axes = FALSE)  
}
```

## Difference maps

Loop over several focal stressors.  For each stressor, read in the maps of unweighted mean impact $\bar x$ and fv-weighted mean impact $\bar x_{FV}$.  Calculate difference as proportional difference in FV-weighted mean relative to unweighted mean impact: 
$$diff = (\bar x_{FV} - \bar x) / \bar x$$

```{r}
  
squish_rast <- function(r, qtile = .999) {
  r_vals <- values(r); r_vals <- r_vals[!is.na(r_vals)]
  r_zlim <- max(abs(quantile(r_vals, 1 - qtile)), abs(quantile(r_vals, qtile)))
  values(r)[values(r) > r_zlim] <- r_zlim
  values(r)[values(r) < -r_zlim] <- -r_zlim
  
  return(list(r = r, zlim = r_zlim))
}

mean_unwt_fs <- list.files(here('_output/impact_maps/impact_maps_unweighted'), 
                           pattern = '_mean.tif', full.names = TRUE)
mean_fvwt_fs <- list.files(here('_output/impact_maps/impact_maps_fv_weighted'), 
                           pattern = '_mean.tif', full.names = TRUE)

focal_strs <- c('microplastic', 'wildlife_strike',
                'nutrient_pollution', 'ocean_acidification', 
                'habitat_loss_degradation',
                'sst_rise', 'marine_heat_wave',
                'light_pollution')

for(f in focal_strs) { ### f <- focal_strs[5]
  str_name <- str_replace_all(f, '[^a-z]+', ' ') %>%
    str_squish() %>%
    str_to_title()
  
  unwt_f <- mean_unwt_fs[str_detect(mean_unwt_fs, f)]
  fvwt_f <- mean_fvwt_fs[str_detect(mean_fvwt_fs, f)]
  
  if(length(unwt_f) > 1) {
    unwt_r <- stack(unwt_f) %>% 
      calc(sum, na.rm = TRUE) %>%
      mask(raster(here('_spatial/ocean_area_mol.tif')))
    fvwt_r <- stack(fvwt_f) %>% 
      calc(sum, na.rm = TRUE) %>%
      mask(raster(here('_spatial/ocean_area_mol.tif')))
  } else {
    unwt_r <- raster(unwt_f)
    fvwt_r <- raster(fvwt_f)
  }
  
  ### Set up rasters; trim extreme values
  mean_diff_rast <- (fvwt_r - unwt_r) / unwt_r
  mean_diff_squished <- squish_rast(mean_diff_rast, qtile = .999)
  # cv_diff_rast <- (cv_rast_fvwt - cv_rast_unwt) / cv_rast_unwt
  # cv_r_sq <- squish_rast(cv_diff_rast, qtile = .999)
  
  m_d_mask_0.10 <- m_d_mask_0.25 <- mean_diff_squished$r
  values(m_d_mask_0.10)[values(unwt_r) < .10 & values(fvwt_r) < .10] <- NA
  values(m_d_mask_0.25)[values(unwt_r) < .25 & values(fvwt_r) < .25] <- NA
  
  message('Plotting difference maps for ', str_name, '...')
  
  ### Set up plot for diverging palette, and symmetric z limits around zero
  map_cols <- hcl.colors(palette = 'Red-Green', n = 50, rev = TRUE)
  
  plot(mean_diff_squished$r, col = map_cols, 
       main = paste0('% Diff in mean vuln: ', str_name, '...'),
       zlim = c(-mean_diff_squished$zlim, mean_diff_squished$zlim), 
       legend = TRUE, axes = FALSE)  
  plot(m_d_mask_0.10, col = map_cols, 
       main = paste0('% Diff in mean vuln masked 0.10: ', str_name, '...'),
       zlim = c(-mean_diff_squished$zlim, mean_diff_squished$zlim), 
       legend = TRUE, axes = FALSE)  
  plot(m_d_mask_0.25, col = map_cols, 
       main = paste0('% Diff in mean vuln masked 0.25: ', str_name, '...'),
       zlim = c(-mean_diff_squished$zlim, mean_diff_squished$zlim), 
       legend = TRUE, axes = FALSE)
}
```
