---
title: "Map cumulative impacts"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 3, fig.width = 12)

library(terra)
library(oharac)
library(tidyverse)
library(here)
source(here('common_fxns.R'))
```

# Summary

With impact maps generated for all stressors, means calculated both unweighted and FV-weighted, we can add the impact layers to generate a comprehensive cumulative human impact map.

# Data

See scripts 2, 3a, and 3b for vulnerability mapping scripts, and scripts 4a-4d for impact calculation scripts.

# Methods

## Calculate CHI: unweighted

Sum impacts across all stressor/vulnerability combos.

```{r calc chi by unweighted vuln, fig.height = 3, fig.width = 6}
imp1_fs <- list.files(here('_output/impact_maps/impact_maps_unweighted'),
                      pattern = 'mean',
                      full.names = TRUE)

imp1_stack <- rast(imp1_fs) %>%
  setNames(str_remove_all(basename(imp1_fs), '.+unwt_|_x_.+|_mean.tif'))

mean_str_unwt <- sapply(imp1_stack, FUN = function(r) mean(values(r), na.rm = TRUE)) %>%
  setNames(names(imp1_stack))
mean_str_unwt_nonzero <- sapply(imp1_stack, FUN = function(r) {
    mean(values(r)[values(r) > 0], na.rm = TRUE)
  }) %>%
  setNames(names(imp1_stack))

```

```{r}
ocean_a_rast <- rast(here('_spatial/ocean_area_mol.tif'))
### Calculate cumulative impacts
chi_unwt_raw <- sum(imp1_stack, na.rm = TRUE)
chi_unweighted <- chi_unwt_raw %>%
  mask(ocean_a_rast) %>%
  setNames('chi_unwt')

writeRaster(chi_unweighted, here('_output/impact_maps/chi_unweighted.tif'),
            overwrite = TRUE)

```

```{r}
### plot with ggplot
chi_unwt_plot <- here('figs/chi_unweighted.png')

chi_unweighted_df <- chi_unweighted %>%
  as.data.frame(xy = TRUE) %>%
  filter(!is.na(chi_unwt))

fill_lbls <- c(0, .1, .25, .5, 1, round(minmax(chi_unweighted)[2], 2))
xfm <- function(x) {x^.25}
p <- ggplot(chi_unweighted_df, aes(x, y, fill = xfm(chi_unwt))) +
  geom_raster() +
  scale_fill_viridis_c(labels = fill_lbls, breaks = xfm(fill_lbls)) +
  coord_sf() +
  theme_void() +
  labs(title = 'CHI by unweighted mean vulnerability',
       fill  = 'CHI')

ggsave(chi_unwt_plot, height = 4, width = 8, dpi = 300)
  
knitr::include_graphics(chi_unwt_plot)
```

## Calculate CHI: FV-weighted

Sum impacts across all stressor/vulnerability combos.

```{r calc chi by fv-weighted vuln, fig.height = 3, fig.width = 6}

imp2_fs <- list.files(here('_output/impact_maps/impact_maps_fv_weighted'), 
                      pattern = 'mean',
                      full.names = TRUE)

imp2_stack <- rast(imp2_fs) %>%
  setNames(str_remove_all(basename(imp2_fs), '.+fvwt_|_x_.+|_mean.tif'))

mean_str_fvwt <- sapply(imp2_stack, FUN = function(r) mean(values(r), na.rm = TRUE)) %>%
  setNames(names(imp2_stack))
mean_str_fvwt_nonzero <- sapply(imp2_stack, FUN = function(r) {
    mean(values(r)[values(r) > 0], na.rm = TRUE)
  }) %>%
  setNames(names(imp2_stack))
pct_nonzero <- sapply(imp2_stack, FUN = function(r) {
    sum(values(r) > 0, na.rm = TRUE) / sum(!is.na(values(r)))
  }) %>%
  setNames(names(imp2_stack))

mean_str_df <- data.frame(stressor = names(imp1_stack)) %>%
  mutate(mean_impact_fvwt = mean_str_fvwt[stressor],
         mean_impact_fvwt_nonzero = mean_str_fvwt_nonzero[stressor],
         mean_impact_unwt = mean_str_unwt[stressor],
         mean_impact_unwt_nonzero = mean_str_unwt_nonzero[stressor],
         pct_nonzero = pct_nonzero[stressor]) %>%
  arrange(desc(mean_impact_fvwt))
knitr::kable(mean_str_df)

```

```{r}
ocean_a_rast <- rast(here('_spatial/ocean_area_mol.tif'))
### Calculate cumulative impacts
chi_fv_wt_raw <- sum(imp2_stack, na.rm = TRUE)

chi_fv_weighted <- chi_fv_wt_raw %>%
  mask(ocean_a_rast) %>%
  setNames('chi_fvwt')

writeRaster(chi_fv_weighted, here('_output/impact_maps/chi_fv_weighted.tif'),
            overwrite = TRUE)

```

```{r}
### plot with ggplot
chi_fvwt_plot <- here('figs/chi_fv_weighted.png')

chi_fv_weighted_df <- chi_fv_weighted %>%
  as.data.frame(xy = TRUE) %>%
  filter(!is.na(chi_fvwt))

fill_lbls <- c(0, .1, .25, .5, 1, round(minmax(chi_fv_weighted)[2], 2))

p <- ggplot(chi_fv_weighted_df, aes(x, y, fill = xfm(chi_fvwt))) +
  geom_raster() +
  scale_fill_viridis_c(labels = fill_lbls, breaks = xfm(fill_lbls)) +
  coord_sf() +
  theme_void() +
  labs(title = 'CHI by FV-weighted mean vulnerability',
       fill = 'CHI')

ggsave(chi_fvwt_plot, height = 4, width = 8, dpi = 300)

knitr::include_graphics(chi_fvwt_plot)
```

## Plot relative difference in CHI

Difference in CHI calculated from FV-weighted vulnerability relative to unweighted vulnerability (using only spp included in functional entities):
$$\frac{CHI_{FV} - CHI_{unweighted}}{CHI_{unweighted}} \times 100\%$$

```{r fv weighted vs unweighted, fig.height = 4, fig.width = 7}
r <- ((chi_fv_weighted - chi_unweighted) / chi_unweighted * 100) %>%
  setNames('layer')

r_vals <- values(r); r_vals <- r_vals[!is.na(r_vals)]
r_zlim <- max(abs(quantile(r_vals, .001)), abs(quantile(r_vals, .999)))
values(r)[values(r) > r_zlim] <- r_zlim
values(r)[values(r) < -r_zlim] <- -r_zlim

### set up thresholded rasts as well
r1 <- r2 <- r
r1[chi_fv_weighted < .10 & chi_unweighted < .10] <- NA
r1[r1 > r_zlim] <- r_zlim
r1[r1 < -r_zlim] <- -r_zlim
r2[chi_fv_weighted < .25 & chi_unweighted < .25] <- NA
r2[r2 > r_zlim] <- r_zlim
r2[r2 < -r_zlim] <- -r_zlim
 
### Difference plots
chi_diff_plot  <- here('figs/chi_fv_diff_unwt.png')
chi_diff1_plot <- here('figs/chi_fv_diff_unwt_0.10.png')
chi_diff2_plot <- here('figs/chi_fv_diff_unwt_0.25.png')

chi_diff_df <- as.data.frame(r, xy = TRUE) %>%
  filter(!is.na(layer))

map_cols <- hcl.colors(palette = 'Red-Green', n = 15, rev = TRUE)

p <- ggplot(chi_diff_df, aes(x, y, fill = layer)) +
    geom_raster() +
    scale_fill_gradientn(colors = map_cols, 
                         limits = c(-r_zlim, r_zlim)) +
    coord_sf() +
    theme_void() +
    labs(title = 'CHI difference between FV and unweighted',
         fill = '%∆CHI')
  
ggsave(chi_diff_plot, height = 4, width = 8, dpi = 300)


### Difference cropped by .10 threshold

chi_diff1_df <- as.data.frame(r1, xy = TRUE) %>%
  filter(!is.na(layer)) 
p <- ggplot(chi_diff1_df, aes(x, y, fill = layer)) +
    geom_raster() +
    scale_fill_gradientn(colors = map_cols, 
                         limits = c(-r_zlim, r_zlim)) +
    coord_sf() +
    theme_void() +
    labs(title = 'CHI difference between FV and unwt (0.10 threshold)',
         fill = '%∆CHI')
  
ggsave(chi_diff2_plot, height = 4, width = 8, dpi = 300)


### Difference cropped by .25 threshold

chi_diff2_df <- as.data.frame(r2, xy = TRUE) %>%
  filter(!is.na(layer))
p <- ggplot(chi_diff2_df, aes(x, y, fill = layer)) +
    geom_raster() +
    scale_fill_gradientn(colors = map_cols, 
                         limits = c(-r_zlim, r_zlim)) +
    coord_sf() +
    theme_void() +
    labs(title = 'CHI difference between FV and unweighted (0.25 threshold)',
         fill = '%∆CHI')
  
ggsave(chi_diff2_plot, height = 4, width = 8, dpi = 300)

knitr::include_graphics(chi_diff_plot)
knitr::include_graphics(chi_diff1_plot)
knitr::include_graphics(chi_diff2_plot)

```

