---
title: "Collect water column position trait"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(oharac)
oharac::setup()
library(rfishbase)
library(ggfortify) ### for PCA plots
source(here('fb_slb_fxns.R'))


```

# Summary

Gather data on water column position from FishBase and the species vulnerability project.  Gapfill using downfill and upstream-downstream gapfill methodology.

# Data

This script will use processed valid species traits from the species vulnerability project, plus FishBase and SeaLifeBase.

FishBase is a scientific database, and this has the implication - among others - that its use and the use of its contents are free as long as due credit is given.

This may be done at different levels, for which we suggest different forms of citations:

* when referring to FishBase concepts and design, cite its architects (Froese and Pauly 2000);
* when referring to a set of values extracted from a FishBase table, cite the author(s) of the original data, e.g., "Houde and Zastrow (1993)", or "Welcomme (1988)". To help us track the use of FishBase in the literature, we would appreciate your also citing Froese and Pauly (2000) in an appropriate part of your text, as the source of the information;
* when discussing the features of a FishBase table, cite the section documenting that table, e.g., "Sa-a et al. (2000)."

## References

* Froese, R. and D. Pauly, Editors. 2000. FishBase 2000: concepts, design and data sources. ICLARM, Los Baños, Laguna, Philippines. 344 p.
* Houde, E.D. and C.E. Zastrow. 1993. Ecosystem- and taxon-specific dynamic energetics properties of fish larvae assemblages. Bull. Mar. Sci. 53(2):290-335.
* Sa-a, P., M.L. Palomares and D. Pauly. 2000. The FOOD ITEMS table, p. 182-188. In R. Froese and D. Pauly (eds.) FishBase 2000: concepts, design and data sources. ICLARM, Los Baños, Laguna, Philippines. 344 p.
* Welcomme, R.L. 1988. International introductions of inland aquatic species. FAO Fish. Tech. Pap. 294, 318 p.
* Butt, N. et al. 2021. 

# Methods

## Read in vulnerability traits data

Read in data from vulnerability project.  For vulnerability traits, identify ones that can classify a species as bottom (benthic/demersal), midwater, surface.  Additionally, examine whether it makes sense to include a variable relating terrestrial/marine life stages, and vertical migration as that relates to changes in position in water column.

```{r}
zone_vuln <- get_vuln_traits() %>%
  filter(trait %in% c('zone', 'terrestrial_and_marine_life_stages', 
                      'within_stage_dependent_habitats_condition', 
                      'across_stage_dependent_habitats_condition', 
                      'air_sea_interface'))

# zone_vuln$trait_value %>% unique()

btm_terms <- c('bottom', 'slope', 'shelf', 'mud', 
               'benth', 'reef', 'rubble', 'intertid', 'demersal') %>%
  paste0(collapse = '|')
btm_vuln <- zone_vuln %>%
  filter(str_detect(trait_value, btm_terms)) %>%
  mutate(water_col_score = 0)
# btm_vuln$trait_value %>% unique()

mid_terms <- c('pelagic', 'mid', 'ocean') %>%
  paste0(collapse = '|')
mid_vuln <- zone_vuln %>%
  filter(str_detect(trait_value, mid_terms)) %>%
  mutate(water_col_score = 1)
# mid_vuln$trait_value %>% unique()
        
top_terms <- c('surface', 'float') %>%
  paste0(collapse = '|')
top_vuln <- zone_vuln %>%
  filter(str_detect(trait_value, top_terms) | 
           (trait == 'air_sea_interface' & trait_value %in% c('yes', 'floating'))) %>%
  mutate(water_col_score = 2)
# top_vuln$trait_value %>% unique()

### take mean across all scored instances, not unique scores - this kind of
### weights the depth zone based on how many traits match up
depth_vuln <- bind_rows(btm_vuln, mid_vuln, top_vuln) %>%
  select(taxon, spp_gp, water_col_score) %>%
  # distinct() %>%
  group_by(taxon, spp_gp) %>%
  summarize(depth_vuln = mean(water_col_score, na.rm = TRUE),
            depth_sd   = sd(water_col_score, na.rm = TRUE), .groups = 'drop') %>%
  downfill() %>%
  right_join(get_worms()) %>%
  gapfill_up_down('depth_vuln')

### terrestrial/marine?
terr_vuln <- zone_vuln %>%
  filter(trait == 'terrestrial_and_marine_life_stages') %>%
  group_by(taxon, spp_gp) %>%
  summarize(terr_score = (trait_value == 'yes') & taxon != 'elasmobranchs',
            .groups = 'drop') %>%
  mutate(terr_score = as.numeric(terr_score)) %>%
  downfill() %>%
  right_join(get_worms()) %>%
  gapfill_up_down('terr_score')

### vertical migrator?
vert_mig_vuln <- get_vuln_traits() %>%
  filter(trait == 'adult_mobility') %>%
  group_by(taxon, spp_gp) %>%
  summarize(vert_mig_score = any(str_detect(trait_value, 'vertical')) %>% as.numeric()) %>%
  downfill() %>%
  right_join(get_worms()) %>%
  gapfill_up_down('vert_mig_score')
```


## Now look in FishBase

``` {r}
keep_cols <- c('demers_pelag')
dem_pel_fb_raw <- get_fb_slb(fxn = species, 
                            keep_cols = keep_cols, keep_fxn = contains,
                            drop_cols = '_ref',    drop_fxn = ends_with) %>%
  mutate(demers_pelag = tolower(demers_pelag))

table(dem_pel_fb_raw$demers_pelag)

depth_fb <- dem_pel_fb_raw %>%
  mutate(depth_fb = case_when(str_detect(demers_pelag, 'benthic') ~ 0,
                              str_detect(demers_pelag, 'sessile') ~ 0,
                              str_detect(demers_pelag, 'demersal') ~ 0,
                              str_detect(demers_pelag, 'reef') ~ 0.5, 
                                 ### assume reef spp are demersal? or more like benthopelagic?
                              str_detect(demers_pelag, 'benthopelagic') ~ .5,
                              str_detect(demers_pelag, 'pelagic') ~ 1,
                              TRUE ~ NA_real_)) %>%
  right_join(get_worms()) %>%
  gapfill_up_down('depth_fb')

### note the benthic/pelagic etc in the ecology table don't match up as well
  
```

## Compare depth trait for FishBase and vulnerability traits data

```{r}
check_df <- depth_vuln %>%
  select(-db, -spec_code) %>%
  full_join(depth_fb %>% rename(gf_level_fb = gf_level)) %>%
  filter(gf_level %in% c('match', 'genus', 'family'))

ggplot(check_df, aes(x = depth_vuln, y = depth_fb, color = gf_level)) +
  geom_jitter(alpha = .5) +
  geom_smooth(method = 'lm')

```

The match between directly-scored species in the vulnerability dataset (including downfill) is decent, but quickly drops off with even modest upstream-downstream gapfilling.  For species matched in the vulnerability dataset (including downfill) we will use those values; for all others, we will use the dataset matched closest to the species level, with tie going to the dataset with more species used to gapfill the value.

```{r}

ranks <- c('match', 'genus', 'family', 'order', 'class', 'unmatched')

depth_df <- depth_vuln %>%
  select(-db, -spec_code, gf_level_vuln = gf_level) %>%
  full_join(depth_fb %>% rename(gf_level_fb = gf_level)) %>%
  mutate(gf_vuln = factor(gf_level_vuln, levels = ranks) %>% as.integer(),
         gf_fb   = factor(gf_level_fb,   levels = ranks) %>% as.integer(),
         hi_nspp = ifelse(depth_vuln_nspp > depth_fb_nspp, depth_vuln, depth_fb),
         depth_score = case_when(gf_vuln == 1     ~ depth_vuln, ### if direct match, use it
                                 gf_fb < gf_vuln  ~ depth_fb,   ### if fb closer to match, use it
                                 gf_fb == 6 & gf_vuln == 6 ~ NA_real_,   ### if both unmatched, NA
                                 gf_vuln == gf_fb ~ hi_nspp,
                                 TRUE             ~ depth_vuln)) ### gf_vuln <= gf_fb < unmatched
# x <- depth_df %>% filter(depth_vuln != depth_fb)

water_col_df <- depth_df %>%
  full_join(terr_vuln %>%
              select(species, terr_score)) %>%
  full_join(vert_mig_vuln %>%
              select(species, vert_mig_score))

water_col_dropna <- water_col_df %>%
  mutate(tx = ifelse(phylum == 'chordata', class, phylum)) %>%
  select(tx, species, depth_score, terr_score, vert_mig_score) %>%
  drop_na()

cols <- c(brewer.pal(8, 'Dark2'), brewer.pal(8, 'Set3')) %>%
  setNames(water_col_dropna$tx %>% unique())

water_col_pca <- water_col_dropna %>%
  select(-tx, -species) %>%
  scale() %>%
  prcomp()

autoplot(water_col_pca,
         data = water_col_dropna,
         loadings = TRUE,
         colour = 'tx',
         loadings.label = TRUE,
         loadings.colour = "black",
         loadings.label.colour = "black",
         loadings.label.vjust = -0.5
         ) +
  scale_color_manual(values = cols) +
  theme_minimal()

# See the loadings (weighting for each principal component)
water_col_pca$rotation %>% round(3)

water_col_pca_out <- water_col_dropna %>%
  bind_cols(water_col_pca$x[, 1:2] %>% as.data.frame()) %>%
  select(-tx)
```

Keeping the first two components will capture 82% of the explained variation.  The first relates more heavily to water column position in the usual sense along with terrestrial/marine life stages; the second combines vertical migration score with terrestrial/marine life stages. 


## Write out results

Discard results for unmatched/filled species; also discard those filled at the class level, as that is stretching the numbers quite a bit farther than can probably be justified...

```{r}
results_df <- water_col_df %>%
  select(db, spec_code, species, depth_score, terr_score, vert_mig_score) %>%
  left_join(water_col_pca_out %>% select(species, depth_pc1 = PC1, depth_pc2 = PC2), by = 'species')

write_csv(results_df, here('_data/traits_grouping/trait_depth_pca.csv'))
```

