---
title: 'Collect reproductivity traits'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(oharac)
oharac::setup()
library(rfishbase)
library(ggfortify) ### for PCA plots
source(here('fb_slb_fxns.R'))

### used for joining and gapfilling
spp_from_worms <- get_worms()

```

# Summary

Gather data on reproductive traits from FishBase and the species vulnerability project: Max fecundity, generation time, parental care (pre-birth/hatch), parental dependence (post-birth/hatch), PLD.  Gapfill using downfill and upstream-downstream gapfill methodology.  Finally use PCA to reduce dimensionality across multiple traits, keeping the first two components.

NOTE: from https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1006907:

> On the other hand, if the mixed dataset contains a large number of categorical variables, multiple factor analysis (MFA) [31] can be used. The method applies PCA on numerical and MCA on categorical variables and combines the results by weighing variable groups.

# Data

This script will use processed valid species traits from the species vulnerability project, plus FishBase and SeaLifeBase.

FishBase is a scientific database, and this has the implication - among others - that its use and the use of its contents are free as long as due credit is given.

This may be done at different levels, for which we suggest different forms of citations:

* when referring to FishBase concepts and design, cite its architects (Froese and Pauly 2000);
* when referring to a set of values extracted from a FishBase table, cite the author(s) of the original data, e.g., "Houde and Zastrow (1993)", or "Welcomme (1988)". To help us track the use of FishBase in the literature, we would appreciate your also citing Froese and Pauly (2000) in an appropriate part of your text, as the source of the information;
* when discussing the features of a FishBase table, cite the section documenting that table, e.g., "Sa-a et al. (2000)."

## References

* Froese, R. and D. Pauly, Editors. 2000. FishBase 2000: concepts, design and data sources. ICLARM, Los Baños, Laguna, Philippines. 344 p.
* Houde, E.D. and C.E. Zastrow. 1993. Ecosystem- and taxon-specific dynamic energetics properties of fish larvae assemblages. Bull. Mar. Sci. 53(2):290-335.
* Sa-a, P., M.L. Palomares and D. Pauly. 2000. The FOOD ITEMS table, p. 182-188. In R. Froese and D. Pauly (eds.) FishBase 2000: concepts, design and data sources. ICLARM, Los Baños, Laguna, Philippines. 344 p.
* Welcomme, R.L. 1988. International introductions of inland aquatic species. FAO Fish. Tech. Pap. 294, 318 p.
* Butt, N. et al. 2021. 

# Methods

## Age at maturity: Read in data

Read in data from vulnerability project and fishbase/sealifebase.  First priority is to understand max age at maturity with data from species vulnerability trait data, which can achieve ~11000 spp.  FB/SLB have many NAs for these, but with a continuous value for age to maturity, we can use upstream/downstream gapfilling (to the order level) to plug in values for additional species not included in the vulnerability dataset.

### Vulnerability traits

```{r}
age_mat_vuln <- get_vuln_traits() %>%
  filter(trait == 'age_to_1st_reproduction_generation_time') %>%
  mutate(trait_value = factor(trait_value,
                              levels = c('<1yr', '1-5yrs', '5-10yrs', '10-20yrs', '>20yrs')),
         bin = as.integer(trait_value))

age_mat_vuln_gf <- downfill(age_mat_vuln) %>%
  select(species, trait, value = trait_value) %>%
  distinct() %>%
  mutate(source = 'vuln')
```

### Fishbase/Sealifebase

```{r}
fields <- c('age', 'tm')

mat_fb_raw <- get_fb_slb(rfishbase::maturity,
                       keep_cols = fields, keep_fxn = contains,
                       drop_cols = '_ref', drop_fxn = ends_with) %>%
  select(db, spec_code, species, tm, age_mat_min, age_mat_min2) %>%
  filter(!is.na(tm) | !is.na(age_mat_min) | !is.na(age_mat_min2))


lm_amm <- lm(age_mat_min ~ tm, data = mat_fb_raw); coef_amm <- lm_amm$coefficients[2]
# summary(lm_amm)
### slope = .76, p << .001, adj.R^2 = .67
lm_amm2 <- lm(age_mat_min2 ~ tm, data = mat_fb_raw); coef_amm2 <- lm_amm2$coefficients[2]
# summary(lm_amm2)
### slope = 1.43, p << .001, adj.R^2 = .80

mat_fb <- mat_fb_raw %>%
  mutate(t_maturity = case_when(!is.na(tm) ~ tm,
                                !is.na(age_mat_min2) ~ age_mat_min2 / coef_amm2,
                                TRUE ~ age_mat_min / coef_amm)) %>%
  select(db, spec_code, species, t_maturity) %>%
  group_by(db, spec_code, species) %>%
  summarize(age_mat = mean(t_maturity), .groups = 'drop')

mat_fb_gf <- mat_fb %>%
  right_join(get_worms()) %>%
  gapfill_up_down('age_mat') %>%
  filter(!is.na(value)) %>%
  filter(gf_level <= 4)

summary(mat_fb_gf$value)

mat_fb_binned <- mat_fb_gf %>%
  mutate(val_bin = case_when(value <   1 ~ '<1yr',
                             value <=  5 ~ '1-5yrs',
                             value <= 10 ~ '5-10yrs',
                             value <= 20 ~ '10-20yrs',
                             value >  20 ~ '>20yrs',
                             TRUE ~ 'oops')) %>%
  filter(!species %in% age_mat_vuln_gf$species) %>%
  select(species, trait, val_num = value, value = val_bin, sd, nspp, gf_level) %>%
  distinct() %>%
  mutate(source = 'fb')

age_mat_all_gf <- bind_rows(age_mat_vuln_gf, mat_fb_binned) %>%
  mutate(trait = 'age_mat')

age_mat_all_gf$value %>% table()
```

Without gapfilling, we get `r mat_fb$species %>% n_distinct()`  distinct species, at least some of which are freshwater.  With gapfilling to order level, we get ~75k species (and 22k if we stick with class level).  Combining FB traits and Vuln traits, we get ~92000 distinct species (fb species in the vuln dataset are dropped).


## Fecundity

Read in data from vulnerability project and fishbase/sealifebase.  Examine potential for variables to be used to gapfill for max fecundity.  

```{r}
f_vals <- c('<1', '1-2' , '2-5', '5-10', '10-20', '20-50', '50-100', '100-1000', '1000-10000', '>10000')      

fecund_vuln <- get_vuln_traits() %>%
  filter(trait == 'fecundity') %>%
  mutate(trait_value = factor(trait_value,
                              levels = f_vals),
         bin = as.integer(trait_value))

fecund_vuln_gf <- downfill(fecund_vuln) %>%
  select(species, trait, value = trait_value) %>%
  distinct()
```


```{r}
fields <- c('fecun')
fecund_fb_raw <- get_fb_slb(fxn = fecundity,
                     keep_cols = fields, keep_fxn = contains,
                     drop_cols = '_ref', drop_fxn = ends_with) %>%
  select(db, spec_code, species, starts_with('fecun'))
# summary(fecund_df_raw)
# fecund_df_raw %>% summarize(across(starts_with('fecun'), .fns = ~sum(!is.na(.x))))

lm_fec1 <- lm(fecundity_max ~ fecundity_min, data = fecund_fb_raw); coef_fec1 <- lm_fec1$coefficients[2]
# summary(lm_fec1)
### slope = 2.92, p << .001, adj.R^2 = .83
lm_fec2 <- lm(fecundity_max ~ fecundity_mean, data = fecund_fb_raw); coef_fec2 <- lm_fec2$coefficients[2]
# summary(lm_fec2)
### slope = 1.15, p << .001, adj.R^2 = .95

fecund_fb <- fecund_fb_raw %>%
  mutate(max_fecundity = case_when(!is.na(fecundity_max) ~ fecundity_max,
                             !is.na(fecundity_mean) ~ fecundity_mean * coef_fec2,
                             !is.na(fecundity_min) ~ fecundity_min * coef_fec1,
                             TRUE ~ NA_real_)) %>%
  select(db, spec_code, species, max_fecundity) %>%
  group_by(db, spec_code, species) %>%
  summarize(max_fecundity = mean(max_fecundity), .groups = 'drop') %>%
  filter(!is.na(max_fecundity))

fecund_fb_gf <- fecund_fb %>%
  right_join(get_worms()) %>%
  mutate(log_fec = log10(max_fecundity)) %>%
  gapfill_up_down('log_fec') %>%
  mutate(value = 10^value) %>%
  filter(!is.na(value)) %>%
  filter(gf_level <= 4)

summary(fecund_fb_gf$value)

fecund_fb_binned <- fecund_fb_gf %>%
  mutate(val_bin = case_when(value <   1 ~ '<1',
                             value <=  2 ~ '1-2',
                             value <=  5 ~ '2-5',
                             value <= 10 ~ '5-10',
                             value <= 20 ~ '10-20',
                             value <= 50 ~ '20-50',
                             value <= 100 ~ '50-100',
                             value <= 1000 ~ '100-1000',
                             value <= 10000 ~ '1000-10000',
                             value >  10000 ~ '>10000',
                             TRUE ~ 'oops')) %>%
  filter(!species %in% fecund_vuln_gf$species) %>%
  select(species, trait, val_num = value, value = val_bin, sd, nspp, gf_level) %>%
  distinct() %>%
  mutate(source = 'fb')

fecund_all_gf <- bind_rows(fecund_vuln_gf, fecund_fb_binned) %>%
  mutate(trait = 'fec') %>%
  mutate(value = factor(value, levels = f_vals))

fecund_all_gf$value %>% table()
```

Min and max both have >2400 observations; mean has 133.

From FishBase/SeaLifeBase we get only `r `fecund_fb %>% filter(!is.na(max_fecundity)) %>% n_distinct(.$species)` distinct species, guessing some of which are freshwater.  Instead use vulnerability data, again, already binned.



## Parental investment

Read in data from vulnerability project and fishbase/sealifebase.  Here we have data on parental investment (maternal/paternal/both/neither) and protection mode (bearers/guarders/non-guarders).  Assign protection mode from bearers (high) to non-guarders (low).  Because the parental investment score here only covers FishBase, and is not comparable to that in the vulnerability traits data (which is closer to the protection trait), let's skip it in favor of the post-birth dependence trait in the vulnerability traits data.

```{r}
fields <- c('parental', 'guild')

reprod_df_raw <- get_fb_slb(fxn = reproduction,
                     keep_cols = fields, keep_fxn = contains,
                     drop_cols = '_ref', drop_fxn = ends_with)
# summary(reprod_df_raw)

# x <- reprod_df_raw %>% filter(!is.na(rep_guild1) | !is.na(parental_care))

# parent_df <- reprod_df_raw %>%
#   mutate(parental_score = case_when(parental_care == 'none' ~ 0,
#                                   str_detect(parental_care, 'aternal') ~ 1,
#                                   parental_care == 'biparental' ~ 2)) %>%
#   select(db, spec_code, species, parental_score) %>%
#   group_by(db, spec_code, species) %>%
#   summarize(parental_score = mean(parental_score), .groups = 'drop') %>%
#   right_join(spp_from_worms, by = 'species')
# 
# parent_df %>% filter(!is.na(parental_score)) %>% select(db, parental_score) %>% table()

protect_df <- reprod_df_raw %>%
  mutate(rep_guild1 = factor(rep_guild1, levels = c('nonguarders', 'guarders', 'bearers')),
         protect_score = as.integer(rep_guild1)) %>%
  select(db, spec_code, species, protect_score) %>%
  group_by(db, spec_code, species) %>%
  summarize(protect_score = mean(protect_score), .groups = 'drop') %>%
  right_join(spp_from_worms, by = 'species')

protect_df %>% filter(!is.na(protect_score)) %>% select(db, protect_score) %>% table()

```

For parental investment: We get 5042 distinct species, all of which are from FishBase, guessing some of which are freshwater.  For protection mode, we get 21890 species across both FB and SLB.

For the vulnerability data, parental investment is based on: (egg-layer unattended, egg-layer, live birth/egg care, spawner) - which seems comparable to protection mode above.  Post-birth/hatching parental dependence is a time scale: less than a week up to more than a year.

```{r}
parent_vuln <- get_vuln_traits() %>%
  filter(str_detect(trait, 'parental_investment')) %>%
  mutate(parent_score = case_when(str_detect(trait_value, 'spawn|unattend') ~ 0,
                                trait_value == 'egg-layer' ~ 1,
                                trait_value == 'live birth/egg care' ~ 2))

parent_vuln_gf <- downfill(parent_vuln) %>%
  select(species, trait, value = trait_value) %>%
  mutate(trait = 'par_inv') %>%
  distinct()

depend_vuln <- get_vuln_traits() %>%
  filter(trait == 'post_birth_hatching_parental_dependence') %>%
  mutate(trait_value = factor(trait_value, levels = c('na', '<week', 'week-month', 'month-year', '>year')),
         depend_score = as.double(trait_value) - 1)
           ### so "na" is 0 dependence, i.e., no post-birth care

depend_vuln_gf <- downfill(depend_vuln) %>%
  select(species, trait, value = trait_value) %>%
  mutate(trait = 'par_dep') %>%
  distinct()
```


## Planktonic larval duration

From the vulnerability traits, we can identify PLD as a potential variable for discerning functional groups.

```{r}
pld_vals <- c('not larvae', '<1day', '<1week', '<1month', '<4months', '4months-1yr', '>1yr')

pld_vuln <- get_vuln_traits() %>%
  filter(str_detect(trait, 'planktonic_larval_duration')) %>%
  mutate(trait_value = factor(trait_value, levels = pld_vals))

pld_vuln_downfill <- downfill(pld_vuln)

pld_vuln_gf <- pld_vuln_downfill %>%
  select(species, trait, value = trait_value) %>%
  mutate(trait = 'pld') %>%
  distinct()

```

### Combine data into a single dataframe and save

Write out the results.  In this case, no gapfilling (all down-filling).  Some species might have multiple values of a trait so this must be addressed eventually.

```{r}

repr_out_df <- bind_rows(age_mat_all_gf,
                         fecund_all_gf,
                         depend_vuln_gf,
                         parent_vuln_gf,
                         pld_vuln_gf) %>%
  arrange(trait, sd) ### to make sure non-NA values up front for read_csv

write_csv(repr_out_df, here('_data/traits_grouping/trait_reproduction.csv'))

# repr_pc1_df <- repr_out_df %>%
#   mutate(trait = 'repr_pc1') %>%
#   select(species, gf_level, trait, value = repr_pc1)
# write_csv(repr_pc1_df, here('_data/traits_grouping/trait_repr_pc1.csv'))
# repr_pc2_df <- repr_out_df %>%
#   mutate(trait = 'repr_pc2') %>%
#   select(species, gf_level, trait, value = repr_pc2)
# write_csv(repr_pc2_df, here('_data/traits_grouping/trait_repr_pc2.csv'))

```

