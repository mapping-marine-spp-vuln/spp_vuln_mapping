---
title: "Map vulnerability"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
library(oharac)
oharac::setup()
source(here('common_fxns.R'))

```

# Summary

Apply vulnerability scores to AquaMaps species.  Map out vulnerability to each stressor, first unweighted by species (each spp counts same), then unweighted by functional entity (each functional entity counts same), then weighted by functional vulnerability (FEs with higher FV are given greater weight).

# Data

* AquaMaps
* Vulnerability Framework
* FishBase/SeaLifeBase

# Methods

## Unweighted, by species

Read in AquaMaps maps and vulnerability scores.  Iterating over each stressor, calculate cell-by-cell mean, standard deviation.

To be determined: 

* filter out low-occurrence species?
* preferred threshold?

```{r read in aquamaps and vuln data}

occurcells_thresh  <- 0
am_presence_thresh <- 0
am_spp_ids <- get_am_spp_info() %>%
  filter(occur_cells >= occurcells_thresh) %>%
  ### filter to spp with enough occurrences?
  select(am_sid, sciname) %>%
  distinct()

spp_vuln <- get_spp_vuln(gapfill = 'all')

am_vuln <- spp_vuln %>%
  select(species, stressor, score) %>%
  filter(!is.na(score)) %>%
  distinct() %>%
  inner_join(am_spp_ids, by = c('species' = 'sciname'))

excl <- get_am_spp_info() %>%
  filter(occur_cells >= occurcells_thresh) %>%
  filter(!sciname %in% spp_vuln$species)
### 2720 missing when vulnerability gapfilled to class; 
### 6971 missing when gapfilled to order;
### 13241 missing when gapfilled to family...

table(excl$class)

am_spp_cells <- get_am_spp_cells(occurcells_cut = occurcells_thresh,
                                 prob_cut = am_presence_thresh)

```

#### Inclusion of species: vuln X am

When applying vulnerability scores at the species level, inclusion depends on species being accounted for both in AquaMaps and the vulnerability project.  In this case, the number of included species is `r am_vuln$species %>% n_distinct()`.

```{r vuln by species iterating over stressors}

strs <- spp_vuln$stressor %>% unique() %>% sort()

out_stem <- here('_output/vuln_by_spp/vuln_by_spp_%s_%s.tif')
### unlink(list.files(here('_output/vuln_by_spp'), full.names = TRUE))

for(s in strs) {
  ### s <- strs[2]
  if(file.exists(sprintf(out_stem, s, 'mean')) &
     file.exists(sprintf(out_stem, s, 'sd'))) {
    message('Rasters exist for stressor ', s, '... skipping!')
    next()
  }
  message('processing mean/sd vulnerability by species to stressor: ', s)
  am_vuln_str <- am_vuln %>%
    filter(stressor == s)
  am_spp_vuln_cells <- am_spp_cells %>%
    oharac::dt_join(am_vuln_str, by = 'am_sid', type = 'inner')
  
  result_df <- am_spp_vuln_cells %>%
    filter(!is.na(score)) %>%
    group_by(loiczid) %>%
    summarize(score_mean = mean(score) %>% round(5),
              score_sd   = sd(score) %>% round(5),
              .groups = 'drop')
  
  rast_mean <- map_to_hcaf(result_df, which = 'score_mean')
  rast_sd   <- map_to_hcaf(result_df, which = 'score_sd')
  

  writeRaster(rast_mean, sprintf(out_stem, s, 'mean'), overwrite = TRUE)
  writeRaster(rast_sd,   sprintf(out_stem, s, 'sd'), overwrite = TRUE)
}
```

```{r plot vuln by species by stressor}
focal_strs <- c('biomass', 'bycatch', 'plastic', 
                'nutrient', 'oa', 'water_temp',
                'light', 'noise', 'organic') %>%
  paste0(collapse = '|')
mean_fs <- list.files(here('_output/vuln_by_spp'), pattern = 'mean', full.names = TRUE)
# sd_fs   <- list.files(here('_output/vuln_by_spp'), pattern = 'sd', full.names = TRUE)

mean_fs <- mean_fs[str_detect(basename(mean_fs), focal_strs)]

mean_stack <- raster::stack(mean_fs) %>%
  setNames(str_remove(names(.), 'vuln_by_spp_'))
# sd_stack   <- raster::stack(sd_fs) %>%
#   setNames(str_remove(names(.), 'vuln_by_spp_'))

plot(mean_stack, zlim = c(0, 1), legend = TRUE, axes = FALSE)
# plot(sd_stack,   zlim = c(0, 1), legend = FALSE, axes = FALSE)
```

### By FE, unweighted

```{r vuln by FE iterating over stressors}

strs <- spp_vuln$stressor %>% unique() %>% sort()

out_stem <- here('_output/vuln_by_fe/vuln_by_fe_%s_%s.tif')
### unlink(list.files(here('_output/vuln_by_fe'), full.names = TRUE))

fe_df <- read_csv(here('_output/func_entities/species_fe.csv'))

am_vuln_fe <- am_vuln %>%
  oharac::dt_join(fe_df, by = 'species', type = 'inner') %>%
  select(am_sid, fe_id, stressor, score) %>%
  distinct()
  
for(s in strs) {
  ### s <- strs[1]
  if(file.exists(sprintf(out_stem, s, 'mean')) &
     file.exists(sprintf(out_stem, s, 'sd'))) {
    message('Rasters exist for stressor ', s, '... skipping!')
    next()
  }
  message('processing mean/sd vulnerability by species to stressor: ', s)
  am_vuln_str <- am_vuln_fe %>%
    filter(stressor == s)
  am_spp_vuln_cells <- am_spp_cells %>%
    oharac::dt_join(am_vuln_str, by = 'am_sid', type = 'inner')
  message('summarizing by FE in each cell...')
  result_df <- am_spp_vuln_cells %>%
    filter(!is.na(score)) %>%
    group_by(loiczid, fe_id) %>%
    ### first, summarize by FE per cell...
    summarize(score_mean1 = mean(score),
              # score_sd   = sd(score),
              .groups = 'drop')
  
  message('...then summarizing across all FEs in each cell...')
  result_df <- result_df %>%
    group_by(loiczid) %>%
    ### ... then average across all FEs
    summarize(score_mean = mean(score_mean1),
              # score_sd   = sqrt(sum(score_sd^2, na.rm = TRUE) / n()),
              # score_sd   = sd(score_mean1), ### this is deviation of mean among FEs
              .groups = 'drop')
    
  rast_mean <- map_to_hcaf(result_df, which = 'score_mean')
  # rast_sd   <- map_to_hcaf(result_df, which = 'score_sd')

  writeRaster(rast_mean, sprintf(out_stem, s, 'mean'), overwrite = TRUE)
  # writeRaster(rast_sd,   sprintf(out_stem, s, 'sd'), overwrite = TRUE)
}
```

#### Inclusion of species: vuln X am X fe

When applying vulnerability scores at the functional entity level, species must be accounted for in AquaMaps, vulnerability scores, and functional entity traits.  In this case, the number of included species is `r am_vuln_fe$am_sid %>% n_distinct()`.  Looking at the intersection of AquaMaps and functional traits only, we include `r fe_df %>% filter(species %in% am_spp_ids$sciname) %>% .$species %>% n_distinct()`.

```{r plot vuln by FE by stressor}
mean_fs <- list.files(here('_output/vuln_by_fe'), pattern = 'mean', full.names = TRUE)
# sd_fs   <- list.files(here('_output/vuln_by_fe'), pattern = 'sd', full.names = TRUE)

mean_fs <- mean_fs[str_detect(basename(mean_fs), focal_strs)]

mean_stack <- raster::stack(mean_fs) %>%
  setNames(str_remove(names(.), 'vuln_by_fe_'))
# sd_stack   <- raster::stack(sd_fs) %>%
#   setNames(str_remove(names(.), 'vuln_by_fe_'))

plot(mean_stack, zlim = c(0, 1), legend = TRUE, axes = FALSE)
# plot(sd_stack,   zlim = c(0, 1), legend = FALSE, axes = FALSE)
```

### By FE, FV-weighted

Here, calculate mean stressor vulnerability for each functional entity, along with the functional vulnerability of each entity using $\left(\frac{1}{2}\right)^{n-1}$ (so for an FE represented by one species, functional vuln = $\left(\frac{1}{2}\right)^{0}$ 1; for an FE represented by 5 spp, $\left(\frac{1}{2}\right)^{4}$ = .0625; for an FE represented by 10 spp, $\left(\frac{1}{2}\right)^{9}$ = .002 etc).

```{r weighted vuln by FE iterating over stressors}

strs <- spp_vuln$stressor %>% unique() %>% sort()

message('Calculating functional vulnerability by FE and cell...')
am_spp_cells_fv <- am_spp_cells %>%
  oharac::dt_join(am_vuln_fe %>% 
                    select(am_sid, fe_id) %>% distinct(), 
                  by = 'am_sid', type = 'inner') %>%
  group_by(loiczid, fe_id) %>%
  mutate(nspp_fe = n(), ### only one observation per am_sid per cell
         fv = 0.5^(nspp_fe - 1)) %>%
  ungroup()

out_stem <- here('_output/vuln_by_fe_weighted/vuln_wt_by_fe_%s_%s.tif')

### unlink(list.files(here('_output/vuln_by_fe_weighted'), full.names = TRUE))

for(s in strs) {
  ### s <- strs[2]
  if(file.exists(sprintf(out_stem, s, 'mean')) &
     file.exists(sprintf(out_stem, s, 'sd'))) {
    message('Rasters exist for stressor ', s, '... skipping!')
    next()
  }
  message('processing mean/sd vulnerability by species to stressor: ', s)
  am_vuln_str <- am_vuln_fe %>%
    filter(stressor == s) %>%
    select(-fe_id) %>%
    distinct()
  am_spp_vuln_cells <- am_spp_cells_fv %>%
    oharac::dt_join(am_vuln_str, by = c('am_sid'), type = 'inner')
  
  message('summarizing by FE in each cell...')
  result_df <- am_spp_vuln_cells %>%
    filter(!is.na(score)) %>%
    group_by(loiczid, fe_id, fv, nspp_fe) %>%
    ### first, summarize by FE per cell...
    summarize(score_mean1 = mean(score),
              # score_sd   = sd(score),
              .groups = 'drop')
  
  message('...then summarizing weighted mean across all FEs in each cell...')
  result_df <- result_df %>%
    group_by(loiczid) %>%
    ### ... then average across all FEs
    summarize(score_mean = Hmisc::wtd.mean(score_mean1, weights = fv),
              # score_sd   = sqrt(sum(score_sd^2 * fv, na.rm = TRUE) / sum(fv)),
              # score_sd   = sqrt(Hmisc::wtd.var(score_mean1, weights = fv)),
                ### weighted std dev among mean scores for each FE
              n_spp      = sum(nspp_fe),
              .groups = 'drop')
    
  rast_mean <- map_to_hcaf(result_df, which = 'score_mean')
  # rast_sd   <- map_to_hcaf(result_df, which = 'score_sd')

  writeRaster(rast_mean, sprintf(out_stem, s, 'mean'), overwrite = TRUE)
  # writeRaster(rast_sd,   sprintf(out_stem, s, 'sd'), overwrite = TRUE)
}
```

```{r plot weighted vuln by FE by stressor}
mean_fs <- list.files(here('_output/vuln_wt_by_fe'), pattern = 'mean', full.names = TRUE)
# sd_fs   <- list.files(here('_output/vuln_wt_by_fe'), pattern = 'sd', full.names = TRUE)

mean_fs <- mean_fs[str_detect(basename(mean_fs), focal_strs)]

mean_stack <- raster::stack(mean_fs) %>%
  setNames(str_remove(names(.), 'vuln_wt_by_fe_'))
# sd_stack   <- raster::stack(sd_fs) %>%
#   setNames(str_remove(names(.), 'vuln_wt_by_fe_'))

plot(mean_stack, zlim = c(0, 1), legend = TRUE, axes = FALSE)
# plot(sd_stack,   zlim = c(0, 1), legend = FALSE, axes = FALSE)
```