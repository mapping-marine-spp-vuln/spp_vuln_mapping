---
title: "prepare Fig SI for manuscript - trait missingness for functional entity assignment"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 4, fig.width = 7)

library(oharac)
library(tidyverse)
library(here)
library(cowplot)
source(here('common_fxns.R'))

```

# Summary

Prep table for supplement

# Methods

Load in trait info, crop to just those in the analysis, and report out missingness.

```{r load stuff}
wcol_levels <- c('rf', 'pel', 'ben', 'bp') ### not ordered
mob_levels  <- c('ses', 'sed', 'mob', 'mig') ### in order from least to most mobile

### write out traits pre-imputation for reference
traits_premice_all <- read_csv(here_anx('mice/gp_traits_mice_preimputation.csv')) %>%
  mutate(wcol      = factor(wcol,      levels = wcol_levels, ordered = FALSE),
         adult_mob = factor(adult_mob, levels = mob_levels, ordered = TRUE))

worms_df <- assemble_worms() %>%
  mutate(class = case_when(class == 'actinopterygii' & order == 'acipenseriformes' ~ 'chondrostei',
                           class == 'actinopterygii' ~ 'teleostei',
                           TRUE ~ class))

all_spp_info <- assemble_spp_info_df()

iucn_sciname_to_id <- all_spp_info %>%
  select(sciname = species, iucn_sid) %>%
  distinct() %>%
  filter(!is.na(iucn_sid))
spp_df <- read_csv(here('5_ms_figs/int/fig1_spp_summary.csv')) %>%
  select(species, iucn_sid) %>%
  distinct() %>%
  left_join(iucn_sciname_to_id, by = 'iucn_sid') %>%
  mutate(species = ifelse(is.na(species), sciname, species)) %>%
  select(-sciname) %>%
  left_join(worms_df, by = 'species') %>%
  unique()

```



```{r}
traits_premice_incl <- traits_premice_all %>%
  filter(species %in% spp_df$species) 

traits_pm_incl_sum <- traits_premice_incl %>%
  group_by(species) %>%
  summarize(across(.cols = everything(), .fns = ~ any(!is.na(.x)))) %>%
  mutate(across(.cols = -species, .fns = ~ ifelse(!.x, NA, .x)))

traits_pm_missingness <- traits_pm_incl_sum %>%
  group_by(log_l, troph, wcol, adult_mob) %>%
  summarize(n = n())
```

Check counts of observations with different numbers of NAs.  Most rows have two or fewer NAs. Check missingness pattern using `mice::md.pattern`.  

``` {r, fig.width = 6}
mice::md.pattern(traits_pm_incl_sum %>% select(-species, -age_mat, -log_f))
```

To visualize, create a heat map like md.pattern, but for the age_mat and log_f shade according to missingness for the combo of other missingness...

```{r prep panel a}
plot_df <- traits_pm_incl_sum %>%
  mutate(across(-species, .fns = ~ ifelse(is.na(.x), 1, 0))) %>%
  group_by(adult_mob, troph, log_l, wcol) %>%
  summarize(n = n(), log_f = mean(log_f), age_mat = mean(age_mat), .groups = 'drop') %>%
  arrange(wcol, log_l, troph, adult_mob) %>%
  mutate(n = as.character(n) %>% fct_inorder() %>% fct_rev()) %>%
  pivot_longer(-n, names_to = 'var', values_to = 'val') %>%
  mutate(var = factor(var, levels = c('wcol', 'log_l', 'troph', 'adult_mob', 'log_f', 'age_mat')))

plot_df2 <- plot_df %>%
  filter(var %in% c('log_l', 'troph', 'adult_mob', 'wcol'))
```

```{r generate panel a}
fill_clrs <- hcl.colors(2, palette = 'Viridis')

### purple, yellow Viridis pattern
p1 <- ggplot(plot_df, aes(x = var, y = n)) +
  geom_tile(aes(fill = val), color = 'white', size = 2) +
  ### overplot non-missing
  geom_tile(data = plot_df2 %>% filter(val == 0), 
            fill = fill_clrs[1], color = 'white', size = 2) +
  ### overplot missing
  geom_tile(data = plot_df2 %>% filter(val == 1), 
            fill = fill_clrs[2], color = 'white', size = 2) +
  ### outline and scale for MICE-only variables
  # geom_tile(data = plot_df %>% filter(var %in% c('age_mat', 'log_f')),
  #           fill = NA, color = 'red', size = .5) +
  geom_rect(xmin = 4.5, xmax = 6.5, ymin = 0.5, ymax = 10.5, color = 'red', fill = NA, linewidth = .1) +
  scale_fill_viridis_c(limits = c(0, 1)) +
  coord_fixed() +
  theme_ohara(base_size = 8) +
  theme(legend.title = element_text(angle = 90, face = 'bold', vjust = .77),
        axis.title   = element_text(face = 'bold'),
        axis.text.x  = element_text(angle = 90, hjust = 1, vjust = .5)) +
  labs(x = 'Variable', y = 'Number of species', 
       fill = 'Missingness')
# p1
```

After MICE, values gapfilled at genus then family level for spp not in MICE analysis.

## Gapfilling by class

```{r prep data for panel b}
post_gf <- read_csv(here('_data/grouping_traits_miced_and_gapfilled.csv')) %>%
  filter(species %in% spp_df$species) %>%
  left_join(worms_df, by = 'species') %>%
  mutate(class = str_to_title(class))

cls_levels <- post_gf %>%
  mutate(chrd = phylum == 'chordata') %>%
  group_by(class, chrd) %>%
  summarize(n_cls = n_distinct(species)) %>%
  arrange(chrd, n_cls) %>%
  pull(class)


gf_level_summary <- post_gf %>%
  group_by(class) %>%
  mutate(n_cls = n_distinct(species)) %>%
  group_by(class, gf_rank) %>%
  summarize(chrd = first(phylum) == 'chordata',
            n_cls = first(n_cls),
            n_gf_cls = n_distinct(species),
            pct_gf_cls = n_gf_cls / n_cls) %>%
  mutate(gf_rank = factor(gf_rank, levels = c('none', 'genus', 'family'))) %>%
  mutate(class = factor(class, levels = cls_levels)) 

```

```{r generate panel b}

n_lbls <- gf_level_summary %>%
  select(class, n_cls) %>%
  distinct() %>%
  mutate(n_lbl = paste0('n = ', n_cls))
  
p2 <- ggplot(gf_level_summary, aes(x = gf_rank, y = class)) +
  geom_tile(aes(fill = pct_gf_cls), color = 'white', size = 2) +
  geom_segment(x = 0.5, xend = 0.5, y = 13.5, yend = 20.5, color = 'grey30') +
  geom_segment(x = 3.5, xend = 3.5, y = 13.5, yend = 20.5, color = 'grey30') +
  scale_fill_viridis_c(breaks = c(0, .25, .50, .75, 1),
                       limits = c(0, 1),
                       labels = c('0%', '25%', '50%', '75%', '100%')) +
  geom_text(data = n_lbls, aes(label = n_lbl), 
            family = 'Helvetica', x = 3.6, hjust = 0, size = 2) +
  scale_x_discrete(limits = c('none', 'genus', 'family', '', '')) +
  coord_fixed() +
  theme_ohara(base_size = 8) +
  theme(panel.grid.major = element_blank(),
        axis.title   = element_text(face = 'bold'),
        axis.text.x  = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.title = element_text(angle = 90, face = 'bold', vjust = 1)) +
  labs(x = 'Gapfill level', y = 'Class', 
       fill = 'Percent of species\nin class/order')

# p2
```

### combine into compound figure
```{r}

pnl_a <- p1 + theme(legend.position = 'none')
lgd_a <- get_legend(p1)
pnl_b <- p2 + theme(legend.position = 'none')
lgd_b <- get_legend(p2)
```

```{r}
wvec <- c(a = .48, a_l = .10, b = .33, b_l = .10)
xvec <- c(a = 0.0, a_l = 0.46, b = .60, b_l = 0.9)

p <- ggdraw() +
  draw_plot(pnl_a, x = xvec[1], y = 0, width = wvec[1], height = 1) +
  draw_plot(lgd_a, x = xvec[2], y = 0, width = wvec[2], height = 1) +
  draw_plot(pnl_b, x = xvec[3], y = 0, width = wvec[3], height = 1) +
  draw_plot(lgd_b, x = xvec[4], y = 0, width = wvec[4], height = 1) +
  draw_label('A.', x = xvec[1], y = 1,  hjust = 0, vjust = 1, 
             size = 9, fontfamily = 'Helvetica', fontface = 'bold') +
  draw_label('B.', x = xvec[3], y = 1,  hjust = 0, vjust = 1, 
             size = 9, fontfamily = 'Helvetica', fontface = 'bold')
  
  

fig_f <- here('5_ms_figs/figS5_trait_imputation.png')
ggsave(fig_f, width = 6.5, height = 5)

knitr::include_graphics(fig_f)
```

