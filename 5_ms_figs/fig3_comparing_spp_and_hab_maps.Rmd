---
title: "Figure 3: Comparing spp/FE and habitat impacts"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 4, fig.width = 7)

library(terra)
library(sf)
library(oharac)
library(data.table)
library(tidyverse)
library(biscale)  ### for bivariate legend
library(cowplot)
library(showtext) ### for custom fonts
library(here)
source(here('common_fxns.R'))

font_add(family = 'bentonbold', 
         regular = file.path('~/fonts', 
                             'BentonSans Condensed Bold', 
                             'BentonSans Condensed Bold.otf'))
font_add(family = 'benton', 
         regular = file.path('~/fonts', 
                             'BentonSans Condensed Book', 
                             'BentonSans Condensed Book.otf'))
showtext_auto()
```

# Summary

Create Fig. 3(?) for manuscript

# Data

Results from scripts in folder `2_process_spp_vuln_and_impacts` and `3_process_hab_vuln_and_impacts`

# Methods

Read in the output rasters for species-level impacts (unweighted); reclassify based on quartile/quintile.  Fig. 1A is bivariate plot of climate vs. non-climate stressors for equal weighted species average, Fig. 1B is bivariate plot of climate vs. non-climate stressors for FV-weighted FE average; Fig. 1C and 1D are %difference plots for each category.

NOTE: dropping cells with fewer than 20 species, mostly in the Arctic, a few in Antarctic.

```{r}
ocean_map <- rast(here('_spatial/ocean_area_mol.tif'))
ocean_df <- as.data.frame(ocean_map, xy = TRUE)

land_sf <- read_sf(here('_spatial/ne_10m_land/ne_10m_land_no_casp.shp')) %>%
  st_transform(st_crs(ocean_map))

nspp_mask <- rast(here('_output/nspp_maps/species_richness.tif'))
nspp_vals <- values(nspp_mask)
values(nspp_mask)[nspp_vals < 20] <- NA

chi_gps_hab <- list.files(here('_output/cumulative_impact_maps'),
                         pattern = 'habitat_group_chi',
                         full.names = TRUE)
chi_gps_fe <- list.files(here('_output/cumulative_impact_maps'),
                         pattern = 'funct_entity_group_chi',
                         full.names = TRUE)
climate_map_hab <- rast(chi_gps_hab[1]) %>%
  mask(nspp_mask)
climate_map_fe <- rast(chi_gps_fe[1]) %>%
  mask(nspp_mask)

nonclimate_map_hab <- rast(chi_gps_hab[2:4]) %>%
  sum(na.rm = TRUE) %>%
  mask(nspp_mask)

nonclimate_map_fe  <- rast(chi_gps_fe[2:4]) %>%
  sum(na.rm = TRUE) %>%
  mask(nspp_mask)
```

### Reclassify

Reclassify values using `ntile` to get quartile values:
```{r reclass eq weight}
cc_qtile_hab <- noncc_qtile_hab <- climate_map_hab ### initialize two new maps
values(cc_qtile_hab) <- ntile(values(climate_map_hab), 4)
values(noncc_qtile_hab) <- ntile(values(nonclimate_map_hab), 4)
# plot(cc_qtile_hab, axes = FALSE, 
#      main = 'Climate impact quintile, habitat avg', col = hcl.colors(4))
# plot(noncc_qtile_hab, axes = FALSE, 
#      main = 'Non-climate impact quintile, habitat avg', col = hcl.colors(4))
```

```{r reclass fv weight}
cc_qtile_fe <- noncc_qtile_fe <- climate_map_fe ### initialize two new maps
values(cc_qtile_fe) <- ntile(values(climate_map_fe), 4)
values(noncc_qtile_fe) <- ntile(values(nonclimate_map_fe), 4)
# plot(cc_qtile_fe, axes = FALSE, 
#      main = 'Climate impact quintile, fv wt avg', col = hcl.colors(4))
# plot(noncc_qtile_fe, axes = FALSE, 
#      main = 'Non-climate impact quintile, fv wt avg', col = hcl.colors(4))
```

## Create panels

### Set up palettes

For the bivariate color plot, one axis of colors represents climate, the other represents non-climate; pull these values from the bivariate palette to use for the climate and non-climate maps separately.

```{r}
# x <- c("Bluegill", "BlueGold", "BlueOr", "BlueYl",
#        "Brown2", "DkBlue2", "DkCyan2",
#        "DkViolet2", "GrPink2", "PinkGrn",
#        "PurpleGrn", "PurpleOr")
# bi_pal(x[8], dim = 4, preview = TRUE)

pal_name <- 'PinkGrn'
# zxcv <- biscale:::bi_pal_pull(pal = pal_name, dim = 4, flip_axes = FALSE, rotate_pal = FALSE)

pal_raw <- biscale:::bi_pal_pull(pal = pal_name, dim = 4, 
                                 flip_axes = FALSE, rotate_pal = FALSE)
colors_df <- data.frame(bi_class = names(pal_raw),
                        bi_fill  = pal_raw) %>%
  separate(bi_class, into = c('x', 'y'), sep = '-', remove = FALSE) %>%
  mutate(x = as.integer(x), y = as.integer(y)) %>%
  mutate(bi_fill = case_when(bi_class %in% c('1-4', '4-1', '4-4') ~ bi_fill,
                             bi_class %in% c('1-2', '1-3', '2-1', '3-1') ~ '#eeeeff',
                             bi_class %in% c('2-2', '2-3', '3-2', '3-3') ~ '#ddddee',
                             bi_class %in% c('4-2', '4-3', '2-4', '3-4') ~ '#ccccdd',
                             bi_class == '1-1' ~ '#ffffbb', ### pale yellow
                             TRUE ~ 'blue'))

```


### Panel A: habitat average bivariate plot

Use a four-level bivariate color scale to capture spatial overlap of quartiles for climate and non-climate stressors.

```{r panel A}
cc_hab_df <- as.data.frame(cc_qtile_hab, xy = TRUE) %>%
  setNames(c('x', 'y', 'cc_hab'))
noncc_hab_df <- as.data.frame(noncc_qtile_hab, xy = TRUE) %>%
  setNames(c('x', 'y', 'noncc_hab'))

cc_noncc_hab_df <- dt_join(cc_hab_df, noncc_hab_df, by = c('x', 'y'), type = 'full') %>%
  mutate(bi_class = paste(cc_hab, noncc_hab, sep = '-'))

### Polygon of hot-hot and cool-cool spots for outlines
# hot_cool_sf <- cc_noncc_hab_df %>%
#   filter(bi_class %in% c('1-1', '4-4')) %>%
#   mutate(val = ifelse(bi_class == '1-1', 0, 1)) %>%
#   select(x, y, val) %>%
#   rast(type = 'xyz', crs = crs(cc_qtile_hab)) %>%
#   as.polygons() %>% 
#   sf::st_as_sf() %>%
#   st_simplify(dTolerance = 20000) %>%
#   mutate(val = as.character(val))

hab_overlap_summary <- cc_noncc_hab_df %>%
  group_by(bi_class) %>%
  summarize(ncell = n(),
            pct = n() / nrow(.))
knitr::kable(hab_overlap_summary, digits = 4, 
             col.names = c('hab CHI overlap', '# of cells', '% of area'))

panel_a <- ggplot() +
  ### background for NA cells:
  geom_raster(data = ocean_df, aes(x, y), fill = 'grey85') +
  ### plot data:
  geom_raster(data = cc_noncc_hab_df, aes(x, y, fill = bi_class), show.legend = FALSE) +
  # bi_scale_fill(pal = pal_name, dim = 4) +
  scale_fill_manual(breaks = colors_df$bi_class, values = colors_df$bi_fill) +
  ### continents:
  geom_sf(data = land_sf,
          fill = 'grey96', color = 'grey40', 
          size = .1) +
  # geom_sf(data = hot_cool_sf, aes(color = val), 
  #         fill = NA, size = .1,
  #         show.legend = FALSE) +
  # scale_color_manual(values = c('green', 'yellow')) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank())
```

``` {r make biscale legend}
panel_a_lgd_raw <- ggplot(colors_df, aes(x, y, fill = bi_class)) +
  labs(x = "Climate -->",
       y = "Nonclimate -->") +
  geom_tile(show.legend = FALSE, color = 'white', size = .25) +
  scale_fill_manual(breaks = colors_df$bi_class, values = colors_df$bi_fill) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme(text = element_text(family = 'bentonbold'),
        plot.background = element_blank())
# panel_a_lgd_raw
```

### FE impact hot/cool spots overlap with hab impact

Compare the FE CHI hot/cool spots with hab - incl SÃ¸rensen similarity

```{r panel X bivariate by fe}
cc_fe_df <- as.data.frame(cc_qtile_fe, xy = TRUE) %>%
  setNames(c('x', 'y', 'cc_fe'))
noncc_fe_df <- as.data.frame(noncc_qtile_fe, xy = TRUE) %>%
  setNames(c('x', 'y', 'noncc_fe'))

cc_noncc_fe_df <- dt_join(cc_fe_df, noncc_fe_df, 
                          by = c('x', 'y'), type = 'full') %>%
  mutate(bi_class = paste(cc_fe, noncc_fe, sep = '-'))

# fe_overlap_summary <- cc_noncc_fe_df %>%
#   group_by(bi_class) %>%
#   summarize(ncell = n(),
#             pct = n() / nrow(.))
# knitr::kable(fe_overlap_summary, digits = 4, 
#              col.names = c('FE CHI overlap', '# of cells', '% of area'))

fe_hotspots <- cc_noncc_fe_df %>%
  filter(bi_class %in% c('1-1', '4-4')) %>%
  select(x, y, fe_bi = bi_class)
hab_hotspots <- cc_noncc_hab_df %>%
  filter(bi_class %in% c('1-1', '4-4')) %>%
  select(x, y, hab_bi = bi_class)

similarity_df <- fe_hotspots %>%
  full_join(hab_hotspots, by = c('x', 'y')) %>%
  mutate(match = case_when(is.na(hab_bi) ~ 'b',
                           is.na(fe_bi)  ~ 'c',
                           hab_bi == fe_bi ~ 'a',
                           TRUE ~ 'X')) %>%
  group_by(match) %>%
  summarize(n_gp = n()) %>%
  spread(match, n_gp) %>%
  mutate(jaccard = a / (a + b + c),
         sorensen = 2*a / (2*a + b + c))
table(similarity_df$match)
# panel_x <- ggplot() +
#   ### background for NA cells:
#   geom_raster(data = ocean_df, aes(x, y), fill = 'grey85') +
#   ### plot data:
#   geom_raster(data = cc_noncc_fe_df, aes(x, y, fill = bi_class), show.legend = FALSE) +
#   bi_scale_fill(pal = pal_name, dim = 4) +
#   ### continents:
#   geom_sf(data = land_sf,
#           fill = 'grey96', color = 'grey40', size = .10) +
#   scale_x_continuous(expand = c(0, 0)) +
#   scale_y_continuous(expand = c(0, 0)) +
#   theme_void() +
#   theme(axis.text = element_blank(), 
#         axis.title = element_blank())
```

### Panel B and C: hab-FE climate and non-climate overlap

```{r panel B}
cc_fe_hab_df <- dt_join(cc_hab_df, cc_fe_df, by = c('x', 'y'), type = 'full') %>%
  mutate(bi_class = paste(cc_hab, cc_fe, sep = '-')) %>%
  filter(!is.na(cc_fe) & !is.na(cc_hab))

### Polygon of hot-hot and cool-cool spots for outlines
# bi_classes <- c('1-1', '4-4', '1-4', '4-1')
# hot_cool_sf <- cc_fe_hab_df %>%
#   filter(bi_class %in% bi_classes) %>%
#   rowwise() %>%
#   mutate(val = which(bi_class == bi_classes)) %>%
#   ungroup() %>%
#   select(x, y, val) %>%
#   rast(type = 'xyz', crs = crs(cc_qtile_hab)) %>%
#   as.polygons() %>% 
#   sf::st_as_sf() %>%
#   st_simplify(dTolerance = 20000) %>%
#   mutate(val = as.character(val))

hab_overlap_summary <- cc_fe_hab_df %>%
  group_by(bi_class) %>%
  summarize(ncell = n(),
            pct = n() / nrow(.))
knitr::kable(hab_overlap_summary, digits = 4, 
             col.names = c('hab/FE CHI overlap, climate', '# of cells', '% of area'))

panel_b <- ggplot() +
  ### background for NA cells:
  geom_raster(data = ocean_df, aes(x, y), fill = 'grey85') +
  ### plot data:
  geom_raster(data = cc_fe_hab_df, aes(x, y, fill = bi_class), show.legend = FALSE) +
  scale_fill_manual(breaks = colors_df$bi_class, values = colors_df$bi_fill) +
  # bi_scale_fill(pal = pal_name, dim = 4) +
  ### continents:
  geom_sf(data = land_sf,
          fill = 'grey96', color = 'grey40', 
          size = .1) +
  # geom_sf(data = hot_cool_sf, aes(color = val), 
  #         fill = NA, size = .1,
  #         show.legend = FALSE) +
  # scale_color_manual(values = c('green', 'yellow', 'red', 'blue')) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank())
```

```{r panel C}
noncc_fe_hab_df <- dt_join(noncc_hab_df, noncc_fe_df, by = c('x', 'y'), type = 'full') %>%
  mutate(bi_class = paste(noncc_hab, noncc_fe, sep = '-')) %>%
  filter(!is.na(noncc_fe) & !is.na(noncc_hab))

### Polygon of hot-hot and cool-cool spots for outlines
# bi_classes <- c('1-1', '4-4', '1-4', '4-1')
# hot_cool_sf <- noncc_fe_hab_df %>%
#   filter(bi_class %in% bi_classes) %>%
#   rowwise() %>%
#   mutate(val = which(bi_class == bi_classes)) %>%
#   ungroup() %>%
#   select(x, y, val) %>%
#   rast(type = 'xyz', crs = crs(cc_qtile_hab)) %>%
#   as.polygons() %>% 
#   sf::st_as_sf() %>%
#   st_simplify(dTolerance = 20000) %>%
#   mutate(val = as.character(val))

hab_overlap_summary <- noncc_fe_hab_df %>%
  group_by(bi_class) %>%
  summarize(ncell = n(),
            pct = n() / nrow(.))
knitr::kable(hab_overlap_summary, digits = 4, 
             col.names = c('hab/FE CHI overlap, nonclimate', '# of cells', '% of area'))

panel_c <- ggplot() +
  ### background for NA cells:
  geom_raster(data = ocean_df, aes(x, y), fill = 'grey85') +
  ### plot data:
  geom_raster(data = noncc_fe_hab_df, aes(x, y, fill = bi_class), show.legend = FALSE) +
  scale_fill_manual(breaks = colors_df$bi_class, values = colors_df$bi_fill) +
  # bi_scale_fill(pal = pal_name, dim = 4) +
  ### continents:
  geom_sf(data = land_sf,
          fill = 'grey96', color = 'grey40', 
          size = .1) +
  # geom_sf(data = hot_cool_sf, aes(color = val), 
  #         fill = NA, size = .1,
  #         show.legend = FALSE) +
  # scale_color_manual(values = c('green', 'yellow', 'red', 'blue')) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank())
```

``` {r make biscale legend for panels b and c}
panel_bc_lgd_raw <- ggplot(colors_df, aes(x, y, fill = bi_class)) +
  labs(x = "CHI Hab -->",
       y = "CHI FE -->") +
  geom_tile(show.legend = FALSE, color = 'white', size = .25) +
  scale_fill_manual(breaks = colors_df$bi_class, values = colors_df$bi_fill) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme(text = element_text(family = 'bentonbold'),
        plot.background = element_blank())
# panel_bc_lgd_raw
```

## Assemble figure

```{r assemble figure}
fig3_file <- here('5_ms_figs/fig3_comparing_hab_vs_fe_chi.png')
panel_a_map  <- get_panel(panel_a)
panel_b_map  <- get_panel(panel_b)
panel_c_map  <- get_panel(panel_c)
# panel_d_map  <- get_panel(panel_d)
panel_a_lgd <- get_panel(panel_a_lgd_raw)
panel_bc_lgd <- get_panel(panel_bc_lgd_raw)

### parameterize legends for easier changing of label positions:
lgd_a_xy <- c(x = .875, y = .80, h = .09, w = .12)
lgd_b_xy <- c(x = .875, y = .25, h = .09, w = .12)

fig_3 <- ggdraw() +
  ### draw panels:
  draw_plot(panel_a_map,  x = 0.00, y = 0.67, height = 0.33, width = 0.85) +
  draw_plot(panel_b_map,  x = 0.00, y = 0.335, height = 0.33, width = 0.85) +
  draw_plot(panel_c_map,  x = 0.00, y = 0.00, height = 0.33, width = 0.85) +
  ### draw legends:
  draw_plot(panel_a_lgd, x = lgd_a_xy['x'], y = lgd_a_xy['y'], 
            height = lgd_a_xy['h'], width = lgd_a_xy['w']) +
  draw_plot(panel_bc_lgd, x = lgd_b_xy['x'], y = lgd_b_xy['y'], 
            height = lgd_b_xy['h'], width = lgd_b_xy['w']) +
  ### Panel labels:
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10, fontfamily = 'bentonbold') +
  draw_label('B', x = 0.002, y = .64, hjust = 0, vjust = 0, 
             size = 10, fontfamily = 'bentonbold') +
  draw_label('C', x = 0.002, y = .30, hjust = 0, vjust = 0, 
             size = 10, fontfamily = 'bentonbold') +
  draw_label('Climate', x = 0.05, y = .64, hjust = 0, vjust = 0, 
             size = 8, fontfamily = 'bentonbold') +
  draw_label('Non-climate', x = 0.05, y = .30, hjust = 0, vjust = 0, 
             size = 8, fontfamily = 'bentonbold') +
  ### panel A labels:
  draw_label('Climate vs. non-climate\nimpacts (quartiles)',
             x = 0.99, y = 0.92, hjust = 1, vjust = 0, angle = 0,
             size = 8, color = 'black', fontfamily = 'bentonbold') +
  draw_label('Climate ->', 
             x = lgd_a_xy['x'], y = lgd_a_xy['y'] - .005, 
             hjust = 0, vjust = 1, angle = 0,
             size = 7, color = 'black', fontfamily = 'bentonbold') +
  draw_label('Non-climate ->', 
             x = lgd_a_xy['x'] - .005, y = lgd_a_xy['y'], 
             hjust = 0, vjust = 0, angle = 90,
             size = 7, color = 'black', fontfamily = 'bentonbold') +
  ### panel B & C labels:
  draw_label('FE vs. hab:\ncc/non-cc\nimpacts (quartiles)',
             x = 0.99, y = 0.35, hjust = 1, vjust = 0, angle = 0,
             size = 8, color = 'black', fontfamily = 'bentonbold') +
  draw_label('Habitat ->', 
             x = lgd_b_xy['x'], y = lgd_b_xy['y'] - .005, 
             hjust = 0, vjust = 1, angle = 0,
             size = 7, color = 'black', fontfamily = 'bentonbold') +
  draw_label('FE ->', 
             x = lgd_b_xy['x'] - .005, y = lgd_b_xy['y'], 
             hjust = 0, vjust = 0, angle = 90,
             size = 7, color = 'black', fontfamily = 'bentonbold')

ggsave(fig3_file, width = 12, height = 15, units = 'cm', dpi = 300)

knitr::include_graphics(fig3_file)
```

