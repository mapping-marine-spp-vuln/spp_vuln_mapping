---
title: "Figure 2: Maps of spp and FE CHI"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 4, fig.width = 7)

library(terra)
library(sf)
library(oharac)
library(data.table)
library(tidyverse)
library(biscale)  ### for bivariate legend
library(cowplot)
library(here)
source(here('common_fxns.R'))

```

# Summary

Create Fig. 1 for manuscript

# Data

Results from scripts in folder `2_process_spp_vuln_and_impacts`

# Methods

Read in the output rasters for species-level impacts (unweighted); reclassify based on quartile/quintile.  Fig. 1A is bivariate plot of climate vs. non-climate stressors for equal weighted species average, Fig. 1B is bivariate plot of climate vs. non-climate stressors for FV-weighted FE average; Fig. 1C and 1D are %difference plots for each category.

NOTE: dropping cells with fewer than 20 species, mostly in the Arctic, a few in Antarctic.

```{r}
ocean_map <- rast(here('_spatial/ocean_area_mol.tif'))
ocean_df <- as.data.frame(ocean_map, xy = TRUE)

land_sf <- read_sf(here('_spatial/ne_10m_land/ne_10m_land_no_casp.shp')) %>%
  st_transform(st_crs(ocean_map))

nspp_mask <- rast(here('_output/nspp_maps/species_richness.tif'))
nspp_vals <- values(nspp_mask)
values(nspp_mask)[nspp_vals < 20] <- NA

chi_gps_spp <- list.files(here('_output/cumulative_impact_maps'),
                         pattern = 'species_group_chi',
                         full.names = TRUE)
chi_gps_fe <- list.files(here('_output/cumulative_impact_maps'),
                         pattern = 'funct_entity_group_chi',
                         full.names = TRUE)
climate_map_spp     <- rast(chi_gps_spp[1]) %>%
  mask(nspp_mask)
climate_map_fe     <- rast(chi_gps_fe[1]) %>%
  mask(nspp_mask)

nonclimate_map_spp  <- rast(chi_gps_spp[2:4]) %>%
  sum(na.rm = TRUE) %>%
  mask(nspp_mask)

nonclimate_map_fe  <- rast(chi_gps_fe[2:4]) %>%
  sum(na.rm = TRUE) %>%
  mask(nspp_mask)
```

### Reclassify

Reclassify values using `ntile` to get quartile values:
```{r reclass eq weight}
cc_qtile_spp <- noncc_qtile_spp <- climate_map_spp ### initialize two new maps
values(cc_qtile_spp) <- ntile(values(climate_map_spp), 4)
values(noncc_qtile_spp) <- ntile(values(nonclimate_map_spp), 4)
# plot(cc_qtile_spp, axes = FALSE, 
#      main = 'Climate impact quintile, spp avg', col = hcl.colors(4))
# plot(noncc_qtile_spp, axes = FALSE, 
#      main = 'Non-climate impact quintile, spp avg', col = hcl.colors(4))
```

```{r reclass fv weight}
cc_qtile_fe <- noncc_qtile_fe <- climate_map_fe ### initialize two new maps
values(cc_qtile_fe) <- ntile(values(climate_map_fe), 4)
values(noncc_qtile_fe) <- ntile(values(nonclimate_map_fe), 4)
# plot(cc_qtile_fe, axes = FALSE, 
#      main = 'Climate impact quintile, fv wt avg', col = hcl.colors(4))
# plot(noncc_qtile_fe, axes = FALSE, 
#      main = 'Non-climate impact quintile, fv wt avg', col = hcl.colors(4))
```

## Create panels

### Set up palettes

For the bivariate color plot, one axis of colors represents climate, the other represents non-climate; for corner values (max agreement and max disagreement), use diverging color palettes; for intermediate values use a light shading to indicate variation more subtly.

``` {r make biscale legend}
map_pal_raw <- bi_pal(pal = 'PurpleOr', dim = 4, preview = FALSE)
  
map_pal_mtx      <- matrix(map_pal_raw, nrow = 4, ncol = 4)
map_pal_mtx[3, ] <- colorspace::lighten(map_pal_mtx[3, ], .1)
map_pal_mtx[2, ] <- colorspace::lighten(map_pal_mtx[2, ], .2)
map_pal_mtx[1, ] <- colorspace::lighten(map_pal_mtx[1, ], .3)
map_pal_mtx[ , 3] <- colorspace::lighten(map_pal_mtx[ , 3], .1)
map_pal_mtx[ , 2] <- colorspace::lighten(map_pal_mtx[ , 2], .2)
map_pal_mtx[ , 1] <- colorspace::lighten(map_pal_mtx[ , 1], .3)
map_pal_mtx[1, 1] <- '#ffffee'

map_pal <- as.vector(map_pal_mtx) %>% setNames(names(map_pal_raw))

panel_lgd_raw <- bi_legend(pal = map_pal, dim = 4,
                           x = 'CHI Hab',
                           y = 'CHI FE')
panel_lgd_raw
```

### Panel A and B: spp and FE average bivariate plot

Use a four-level bivariate color scale to capture spatial overlap of quartiles for climate and non-climate stressors.

```{r spp dataframes}
cc_spp_df <- as.data.frame(cc_qtile_spp, xy = TRUE) %>%
  setNames(c('x', 'y', 'cc_spp'))
noncc_spp_df <- as.data.frame(noncc_qtile_spp, xy = TRUE) %>%
  setNames(c('x', 'y', 'noncc_spp'))

cc_noncc_spp_df <- full_join(cc_spp_df, noncc_spp_df, by = c('x', 'y'), type = 'full') %>%
  mutate(bi_class = paste(cc_spp, noncc_spp, sep = '-'))
```

```{r define globe boundary}
globe_bbox <- rbind(c(-180, -90), c(-180, 90), 
                      c(180, 90), c(180, -90), c(-180, -90)) 
globe_border <- st_polygon(list(globe_bbox)) %>%
  st_sfc(crs = 4326) %>%
  st_sf(data.frame(rgn = 'globe', geom = .)) %>%
  smoothr::densify(max_distance = 0.5) %>%
  st_transform(crs = crs(ocean_map))
```

```{r panel A}

panel_a_spp <- ggplot() +
  ### background for NA cells:
  geom_raster(data = ocean_df, aes(x, y), fill = 'grey85') +
  ### plot data:
  geom_raster(data = cc_noncc_spp_df, aes(x, y, fill = bi_class), show.legend = FALSE) +
  ### continents:
  geom_sf(data = land_sf,
          fill = 'grey96', color = 'grey40', 
          size = .1) +
  geom_sf(data = globe_border,
          fill = NA, color = 'grey70', 
          size = .1) +
  bi_scale_fill(pal = map_pal, dim = 4) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank())

# panel_a_spp
```

```{r FE dataframes}
cc_fe_df <- as.data.frame(cc_qtile_fe, xy = TRUE) %>%
  setNames(c('x', 'y', 'cc_fe'))
noncc_fe_df <- as.data.frame(noncc_qtile_fe, xy = TRUE) %>%
  setNames(c('x', 'y', 'noncc_fe'))

cc_noncc_fe_df <- full_join(cc_fe_df, noncc_fe_df, by = c('x', 'y'), type = 'full') %>%
  mutate(bi_class = paste(cc_fe, noncc_fe, sep = '-'))
```

```{r panel B}
panel_b_fe <- ggplot() +
  ### background for NA cells:
  geom_raster(data = ocean_df, aes(x, y), fill = 'grey85') +
  ### plot data:
  geom_raster(data = cc_noncc_fe_df, aes(x, y, fill = bi_class), show.legend = FALSE) +
  ### continents:
  geom_sf(data = land_sf,
          fill = 'grey96', color = 'grey40', 
          size = .1) +
  geom_sf(data = globe_border,
          fill = NA, color = 'grey70', 
          size = .1) +
  bi_scale_fill(pal = map_pal, dim = 4) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank())

# panel_b_fe
```

```{r spp vs fe comparison}

spp_overlap_summary <- cc_noncc_spp_df %>%
  group_by(bi_class) %>%
  summarize(ncell = n(),
            pct = n() / nrow(.))
knitr::kable(spp_overlap_summary, digits = 4, 
             col.names = c('spp CHI overlap', '# of cells', '% of area'))


fe_overlap_summary <- cc_noncc_fe_df %>%
  group_by(bi_class) %>%
  summarize(ncell = n(),
            pct = n() / nrow(.))
knitr::kable(fe_overlap_summary, digits = 4, 
             col.names = c('FE CHI overlap', '# of cells', '% of area'))


fe_hotspots <- cc_noncc_fe_df %>%
  filter(bi_class %in% c('1-1', '4-4')) %>%
  select(x, y, fe_bi = bi_class)
spp_hotspots <- cc_noncc_spp_df %>%
  filter(bi_class %in% c('1-1', '4-4')) %>%
  select(x, y, spp_bi = bi_class)

similarity_df <- fe_hotspots %>%
  full_join(spp_hotspots, by = c('x', 'y')) %>%
  mutate(match = case_when(is.na(spp_bi) ~ 'b',
                           is.na(fe_bi)  ~ 'c',
                           spp_bi == fe_bi ~ 'a',
                           TRUE ~ 'X')) %>%
  group_by(match) %>%
  summarize(n_gp = n()) %>%
  spread(match, n_gp) %>%
  mutate(jaccard = a / (a + b + c),
         sorensen = 2*a / (2*a + b + c))

knitr::kable(similarity_df)

```

### Panel C and D: residuals, spp-average vs fe-average

First, we generate a linear model relating FE mean to Spp mean.  Should we force the intercept to zero? since, well, that just makes sense... we can also explore a 1:1 model, since as FEs become more and more specific (membership --> 1) the FE weighting approaches the spp equal-weighting.

```{r set up linear models}
fe_vs_spp_stack <- rast(list(spp_cc = climate_map_spp,
                             spp_noncc = nonclimate_map_spp,
                             fe_cc = climate_map_fe,
                             fe_noncc = nonclimate_map_fe))

### Keep raster values with xy = TRUE, no need for cell IDs
spp_vs_fe_df <- as.data.frame(fe_vs_spp_stack, xy = TRUE)

### generate a LM based on climate stressors
cc_mdl <- lm(fe_cc ~ spp_cc + 0, data = spp_vs_fe_df)
ggplot(spp_vs_fe_df %>% sample_n(10000), aes(x = spp_cc, y = fe_cc)) +
  geom_point() +
  geom_abline(intercept = cc_mdl$coefficients[1],
              slope = cc_mdl$coefficients[2],
              color = 'red') +
  geom_abline(intercept = 0,
              slope = 1,
              color = 'blue', alpha = .5) +
  coord_fixed() +
  xlim(c(0, 1)) + ylim(c(0, 1))

### generate a LM based on non-climate stressors
noncc_mdl <- lm(fe_noncc ~ spp_noncc + 0, data = spp_vs_fe_df)
ggplot(spp_vs_fe_df %>% sample_n(10000), aes(x = spp_noncc, y = fe_noncc)) +
  geom_point() +
  geom_abline(intercept = noncc_mdl$coefficients[1],
              slope = noncc_mdl$coefficients[2],
              color = 'red') +
  geom_abline(intercept = 0,
              slope = 1,
              color = 'blue', alpha = .5) +
  coord_fixed() +
  xlim(c(0, 1)) + ylim(c(0, 1))
```

$$I_{FE}^{cc} = 1.066 I_{spp}^{cc} + 0 \quad (adj.R^2 = 0.958)$$

$$I_{FE}^{non-cc} = .829 I_{spp}^{non-cc} + 0 \quad (adj.R^2 = 0.923)$$

These high R^2^ values are expected - the underlying data is identical (presence/absence of each species, vulnerability of each species, intensity of impact) - the difference is in weighting the impact of each species by its importance to distinct functional entities.  Where the two metrics diverge, this is due to differences impacts on community structure.

What if we examine a 1:1 model, i.e.: $I_{FE} = 1.0 I_{spp} + 0$?

$$R^2 = 1 - \frac{RSS}{TSS} = 1 - \frac{\sum(y_i - \hat y_i)^2}{\sum(y_i - \bar y_i)^2}$$

```{r}
rss_cc <- sum((spp_vs_fe_df$fe_cc - spp_vs_fe_df$spp_cc)^2)
tss_cc <- sum((spp_vs_fe_df$fe_cc - mean(spp_vs_fe_df$fe_cc))^2)
rsq_cc <- 1 - rss_cc / tss_cc

rss_noncc <- sum((spp_vs_fe_df$fe_noncc - spp_vs_fe_df$spp_noncc)^2)
tss_noncc <- sum((spp_vs_fe_df$fe_noncc - mean(spp_vs_fe_df$fe_noncc))^2)
rsq_noncc <- 1 - rss_noncc / tss_noncc
```

Even a simple one-to-one model gets good $R^2$ values:

$$I_{FE}^{cc} = 1.0 I_{spp}^{cc} + 0 \quad (R^2 = 0.744)$$

$$I_{FE}^{non-cc} = 1.0 I_{spp}^{non-cc} + 0 \quad (R^2 = 0.873)$$

```{r calc residuals from one to one model}
spp_vs_fe_resids_df <- spp_vs_fe_df %>%
  mutate(fe_cc_pred    = predict(cc_mdl),
         fe_noncc_pred = predict(noncc_mdl),
         fe_cc_res     = fe_cc - fe_cc_pred,
         fe_noncc_res  = fe_noncc - fe_noncc_pred,
         fe_cc_diff    = fe_cc - spp_cc,
         fe_noncc_diff = fe_noncc - spp_noncc) %>%
  mutate(fe_cc_res2 = case_when(fe_cc_res > .2  ~ .2,
                                fe_cc_res < -.2 ~ -.2,
                                TRUE ~ fe_cc_res),
         fe_noncc_res2 = case_when(fe_noncc_res > .2  ~ .2,
                                fe_noncc_res < -.2 ~ -.2,
                                TRUE ~ fe_noncc_res)) %>%
  mutate(fe_cc_diff2 = case_when(fe_cc_diff > .2  ~ .2,
                                 fe_cc_diff < -.2 ~ -.2,
                                 TRUE ~ fe_cc_diff),
         fe_noncc_diff2 = case_when(fe_noncc_diff > .2  ~ .2,
                               fe_noncc_diff < -.2 ~ -.2,
                               TRUE ~ fe_noncc_diff))

```

```{r panel c}
# clrs <- c('#005600', '#42a644', '#fffff8', '#dd6ba6', '#841859')
clrs <- c('#005600', '#42a644', '#f8f8ff', '#dd6ba6', '#841859')
brks <- c(-.2, -.1, 0, .1, .2)
lims <- c(-.2, .2)
lbls <- c('≤-.20', '-.10', '0', '.10', '≥.20')

panel_c_cc <- ggplot() +
  ### background for NA cells:
  geom_raster(data = ocean_df, aes(x, y), fill = 'grey85') +
  ### plot data:
  geom_raster(data = spp_vs_fe_resids_df,
              aes(x, y, fill = fe_cc_diff2)) +
  scale_fill_gradientn(colors = clrs, 
                       breaks = brks,
                       labels = lbls,
                       limits = lims,
                       na.value = 'grey96') +
  ### continents:
  geom_sf(data = land_sf,
          fill = 'grey96', color = 'grey40', 
          size = .10) +
  geom_sf(data = globe_border,
          fill = NA, color = 'grey70', 
          size = .1) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void() +
  theme(text = element_text(family = 'Helvetica'),
        axis.text = element_blank(), 
        axis.title = element_blank(),
        legend.key.height = unit(.25, 'cm'),
        legend.key.width = unit(.75, 'cm'),
        legend.spacing = unit(0, 'cm'),
        legend.margin = margin(0, 0, 0, 0, unit = 'pt'),
        legend.text = element_text(size = 6, color = 'black', 
                                   hjust = 0.5, vjust = 0, angle = 0),
        legend.position = 'bottom',
        legend.direction = 'horizontal',
        legend.title = element_blank())

# panel_c_cc
```

```{r panel d}
panel_d_noncc <- ggplot() +
  ### background for NA cells:
  geom_raster(data = ocean_df, aes(x, y), fill = 'grey85') +
  ### plot data:
  geom_raster(data = spp_vs_fe_resids_df,
              aes(x, y, fill = fe_noncc_diff2)) +
  scale_fill_gradientn(colors = clrs, 
                       breaks = brks,
                       labels = lbls,
                       limits = lims,
                       na.value = 'grey96') +
  ### continents:
  geom_sf(data = land_sf,
          fill = 'grey96', color = 'grey40', 
          size = .10) +
  geom_sf(data = globe_border,
          fill = NA, color = 'grey70', 
          size = .1) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank(),
        legend.position = 'none')

# panel_d_noncc
```

## Assemble figure

```{r gather pieces}
fig2_file <- here('5_ms_figs/fig2_mapping_impacts.png')
panel_a_map  <- get_panel(panel_a_spp)
panel_b_map  <- get_panel(panel_b_fe)
panel_c_map  <- get_panel(panel_c_cc)
panel_d_map  <- get_panel(panel_d_noncc)
panel_ab_lgd <- get_panel(panel_lgd_raw)
panel_cd_lgd <- get_legend(panel_c_cc)
```

```{r assemble figure square}

### parameterize panels for easier changing
p_w <- 0.55
p_h <- p_w / 2 * 6/5
a <- c(x = 0.00, y = 0.63)
b <- c(x = 1-p_w, y = 0.42)
c <- c(x = 0.00, y = 0.21)
d <- c(x = 1-p_w, y = 0.0)

fig2_panels <- ggdraw() +
  draw_plot(panel_a_map,  x = a['x'], y = a['y'], height = p_h, width = p_w) +
  draw_plot(panel_b_map,  x = b['x'], y = b['y'], height = p_h, width = p_w) +
  draw_plot(panel_c_map,  x = c['x'], y = c['y'], height = p_h, width = p_w) +
  draw_plot(panel_d_map,  x = d['x'], y = d['y'], height = p_h, width = p_w)

fig2_labels <- fig2_panels +
  draw_label('A', x = a['x'], y = a['y'] + p_h,  hjust = 0, vjust = 0, 
             size = 9, fontfamily = 'Helvetica', fontface = 'bold') +
  draw_label('B', x = 1,      y = b['y'] + p_h,  hjust = 1, vjust = 0, 
             size = 9, fontfamily = 'Helvetica', fontface = 'bold') +
  draw_label('C', x = c['x'], y = c['y'] + p_h,  hjust = 0, vjust = 0, 
             size = 9, fontfamily = 'Helvetica', fontface = 'bold') +
  draw_label('D', x = 1,      y = d['y'] + p_h,  hjust = 1, vjust = 0, 
             size = 9, fontfamily = 'Helvetica', fontface = 'bold') +
  draw_label('Species', x = a['x'] + .04,  y = a['y'] + p_h,  hjust = 0, vjust = 0, 
             size = 7, fontfamily = 'Helvetica') +
  draw_label('Funct. entity', x = 1 - .04, y = b['y'] + p_h,  hjust = 1, vjust = 0, 
             size = 7, fontfamily = 'Helvetica') +
  draw_label('Climate', x = c['x'] + .04,  y = c['y'] + p_h,  hjust = 0, vjust = 0, 
             size = 7, fontfamily = 'Helvetica') +
  draw_label('Non-climate', x = 1 - .04,   y = d['y'] + p_h,  hjust = 1, vjust = 0, 
             size = 7, fontfamily = 'Helvetica')
```

``` {r finish plot with legends}
### parameterize legends for easier changing of label positions:
l1 <- c(x = .68, y = 0.80, h = .144, w = .12)
l2 <- c(x = .00, y = 0.02, h = .07, w = .44)

fig2_legends <- fig2_labels +
  ### draw legends:
  draw_plot(panel_ab_lgd, x = l1['x'], y = l1['y'],
            height = l1['h'], width = l1['w']) +
  draw_plot(panel_cd_lgd, x = l2['x'], y = l2['y'],
            height = l2['h'], width = l2['w']) +
  ### Legend labels for biscale:
  draw_label('Climate vs. non-\nclimate impacts\n(quartiles)',
             x = l1['x'] + l1['w'] + .01, y = l1['y'] + l1['h'] - .01, 
             hjust = 0, vjust = 1, angle = 0,
             size = 7, color = 'black', fontfamily = 'Helvetica', fontface = 'bold') +
  draw_label('Climate ->',
             x = l1['x'], y = l1['y'] - .005,
             hjust = 0, vjust = 1, angle = 0,
             size = 6, color = 'black', fontfamily = 'Helvetica', fontface = 'bold') +
  draw_label('Non-climate ->',
             x = l1['x'] - .005, y = l1['y'],
             hjust = 0, vjust = 0, angle = 90,
             size = 6, color = 'black', fontfamily = 'Helvetica', fontface = 'bold') +
  ### Legend label for diff plots
  draw_label('Funct. entity vs. species\nimpacts (residuals)',
             x = .073, y = .15, hjust = 0, vjust = 1, angle = 0,
             size = 7, color = 'black', fontfamily = 'Helvetica', fontface = 'bold')


ggsave(fig2_file, width = 12, height = 10, units = 'cm', dpi = 300)

knitr::include_graphics(fig2_file)
```

