---
title: "Figure S1: Maps of hab CHI"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 4, fig.width = 7)

library(terra)
library(sf)
library(oharac)
library(data.table)
library(tidyverse)
library(biscale)  ### for bivariate legend
library(cowplot)
library(here)
source(here('common_fxns.R'))

```

# Summary

Create Fig. S1 for manuscript SI

# Data

Results from scripts in folder `3_process_hab_vuln_and_impacts`

# Methods

Read in the output rasters for habitat-based impacts; reclassify based on quartile/quintile.  Fig. 1A is bivariate plot of climate vs. non-climate stressors for equal weighted habitat average.

NOTE: dropping cells with fewer than 20 species, mostly in the Arctic, a few in Antarctic.

```{r}
ocean_map <- rast(here('_spatial/ocean_area_mol.tif'))
ocean_df <- as.data.frame(ocean_map, xy = TRUE)

land_sf <- read_sf(here('_spatial/ne_10m_land/ne_10m_land_no_casp.shp')) %>%
  st_transform(st_crs(ocean_map))

chi_gps_hab <- list.files(here('_output/cumulative_impact_maps'),
                         pattern = 'habitat_group_chi',
                         full.names = TRUE)
climate_map_hab <- rast(chi_gps_hab[1])
nonclimate_map_hab  <- rast(chi_gps_hab[2:4]) %>%
  sum(na.rm = TRUE)

```

### Reclassify

Reclassify values using `ntile` to get quartile values:
```{r reclass eq weight}
cc_qtile_hab <- noncc_qtile_hab <- climate_map_hab ### initialize two new maps
values(cc_qtile_hab) <- ntile(values(climate_map_hab), 4)
values(noncc_qtile_hab) <- ntile(values(nonclimate_map_hab), 4)
# plot(cc_qtile_hab, axes = FALSE, 
#      main = 'Climate impact quintile, spp avg', col = hcl.colors(4))
# plot(noncc_qtile_hab, axes = FALSE, 
#      main = 'Non-climate impact quintile, spp avg', col = hcl.colors(4))
```

## Create plot

### Set up palette

For the bivariate color plot, one axis of colors represents climate, the other represents non-climate; for corner values (max agreement and max disagreement), use diverging color palettes; for intermediate values use a light shading to indicate variation more subtly.

``` {r make biscale legend}
# div_clr <- c('#7b3294', '#008837', 'black')
# div_clr <- c('#a6611a', '#018571', 'black')
div_clr <- c('#e66101', '#5e3c99', 'black')
### Diverging palettes from colorbrewer2.org:
#7b3294     #a6611a     #e66101
#c2a5cf     #dfc27d     #fdb863
#f7f7f7     #f5f5f5     #f7f7f7
#a6dba0     #80cdc1     #b2abd2
#008837     #018571     #5e3c99

colors_df <- crossing(x = 1:4, y = 1:4) %>%
  mutate(bi_class = paste(x, y, sep = '-')) %>%
  mutate(bi_fill = case_when(bi_class == '1-1' ~ '#ffffdd',
                             bi_class %in% c('1-2', '2-1') ~ '#eeeeff',
                             bi_class %in% c('1-3', '3-1', '2-2') ~ '#ddddee',
                             bi_class %in% c('2-3', '3-2') ~ '#ccccdd',
                             bi_class %in% c('3-3') ~ '#bbbbcc',
                             bi_class %in% c('1-4') ~ colorspace::lighten(div_clr[1], .4),
                             bi_class %in% c('2-4') ~ colorspace::lighten(div_clr[1], .2),
                             bi_class %in% c('3-4') ~ div_clr[1],
                             bi_class %in% c('4-1') ~ colorspace::lighten(div_clr[2], .4),
                             bi_class %in% c('4-2') ~ colorspace::lighten(div_clr[2], .2),
                             bi_class %in% c('4-3') ~ div_clr[2],
                             bi_class == '4-4' ~ div_clr[3], ### black
                             TRUE ~ 'blue'))

panel_lgd_raw <- ggplot(colors_df, aes(x, y, fill = bi_class)) +
  labs(x = "CHI Hab -->",
       y = "CHI FE -->") +
  geom_tile(show.legend = FALSE, color = 'white', size = .25) +
  scale_fill_manual(breaks = colors_df$bi_class, values = colors_df$bi_fill) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme(text = element_text(family = 'Helvetica', face = 'bold'),
        plot.background = element_blank())
```

### Habitat bivariate plot

Use a four-level bivariate color scale to capture spatial overlap of quartiles for climate and non-climate stressors.

```{r hab dataframes}
cc_hab_df <- as.data.frame(cc_qtile_hab, xy = TRUE) %>%
  setNames(c('x', 'y', 'cc_hab'))
noncc_hab_df <- as.data.frame(noncc_qtile_hab, xy = TRUE) %>%
  setNames(c('x', 'y', 'noncc_hab'))

cc_noncc_hab_df <- dt_join(cc_hab_df, noncc_hab_df, by = c('x', 'y'), type = 'full') %>%
  mutate(bi_class = paste(cc_hab, noncc_hab, sep = '-'))
```

```{r plot}
biplot_hab <- ggplot() +
  ### background for NA cells:
  geom_raster(data = ocean_df, aes(x, y), fill = 'grey85') +
  ### plot data:
  geom_raster(data = cc_noncc_hab_df, aes(x, y, fill = bi_class), show.legend = FALSE) +
  ### continents:
  geom_sf(data = land_sf,
          fill = 'grey96', color = 'grey40', 
          size = .1) +
  # geom_sf(data = hot_cool_sf, aes(color = val), 
  #         fill = NA, size = .1,
  #         show.legend = FALSE) +
  scale_fill_manual(breaks = colors_df$bi_class, values = colors_df$bi_fill) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank())

# biplot_hab
```

## Assemble figure

```{r gather pieces}
panel_a_map <- get_panel(biplot_hab)
panel_a_lgd <- get_panel(panel_lgd_raw)
```

``` {r assemble map}
figS1_file <- here('5_ms_figs/figS1_map_hab_cc_noncc.png')
lgd_p <- c(x = .88, y = .35, h = .25, w = .104)

figS1_panel <- ggdraw() +
  draw_plot(panel_a_map,  x = 0, y = 0, height = 1, width = .83) +
  ### draw legends:
  draw_plot(panel_a_lgd, x = lgd_p['x'], y = lgd_p['y'], 
            height = lgd_p['h'], width = lgd_p['w']) +
  ### Legend labels for biscale:
  draw_label('Climate vs. non-\nclimate impacts\n(quartiles)',
             x = lgd_p['x'] + lgd_p['w'], y = lgd_p['y'] + lgd_p['h'] + .03, 
             hjust = 1, vjust = 0, angle = 0,
             size = 7, color = 'black', fontfamily = 'Helvetica', fontface = 'bold') +
  draw_label('Climate ->',
             x = lgd_p['x'], y = lgd_p['y'] - .005,
             hjust = 0, vjust = 1, angle = 0,
             size = 5, color = 'black', fontfamily = 'Helvetica', fontface = 'bold') +
  draw_label('Non-climate ->',
             x = lgd_p['x'] - .005, y = lgd_p['y'],
             hjust = 0, vjust = 0, angle = 90,
             size = 5, color = 'black', fontfamily = 'Helvetica', fontface = 'bold')


ggsave(figS1_file, width = 12, height = 5, units = 'cm', dpi = 300)

knitr::include_graphics(figS1_file)
```

