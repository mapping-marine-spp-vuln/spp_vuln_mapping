---
title: "Compare cumulative impact across regions and methods"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 4, fig.width = 7)

library(terra)
library(oharac)
library(data.table)
library(tidyverse)
library(cowplot)
library(showtext) ### for custom fonts
library(here)
source(here('common_fxns.R'))

font_add(family = 'bentonbold', 
         regular = file.path('~/fonts', 
                             'BentonSans Condensed Bold', 
                             'BentonSans Condensed Bold.otf'))
font_add(family = 'benton', 
         regular = file.path('~/fonts', 
                             'BentonSans Condensed Book', 
                             'BentonSans Condensed Book.otf'))
showtext_auto()
```

# Summary

Examine distribution of impacts within regions (EEZ, MEOW, etc)

# Methods

Cumulative impact as the starting point; then perhaps break out by climate, land-based, ocean-based, and fishing stressors.  

## Load cumulative impact rasters

Build up an analysis dataframe including all three CHI maps.  Include additional layers to facilitate examination of impacts by coastal (i.e., neritic) vs. open ocean, as well as by EEZ and MEOW.  Include a layer of species richness to drop any instances where species count falls below some threshold, to ensure impact scores are based on a reasonable number of species (e.g., 20 spp).

```{r build chi dataframe}
chi_fs <- list.files(here('_output/impact_maps/cumulative_maps'), pattern = '^chi_.+.tif',
                     full.names = TRUE)
chi_stack <- rast(chi_fs) %>%
  setNames(basename(chi_fs) %>% str_remove('.tif'))

nspp_r <- rast(here('_output/nspp_maps/species_richness.tif')) %>%
  setNames('nspp')
coastal_r <- rast(here('_spatial/bathy_mol_neritic.tif')) %>%
  setNames('coastal')
eez_r <- rast(here('_spatial/eez_mol.tif')) %>%
  setNames('eez')
meow_r <- rast(here('_spatial/meow_rgns_mol.tif')) %>%
  setNames('meow')

chi_df <- data.frame(values(chi_stack),
                     values(nspp_r),
                     values(coastal_r),
                     values(eez_r),
                     values(meow_r)) %>%
  mutate(cell_id = 1:n()) %>%
  filter(nspp >= 20) %>%
  drop_na(starts_with('chi')) ### drop any cells with NA in *any* chi column - can't compare!
```

## Examine impacts by ecoregion

```{r SI figure by province, fig.height = 8}
meow_prov_df <- foreign::read.dbf(here('_spatial/meow_rgns/meow_rgns.dbf')) %>%
  janitor::clean_names() %>%
  arrange(prov_code) %>%
  mutate(realm_lbl = str_replace(realm, 'Temperate', 'Tmp'),
         realm_lbl = str_replace(realm_lbl, 'Tropical', 'Tr'),
         realm_lbl = str_replace(realm_lbl, 'Northern', 'N'),
         realm_lbl = str_replace(realm_lbl, 'Western', 'W'),
         realm_lbl = str_replace(realm_lbl, 'Eastern', 'E'),
         realm_lbl = str_replace(realm_lbl, 'South(ern)?', 'S'),
         realm_lbl = str_replace(realm_lbl, 'Central', 'C'),
         realm_lbl = str_replace(realm_lbl, 'Atlantic', 'Atl'),
         realm_lbl = str_replace(realm_lbl, 'Pacific', 'Pac'),
         realm_lbl = str_replace(realm_lbl, 'Africa', 'Afr'),
         realm_lbl = str_replace(realm_lbl, 'America', 'Amer'),
         realm_lbl = str_replace(realm_lbl, 'Australasia', 'Aus'),
         realm_lbl = fct_inorder(realm_lbl)) %>%
  mutate(prov_lbl = str_replace(province, 'Temperate', 'Temp'),
         prov_lbl = str_replace(prov_lbl, 'Tropical', 'Trop'),
         prov_lbl = str_replace(prov_lbl, 'North(ern)?', 'N'),
         prov_lbl = str_replace(prov_lbl, '(W|w)est(ern)?', 'W'),
         prov_lbl = str_replace(prov_lbl, '(E|e)ast(ern)?(?!er)', 'E'),
         prov_lbl = str_replace(prov_lbl, 'South(ern)?', 'S'),
         prov_lbl = str_replace(prov_lbl, 'Islands', 'Is'),
         prov_lbl = str_replace(prov_lbl, ', | and ', '/'),
         # prov_lbl = str_replace(prov_lbl, 'Central', 'C'),
         # prov_lbl = str_replace(prov_lbl, 'Atlantic', 'Atl'),
         # prov_lbl = str_replace(prov_lbl, 'Pacific', 'Pac'),
         # prov_lbl = str_replace(prov_lbl, 'Africa', 'Afr'),
         # prov_lbl = str_replace(prov_lbl, 'America', 'Amer'),
         # prov_lbl = str_replace(prov_lbl, 'Australasia', 'Aus'),
         prov_lbl = fct_inorder(prov_lbl))

meow_prov_chi_df <- chi_df %>%
  left_join(meow_prov_df, by = c('meow' = 'eco_code_x')) %>%
  mutate(fe  = ntile(chi_funct_entity, n = 1000) / 10,
         spp = ntile(chi_species, n = 1000) / 10,
         hab = ntile(chi_habitat, n = 1000) / 10) %>%
  ### In each realm, order by highest to lowest mean impact
  group_by(prov_lbl) %>%
  mutate(mean_fe = mean(fe)) %>%
  ungroup() %>%
  arrange(realm_lbl, mean_fe) %>%
  filter(!is.na(prov_lbl)) %>%
  mutate(prov_lbl = fct_inorder(prov_lbl)) %>%
  select(fe, spp, hab, cell_id, prov_lbl, realm_lbl) %>%
  gather(key = 'method', value = 'chi', spp, fe, hab) %>%
  filter(method != 'spp')

prov_means_df <- meow_prov_chi_df %>%
  group_by(realm_lbl, prov_lbl, method) %>%
  summarize(mean = mean(chi), med = median(chi))

# vals <- hcl.colors(4)[c(1, 2, 4)][c(2, 3)]
vals <- c('black', 'grey80')
brks <- c('spp', 'fe', 'hab')[c(2, 3)]
lbls <- c('Species', 'FE', 'Habitat')[c(2, 3)]

x <- ggplot(meow_prov_chi_df, 
            aes(x = prov_lbl, y = chi, fill = method, color = method)) +
  geom_hline(yintercept = 100, color = 'black', size = 2) +
  geom_boxplot(width = .4, position = position_dodge(width = .75),
               outlier.shape = NA, size = .25) +
  geom_point(data = prov_means_df, aes(y = mean, group = method), 
             position = position_dodge(width = .75),
             size = 2, shape = 21, color = 'black', fill = 'black') +
  geom_point(data = prov_means_df, aes(y = med, group = method), 
             position = position_dodge(width = .75),
             size = 2, shape = 21, color = 'black', fill = 'white') +
  scale_fill_manual(values = vals, breaks = brks, labels = lbls) +
  scale_color_manual(values = vals, breaks = brks, labels = lbls) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  coord_flip() +
  theme_minimal() +
  theme(axis.title = element_blank(),
        axis.text  = element_text(family = 'benton', size = 20),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.y = element_text(angle = 90, hjust = .5, family = 'bentonbold', size = 20)) +
  facet_grid(rows = vars(realm_lbl), 
             scales = 'free_y', space = 'free_y')

meow_prov_plot_f <- 'figSI_meow_prov_chi_plot.png'
ggsave(meow_prov_plot_f, height = 12, width = 6, dpi = 300, units = 'in')

knitr::include_graphics(meow_prov_plot_f)
```

```{r figure 4 meow by realm, fig.height = 8}

meow_realm_chi_df <- chi_df %>%
  left_join(meow_prov_df, by = c('meow' = 'eco_code_x')) %>%
  mutate(fe  = ntile(chi_funct_entity, n = 1000) / 10,
         spp = ntile(chi_species, n = 1000) / 10,
         hab = ntile(chi_habitat, n = 1000) / 10) %>%
  ### In each realm, order by highest to lowest mean impact
  group_by(realm_lbl) %>%
  mutate(mean_fe = mean(fe)) %>%
  ungroup() %>%
  arrange(mean_fe) %>%
  mutate(realm_lbl = fct_inorder(realm_lbl)) %>%
  select(fe, spp, hab, cell_id, realm_lbl) %>%
  gather(key = 'method', value = 'chi', spp, fe, hab) %>%
  filter(!is.na(realm_lbl)) %>%
  filter(method != 'spp')

realm_means_df <- meow_realm_chi_df %>%
  group_by(realm_lbl, method) %>%
  summarize(mean = mean(chi), med = median(chi))

panel_a <- ggplot(meow_realm_chi_df, 
                  aes(x = realm_lbl, y = chi, fill = method, color = method)) +
  geom_hline(yintercept = 100, color = 'black', size = 2) +
  geom_boxplot(width = .4, position = position_dodge(width = .75),
               outlier.shape = NA, size = .25) +
  geom_point(data = realm_means_df, aes(y = mean, group = method), 
             position = position_dodge(width = .75),
             size = 2, shape = 21, color = 'black', fill = 'black') +
  geom_point(data = realm_means_df, aes(y = med, group = method), 
             position = position_dodge(width = .75),
             size = 2, shape = 21, color = 'black', fill = 'white') +
  scale_fill_manual(values = vals, breaks = brks, labels = lbls) +
  scale_color_manual(values = vals, breaks = brks, labels = lbls) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  coord_flip() +
  theme_minimal() +
  theme(axis.title = element_blank(),
        axis.text  = element_text(family = 'benton', size = 20),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())

panel_a
```

## Examine impacts by EEZ (georegion)

```{r, fig.height = 8}
eez_rgns_df <- read_csv(here('_spatial/eez_rgn_names/rgn_names_ohi.csv')) %>%
  left_join(read_csv(here('_spatial/eez_rgn_names/unsd_methodology.csv')),
            by = 'iso3c') %>%
  janitor::clean_names() %>%
  mutate(ldc = ifelse(!is.na(least_developed_countries), 'LDC', 'not LDC'),
         sids = ifelse(!is.na(small_island_developing_states), 'SIDS', 'not SIDS')) %>%
  select(rgn_id, rgn_label, georgn, geosubrgn, 
         ldc, sids, dev = developed_developing) %>%
  mutate(georgn_lbl = str_replace(georgn, 'Northern', 'N'),
         georgn_lbl = str_replace(georgn_lbl, 'Southern', 'S'),
         georgn_lbl = str_replace(georgn_lbl, 'Atlantic', 'Atl'),
         georgn_lbl = str_replace(georgn_lbl, 'Pacific', 'Pac'),
         georgn_lbl = str_replace(georgn_lbl, 'America', 'Amer'),
         georgn_lbl = str_replace(georgn_lbl, 'Latin', 'Lat'),
         georgn_lbl = str_replace(georgn_lbl, ' and the Caribbean', '/Carib'),
         georgn_lbl = fct_inorder(georgn_lbl)) %>%
  mutate(subrgn_lbl = str_replace(geosubrgn, '(-)?(E|e)ast(ern)?', 'E'),
         subrgn_lbl = str_replace(subrgn_lbl, '(W|w)est(ern)?', 'W'),
         subrgn_lbl = str_replace(subrgn_lbl, 'North(ern)?', 'N'),
         subrgn_lbl = str_replace(subrgn_lbl, 'South(ern)?', 'S'),
         subrgn_lbl = str_replace(subrgn_lbl, 'Atlantic', 'Atl'),
         subrgn_lbl = str_replace(subrgn_lbl, 'Pacific', 'Pac'),
         subrgn_lbl = str_replace(subrgn_lbl, 'Africa', 'Afr'),
         subrgn_lbl = str_replace(subrgn_lbl, 'America', 'Amer'),
         subrgn_lbl = str_replace(subrgn_lbl, 'Australia and New Zealand', 'Aus/NZ'),
         subrgn_lbl = fct_inorder(subrgn_lbl))
eez_chi_df <- chi_df %>%
  left_join(eez_rgns_df, by = c('eez' = 'rgn_id')) %>%
  mutate(fe  = ntile(chi_funct_entity, n = 1000) / 10,
         spp = ntile(chi_species, n = 1000) / 10,
         hab = ntile(chi_habitat, n = 1000) / 10) %>%
  ### In each realm, order by highest to lowest mean impact
  group_by(subrgn_lbl) %>%
  mutate(mean_hab = mean(hab)) %>%
  ungroup() %>%
  arrange(georgn_lbl, mean_hab) %>%
  mutate(subrgn_lbl = fct_inorder(subrgn_lbl)) %>%
  select(fe, spp, hab, cell_id, subrgn_lbl, georgn_lbl, sids, ldc, dev) %>%
  gather(key = 'method', value = 'chi', spp, fe, hab) %>%
  filter(!is.na(subrgn_lbl))

means_df <- eez_chi_df %>%
  group_by(georgn_lbl, subrgn_lbl, method) %>%
  summarize(mean = mean(chi), med = median(chi))
  

x <- ggplot(eez_chi_df, aes(x = subrgn_lbl, y = chi, fill = method)) +
  geom_hline(yintercept = 100, color = 'black', size = 2) +
  geom_boxplot(width = .6, position = position_dodge(width = .75),
               outlier.shape = NA, color = 'black', size = .25) +
  geom_point(data = means_df, aes(y = mean, group = method), 
             position = position_dodge(width = .75),
             size = 2, shape = 21, color = 'black', fill = 'cyan') +
  geom_point(data = means_df, aes(y = med, group = method), 
             position = position_dodge(width = .75),
             size = 2, shape = 21, color = 'black', fill = 'white') +
  scale_fill_manual(values = hcl.colors(4)[c(1, 2, 4)], 
                    breaks = c('spp', 'fe', 'hab'),
                    labels = c('spp (eq wt)', 'spp (fv wt)', 'habitat')) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  coord_flip() +
  theme_minimal(base_family = "Roboto Condensed") +
  theme(axis.title = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.y = element_text(angle = 0, hjust = 0, face = 'bold')) +
  facet_grid(rows = vars(georgn_lbl), 
             scales = 'free_y', space = 'free_y')

ggsave(here('figs/eez_chi_plot.png'), height = 14, width = 6, dpi = 300)

knitr::include_graphics(here('figs/eez_chi_plot.png'))
```

```{r}
sids_df <- eez_chi_df %>%
  group_by(georgn_lbl) %>%
  filter(n_distinct(sids) == 2 | sids == 'SIDS')

means_df <- sids_df %>%
  group_by(georgn_lbl, sids, method) %>%
  summarize(mean = mean(chi), med = median(chi))

x <- ggplot(sids_df, aes(x = sids, y = chi, fill = method)) +
  geom_hline(yintercept = 100, color = 'black', size = 2) +
  geom_boxplot(width = .6, position = position_dodge(width = .75),
               outlier.shape = NA, color = 'black', size = .25) +
  geom_point(data = means_df, aes(y = mean, group = method), 
             position = position_dodge(width = .75),
             size = 2, shape = 21, color = 'black', fill = 'cyan') +
  geom_point(data = means_df, aes(y = med, group = method), 
             position = position_dodge(width = .75),
             size = 2, shape = 21, color = 'black', fill = 'white') +
  scale_fill_manual(values = hcl.colors(4)[c(1, 2, 4)], 
                    breaks = c('spp', 'fe', 'hab'),
                    labels = c('spp (eq wt)', 'spp (fv wt)', 'habitat')) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  coord_flip() +
  theme_minimal(base_family = "Roboto Condensed") +
  theme(axis.title = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.y = element_text(angle = 0, hjust = 0, face = 'bold')) +
  facet_grid(rows = vars(georgn_lbl), 
             scales = 'free_y', space = 'free_y')

ggsave(here('figs/sids_chi_plot.png'), height = 3.5, width = 6, dpi = 300)

knitr::include_graphics(here('figs/sids_chi_plot.png'))

```

```{r}
ldc_df <- eez_chi_df %>%
  group_by(georgn_lbl) %>%
  filter(n_distinct(ldc) == 2 | sids == 'LDC')

means_df <- ldc_df %>%
  group_by(georgn_lbl, ldc, method) %>%
  summarize(mean = mean(chi), med = median(chi))

x <- ggplot(sids_df, aes(x = ldc, y = chi, fill = method)) +
  geom_hline(yintercept = 100, color = 'black', size = 2) +
  geom_boxplot(width = .6, position = position_dodge(width = .75),
               outlier.shape = NA, color = 'black', size = .25) +
  geom_point(data = means_df, aes(y = mean, group = method), 
             position = position_dodge(width = .75),
             size = 2, shape = 21, color = 'black', fill = 'cyan') +
  geom_point(data = means_df, aes(y = med, group = method), 
             position = position_dodge(width = .75),
             size = 2, shape = 21, color = 'black', fill = 'white') +
  scale_fill_manual(values = hcl.colors(4)[c(1, 2, 4)], 
                    breaks = c('spp', 'fe', 'hab'),
                    labels = c('spp (eq wt)', 'spp (fv wt)', 'habitat')) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  coord_flip() +
  theme_minimal(base_family = "Roboto Condensed") +
  theme(axis.title = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.y = element_text(angle = 0, hjust = 0, face = 'bold')) +
  facet_grid(rows = vars(georgn_lbl), 
             scales = 'free_y', space = 'free_y')

ggsave(here('figs/ldc_chi_plot.png'), height = 3.5, width = 6, dpi = 300)

knitr::include_graphics(here('figs/ldc_chi_plot.png'))
```

```{r}
means_df <- eez_chi_df %>%
  group_by(georgn_lbl, dev, method) %>%
  summarize(mean = mean(chi), med = median(chi))

x <- ggplot(eez_chi_df, aes(x = dev, y = chi, fill = method)) +
  geom_hline(yintercept = 100, color = 'black', size = 2) +
  geom_boxplot(width = .6, position = position_dodge(width = .75),
               outlier.shape = NA, color = 'black', size = .25) +
  geom_point(data = means_df, aes(y = mean, group = method), 
             position = position_dodge(width = .75),
             size = 2, shape = 21, color = 'black', fill = 'cyan') +
  geom_point(data = means_df, aes(y = med, group = method), 
             position = position_dodge(width = .75),
             size = 2, shape = 21, color = 'black', fill = 'white') +
  scale_fill_manual(values = hcl.colors(4)[c(1, 2, 4)], 
                    breaks = c('spp', 'fe', 'hab'),
                    labels = c('spp (eq wt)', 'spp (fv wt)', 'habitat')) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  coord_flip() +
  theme_minimal(base_family = "Roboto Condensed") +
  theme(axis.title = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.y = element_text(angle = 0, hjust = 0, face = 'bold')) +
  facet_grid(rows = vars(georgn_lbl), 
             scales = 'free_y', space = 'free_y')

ggsave(here('figs/dev_chi_plot.png'), height = 8, width = 6, dpi = 300)

knitr::include_graphics(here('figs/dev_chi_plot.png'))

```
