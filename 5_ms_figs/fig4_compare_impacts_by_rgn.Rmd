---
title: "Compare cumulative impact across regions and methods"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: 'https://raw.githubusercontent.com/oharac/src/master/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 4, fig.width = 7)

library(terra)
library(oharac)
library(data.table)
library(tidyverse)
library(cowplot)
library(here)
source(here('common_fxns.R'))

```

# Summary

Examine distribution of impacts within regions (EEZ, MEOW, etc)

# Methods

Cumulative impact as the starting point; then perhaps break out by climate, land-based, ocean-based, and fishing stressors.  

## Load cumulative impact rasters

Build up an analysis dataframe including all three CHI maps.  Include additional layers to facilitate examination of impacts by coastal (i.e., neritic) vs. open ocean, as well as by EEZ and MEOW.  Include a layer of species richness to drop any instances where species count falls below some threshold, to ensure impact scores are based on a reasonable number of species (e.g., 20 spp).

```{r build chi dataframe}
chi_fs <- list.files(here('_output/cumulative_impact_maps'), pattern = 'chi_.+.tif',
                     full.names = TRUE)
chi_fs <- chi_fs[!str_detect(chi_fs, 'funct_entity_group')]

lyr_names <- basename(chi_fs) %>% str_remove('.tif') %>%
  str_replace('(chi_)?species(_group_chi)?', 'chi_spp') %>%
  str_replace('(chi_)?habitat(_group_chi)?', 'chi_hab')
chi_stack_all <- rast(chi_fs) %>%
  setNames(lyr_names)

chi_stack <- chi_stack_all[[str_detect(names(chi_stack_all), '^chi_[a-z]+$')]]
chi_cc_stack <- chi_stack_all[[str_detect(names(chi_stack_all), '_climate')]]
chi_noncc_stack_hab <- chi_stack_all[[str_detect(names(chi_stack_all), 'chi_hab_(f|o|l)')]] %>%
  sum(na.rm = TRUE) %>%
  setNames('chi_hab_noncc')
chi_noncc_stack_fe  <- chi_stack_all[[str_detect(names(chi_stack_all), 'chi_spp_(f|o|l)')]] %>%
  sum(na.rm = TRUE) %>%
  setNames('chi_spp_noncc')

nspp_r <- rast(here('_output/nspp_maps/species_richness.tif')) %>%
  setNames('nspp')
coastal_r <- rast(here('_spatial/bathy_mol_neritic.tif')) %>%
  setNames('coastal')
eez_r <- rast(here('_spatial/eez_mol.tif')) %>%
  setNames('eez')
meow_r <- rast(here('_spatial/meow_rgns_mol.tif')) %>%
  setNames('meow')

chi_df <- data.frame(values(chi_stack),
                     values(chi_cc_stack),
                     values(chi_noncc_stack_hab),
                     values(chi_noncc_stack_fe),
                     values(nspp_r),
                     values(coastal_r),
                     values(eez_r),
                     values(meow_r)) %>%
  mutate(cell_id = 1:n(),
         coastal = ifelse(!is.na(coastal), 'neritic', 'oceanic')) %>%
  ### note this also filters out cells where nspp is NA:
  filter(nspp >= 20)
```

## Examine impacts by ecoregion

```{r set up impacts by MEOW province and realm}
meow_prov_df <- foreign::read.dbf(here('_spatial/meow_rgns/meow_rgns.dbf')) %>%
  janitor::clean_names() %>%
  arrange(prov_code) %>%
  mutate(realm_lbl = str_replace(realm, 'Temperate', 'Temp'),
         realm_lbl = str_replace(realm_lbl, 'Tropical', 'Trop'),
         realm_lbl = str_replace(realm_lbl, 'Northern', 'N'),
         realm_lbl = str_replace(realm_lbl, 'Western', 'W'),
         realm_lbl = str_replace(realm_lbl, 'Eastern', 'E'),
         realm_lbl = str_replace(realm_lbl, 'South(ern)?', 'S'),
         realm_lbl = str_replace(realm_lbl, 'Central', 'C'),
         realm_lbl = str_replace(realm_lbl, 'Atlantic', 'Atl'),
         realm_lbl = str_replace(realm_lbl, 'Pacific', 'Pac'),
         realm_lbl = str_replace(realm_lbl, 'Africa', 'Afr'),
         realm_lbl = str_replace(realm_lbl, 'America', 'Amer'),
         realm_lbl = str_replace(realm_lbl, 'Australasia', 'Aus'),
         realm_lbl = fct_inorder(realm_lbl)) %>%
  mutate(prov_lbl = str_replace(province, 'Temperate', 'Temp'),
         prov_lbl = str_replace(prov_lbl, 'Tropical', 'Trop'),
         prov_lbl = str_replace(prov_lbl, 'North(ern)?', 'N'),
         prov_lbl = str_replace(prov_lbl, '(W|w)est(ern)?', 'W'),
         prov_lbl = str_replace(prov_lbl, '(E|e)ast(ern)?(?!er)', 'E'),
         prov_lbl = str_replace(prov_lbl, 'South(ern)?', 'S'),
         prov_lbl = str_replace(prov_lbl, 'Islands', 'Is'),
         prov_lbl = str_replace(prov_lbl, ', | and ', '/'),
         # prov_lbl = str_replace(prov_lbl, 'Central', 'C'),
         # prov_lbl = str_replace(prov_lbl, 'Atlantic', 'Atl'),
         # prov_lbl = str_replace(prov_lbl, 'Pacific', 'Pac'),
         # prov_lbl = str_replace(prov_lbl, 'Africa', 'Afr'),
         # prov_lbl = str_replace(prov_lbl, 'America', 'Amer'),
         # prov_lbl = str_replace(prov_lbl, 'Australasia', 'Aus'),
         prov_lbl = fct_inorder(prov_lbl))

meow_prov_chi_df_unordered <- chi_df %>%
  left_join(meow_prov_df, by = c('meow' = 'eco_code_x')) %>%
  mutate(chi_spp          = ntile(chi_spp, n = 1000) / 10,
         chi_hab         = ntile(chi_hab, n = 1000) / 10,
         chi_spp_climate  = ntile(chi_spp_climate, n = 1000) / 10,
         chi_hab_climate = ntile(chi_hab_climate, n = 1000) / 10,
         chi_spp_noncc    = ntile(chi_spp_noncc, n = 1000) / 10,
         chi_hab_noncc   = ntile(chi_hab_noncc, n = 1000) / 10) %>%
  select(starts_with('chi_'), cell_id, coastal, prov_lbl, realm_lbl) %>%
  filter(!is.na(prov_lbl)) %>%
  pivot_longer(names_to = 'method', values_to = 'chi', 
               starts_with('chi')) %>%
  mutate(method_zone = paste(method, coastal, sep = '_'))

### Within each realm, order by highest to lowest 
### mean overall coastal FE impact
prov_order <- meow_prov_chi_df_unordered %>%
  filter(method_zone == 'chi_spp_neritic') %>%
  group_by(prov_lbl, realm_lbl) %>%
  summarize(med_chi = median(chi)) %>%
  ungroup() %>%
  arrange(realm_lbl, med_chi) %>%
  pull(prov_lbl)

meow_prov_chi_df <- meow_prov_chi_df_unordered %>%
  mutate(prov_lbl = factor(prov_lbl, levels = prov_order))

prov_means_df <- meow_prov_chi_df %>%
  group_by(realm_lbl, prov_lbl, method) %>%
  summarize(mean = mean(chi, na.rm = TRUE), med = median(chi, na.rm = TRUE))
```

### Plot by realm

```{r figure 4 meow by realm, fig.height = 8}
### Order realms by latitude - in original order

global_chi_df <- meow_prov_chi_df %>%
  mutate(realm_lbl = 'Global')

meow_realm_chi_df <- global_chi_df %>%
  bind_rows(meow_prov_chi_df) %>%
  select(-prov_lbl) %>%
  mutate(realm_lbl = fct_inorder(realm_lbl) %>% fct_rev())

```

``` {r plot for overall chi by realm}
plot_realm <- function(df, methods, x_label) {
  
  div_clr <- c('#e66101', '#5e3c99')
  fills <- c('white', 'white', div_clr[2], div_clr[1]) ### fills for methods
  clrs  <- c(div_clr[2], div_clr[1], div_clr[2], div_clr[1]) ### colors for methods
  # fills <- c('grey90', 'grey40', 'grey70', 'black') ### fills for methods
  # clrs  <- c('black',  'grey40', 'grey70', 'black') ### colors for methods
  
  lbls <- c(spp_n  = latex2exp::TeX('$Spp_c$'),
            hab_n = latex2exp::TeX('$Hab_c$'),
            spp_o  = latex2exp::TeX('$Spp_o$'),
            hab_o = latex2exp::TeX('$Hab_o$')) %>%
    rev()
  lvls <- names(lbls)

  plot_df <- df %>% 
    filter(method %in% methods) %>%
    mutate(method_zone = str_remove_all(method_zone, 'chi_|_climate|_noncc|eritic|ceanic')) %>%
    mutate(method_zone = factor(method_zone, levels = lvls))
  means_df <- plot_df %>%
    group_by(realm_lbl, method_zone) %>%
    summarize(mean = mean(chi, na.rm = TRUE), 
              med  = median(chi, na.rm = TRUE))
  
  
  p <- ggplot(plot_df, 
              aes(y = realm_lbl, x = chi, 
                  fill = method_zone, color = method_zone)) +
    # geom_hline(yintercept = 100, color = 'black', size = 2) +
    geom_boxplot(width = .4, position = position_dodge(width = .75),
                 outlier.shape = NA, 
                 size = .25) +
    geom_point(data = means_df,
               aes(x = med, group = method_zone),
               position = position_dodge(width = .75),
               size = 1, shape = 21, color = 'black', fill = 'black') +
    scale_fill_manual(values = fills, 
                      breaks = lvls, 
                      labels = lbls,
                      guide = guide_legend(reverse = TRUE,
                                           label.position = 'left')) +
    scale_color_manual(values = clrs, 
                       breaks = lvls, 
                       labels = lbls,
                       guide = guide_legend(reverse = TRUE,
                                            label.position = 'left') ) +
    scale_x_continuous(limits = c(0, 100), expand = c(0, 0)) +
    theme_minimal() +
    labs(x = x_label) +
    theme(text = element_text(family = 'Arial'),
          axis.title.y = element_blank(),
          axis.title.x = element_text(size = 8),
          axis.text  = element_text(size = 8),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.minor.x = element_blank(),
          legend.text  = element_text(face = 'bold', size = 8),
          legend.key.size = unit(.25, 'cm'),
          legend.title = element_blank())
  
  return(p)
}

# lbls <- unname(latex2exp::TeX(c("$I_{FE}^C$", "$I_{Hab}^C$")))
panel_a <- plot_realm(df = meow_realm_chi_df, 
                      methods = c('chi_spp', 'chi_hab'), 
                      x_label = 'Cumulative (%ile)')
panel_b <- plot_realm(df = meow_realm_chi_df, 
                      methods = c('chi_spp_climate', 'chi_hab_climate'), 
                      x_label = 'Climate (%ile)')
panel_c <- plot_realm(df = meow_realm_chi_df, 
                      methods = c('chi_spp_noncc', 'chi_hab_noncc'), 
                      x_label = 'Non-climate (%ile)')

# panel_a; panel_b; panel_c
```

#### assemble into three panel figure

```{r assemble figure 4}
panel_a_plot <- panel_a + theme(legend.position = 'none')
panel_b_plot <- panel_b + 
  theme(legend.position = 'none',
        axis.text.y = element_blank())
panel_c_plot <- panel_c + 
  theme(legend.position = 'none',
        axis.text.y = element_blank())
panel_a_lgd  <- get_legend(panel_a)

### parameterize legends for easier changing of label positions:
lgd_a_xy <- c(x = .90, y = .30, h = .40, w = .10)

fig4 <- ggdraw() +
  ### draw panels:
  draw_plot(panel_a_plot,  x = 0.00, y = 0.00, height = 1.00, width = 0.37) +
  draw_plot(panel_b_plot,  x = 0.37, y = 0.00, height = 1.00, width = 0.27) +
  draw_plot(panel_c_plot,  x = 0.64, y = 0.00, height = 1.00, width = 0.27) +
  ### draw legends:
  draw_plot(panel_a_lgd, x = lgd_a_xy['x'], y = lgd_a_xy['y'], 
            height = lgd_a_xy['h'], width = lgd_a_xy['w']) +
  ### Panel labels:
  draw_label('A.', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 12, fontfamily = 'Arial', fontface = 'bold') +
  draw_label('B.', x = 0.365, y = .99, hjust = 0, vjust = 1, 
             size = 12, fontfamily = 'Arial', fontface = 'bold') +
  draw_label('C.', x = 0.635, y = .99, hjust = 0, vjust = 1, 
             size = 12, fontfamily = 'Arial', fontface = 'bold')


fig4_file <- here('5_ms_figs/fig4_impacts_by_ecoregion.png')
ggsave(fig4_file, width = 6.25, height = 5.2, units = 'in', dpi = 300)
ggsave(fig4_file %>% str_replace('.png$', '.tif'), width = 6.25, height = 5.2, units = 'in', dpi = 300)

knitr::include_graphics(fig4_file)
```

### Plot by province (SI)

``` {r plot for overall chi by province}
plot_prov <- function(df, methods, x_label, strips) {

  div_clr <- c('#e66101', '#5e3c99')
  fills <- c('white', 'white', div_clr[2], div_clr[1]) ### fills for methods
  clrs  <- c(div_clr[2], div_clr[1], div_clr[2], div_clr[1]) ### colors for methods
  # fills <- c('grey90', 'grey40', 'grey70', 'black') ### fills for methods
  # clrs  <- c('black',  'grey40', 'grey70', 'black') ### colors for methods

  lbls <- c(spp_n = latex2exp::TeX('$Spp_c$'),
            hab_n = latex2exp::TeX('$Hab_c$'),
            spp_o = latex2exp::TeX('$Spp_o$'),
            hab_o = latex2exp::TeX('$Hab_o$')) %>%
    rev()
  lvls <- names(lbls)

  plot_df <- df %>% 
    filter(method %in% methods) %>%
    mutate(method_zone = str_remove_all(method_zone, 'chi_|_climate|_noncc|eritic|ceanic')) %>%
    mutate(method_zone = factor(method_zone, levels = lvls))
  means_df <- plot_df %>%
    group_by(realm_lbl, prov_lbl, method_zone) %>%
    summarize(mean = mean(chi, na.rm = TRUE), 
              med  = median(chi, na.rm = TRUE))
  
  p <- ggplot(plot_df, 
              aes(y = prov_lbl, x = chi, fill = method_zone, color = method_zone))
  if(strips) {
    p <- p + geom_vline(xintercept = 100, color = 'black', size = 2)
  }
  
  p <- p +
    geom_boxplot(width = .4, position = position_dodge(width = .75),
                 outlier.shape = NA, size = .25) +
    geom_point(data = means_df,
               aes(x = med, group = method_zone), 
               position = position_dodge(width = .75),
               size = 1, shape = 21, color = 'black', fill = 'black') +
    scale_fill_manual(values = fills, 
                      breaks = lvls, 
                      labels = lbls,
                      guide = guide_legend(reverse = TRUE,
                                           label.position = 'left')) +
    scale_color_manual(values = clrs, 
                       breaks = lvls, 
                       labels = lbls,
                       guide = guide_legend(reverse = TRUE,
                                            label.position = 'left')) +
    scale_x_continuous(limits = c(0, 100), expand = c(0, 0)) +
    theme_minimal() +
    theme(axis.title.y = element_blank(),
          axis.title.x = element_text(face = 'bold', size = 8),
          axis.text  = element_text(size = 8),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.text  = element_text(face = 'bold', size = 8),
          legend.key.size = unit(.25, 'cm'),
          legend.title = element_blank()) +
    facet_grid(rows = vars(realm_lbl), 
               scales = 'free_y', space = 'free_y') +
    labs(x = x_label)
  
  if(strips) {
    p <- p +
      theme(strip.text.y = element_text(angle = 90, hjust = .5, 
                                        face = 'bold', size = 8))
  } else {
    p <- p + 
      theme(strip.background = element_blank(),
            strip.text = element_blank())
    }
  
  return(p)
}

panel_a_SI <- plot_prov(df = meow_prov_chi_df, 
                        methods = c('chi_spp', 'chi_hab'), 
                        x_label = 'Cumulative (%ile)',
                        strips = FALSE)

panel_b_SI <- plot_prov(df = meow_prov_chi_df, 
                        methods = c('chi_spp_climate', 'chi_hab_climate'), 
                        x_label = 'Climate (%ile)',
                        strips = FALSE)

panel_c_SI <- plot_prov(df = meow_prov_chi_df, 
                        methods = c('chi_spp_noncc', 'chi_hab_noncc'), 
                        x_label = 'Non-climate (%ile)',
                        strips = TRUE)

```

```{r assemble figure SI}
panel_a_SI_plot <- panel_a_SI + 
  theme(legend.position = 'none')
panel_b_SI_plot <- panel_b_SI + 
  theme(legend.position = 'none',
        axis.text.y = element_blank())
panel_c_SI_plot <- panel_c_SI + 
  theme(legend.position = 'none',
        axis.text.y = element_blank())

panel_a_SI_lgd  <- get_legend(panel_a_SI)

### parameterize legends for easier changing of label positions:
lgd_a_xy <- c(x = .94, y = .30, h = .40, w = .06)

fig_SI <- ggdraw() +
  ### draw panels:
  draw_plot(panel_a_SI_plot,  x = 0.00, y = 0.00, height = 1.00, width = 0.44) +
  draw_plot(panel_b_SI_plot,  x = 0.44, y = 0.00, height = 1.00, width = 0.24) +
  draw_plot(panel_c_SI_plot,  x = 0.68, y = 0.00, height = 1.00, width = 0.27) +
  ### draw legends:
  draw_plot(panel_a_SI_lgd, x = lgd_a_xy['x'], y = lgd_a_xy['y'], 
            height = lgd_a_xy['h'], width = lgd_a_xy['w']) +
  ### Panel labels:
  draw_label('A.', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 9, fontfamily = 'Arial', fontface = 'bold') +
  draw_label('B.', x = 0.445, y = .99, hjust = .5, vjust = 1, 
             size = 9, fontfamily = 'Arial', fontface = 'bold') +
  draw_label('C.', x = 0.685, y = .99, hjust = .5, vjust = 1, 
             size = 9, fontfamily = 'Arial', fontface = 'bold')


figSI_file <- here('5_ms_figs/figS5_impacts_by_ecoregion_province.png')
ggsave(figSI_file, width = 18, height = 26.67, units = 'cm', dpi = 300)

knitr::include_graphics(figSI_file)
```
