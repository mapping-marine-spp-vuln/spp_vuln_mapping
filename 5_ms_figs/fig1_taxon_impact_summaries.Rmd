---
title: "Figure 1: taxon/species impact summaries"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 4, fig.width = 7)

library(oharac)
library(tidyverse)
library(cowplot)
library(showtext) ### for custom fonts
library(here)
source(here('common_fxns.R'))

font_add(family = 'bentonbold', 
         regular = file.path('~/fonts', 
                             'BentonSans Condensed Bold', 
                             'BentonSans Condensed Bold.otf'))
font_add(family = 'benton', 
         regular = file.path('~/fonts', 
                             'BentonSans Condensed Book', 
                             'BentonSans Condensed Book.otf'))
showtext_auto()
```

# Summary

This figure shows distribution of mean impacts (climate and non-climate) across species within taxonomic groups

# Data

Results from scripts in folder `2_process_spp_vuln_and_impacts`

# Methods

Read in the species impact summaries; summarize to climate and non-climate impacts, attach taxonomic groups, create boxplots - one for climate stressors, one for non-climate.  This summarization must be done on the server, as the individual species stressor files are stored there.  This should be saved in the Github repo for use on the Mac, to generate a well-formatted figure.

```{r}
spp_imp_sum_file <- here('5_ms_figs/int/fig1_spp_summary.csv')
if(!file.exists(spp_imp_sum_file)) { ### unlink(spp_imp_sum_file)
  spp_imp_fs <- list.files(here_anx('impacts_by_species'), 
                           pattern = '^impacts_.+.csv', full.names = TRUE)
  
  spp_imp_raw_df <- parallel::mclapply(spp_imp_fs, mc.cores = 40,
                                       data.table::fread) %>%
    setNames(basename(spp_imp_fs)) %>%
    data.table::rbindlist(idcol = 'f') %>%
    rename(vuln = vulnerability)
  
  spp_imp_scores <- spp_imp_raw_df %>%
    filter(vuln %in% c('stressor_group', 'cumulative')) %>%
    filter(range == 'full') %>%
    filter(range_km2 > 0) %>%
    select(f, stressor, impact_tot, impact_npp_tot, range_km2) %>%
    mutate(stressor = case_when(stressor =='cumulative' ~ 'all',
                                stressor != 'climate' ~ 'non-climate', 
                                TRUE ~ stressor)) %>%
    group_by(f, stressor) %>%
    summarize(mean_imp = sum(impact_tot/range_km2), 
              mean_imp_npp = sum(impact_npp_tot/range_km2),
              .groups = 'drop') %>%
    mutate(iucn_sid = str_extract(f, '[0-9]+') %>% as.integer(),
           species = ifelse(!str_detect(f, '_am_'), NA,
                            str_remove_all(f, 'impacts_am_|.csv') %>% 
                              str_replace_all('_', ' '))) %>%
    select(-f)
  
  write_csv(spp_imp_scores, spp_imp_sum_file)
}

spp_taxa_sum_file <- here('5_ms_figs/int/fig1_spp_taxa.csv')
### unlink(spp_taxa_sum_file)
if(!file.exists(spp_taxa_sum_file)) {
  spp_taxa <- assemble_spp_info_df() %>%
    select(species, iucn_sid, taxon) %>%
    distinct() %>%
    mutate(taxon = str_replace(taxon, 'crustacea_arthropods', 'crustaceans'),
           taxon = str_replace(taxon, 'reptiles', 'marine reptiles'),
           taxon = str_replace(taxon, '_', ' '),
           taxon = str_to_sentence(taxon))
  write_csv(spp_taxa, spp_taxa_sum_file)
}

spp_taxa <- read_csv(spp_taxa_sum_file)

spp_imp_scores <- read_csv(spp_imp_sum_file)

```

``` {r}
taxa_imp_scores <- spp_imp_scores %>%
  filter(!is.na(iucn_sid)) %>%
  left_join(spp_taxa %>% rename(sciname = species), by = 'iucn_sid') %>%
  bind_rows(spp_imp_scores %>%
              filter(is.na(iucn_sid)) %>%
              left_join(spp_taxa %>% select(-iucn_sid), by = 'species')) %>%
  gather(type, imp, mean_imp, mean_imp_npp) %>%
  mutate(type = ifelse(type == 'mean_imp', 'Unweighted mean', 'NPP-weighted mean')) %>%
  mutate(species = ifelse(is.na(species), sciname, species)) %>%
  select(-sciname) %>%
  distinct()
  
unwt_df <- taxa_imp_scores %>%
  filter(type == 'Unweighted mean') %>%
  pivot_wider(names_from = 'stressor', values_from = 'imp')
nppwt_df <- taxa_imp_scores %>%
  filter(type == 'NPP-weighted mean') %>%
  pivot_wider(names_from = 'stressor', values_from = 'imp')

taxa_pcts <- taxa_imp_scores %>%
  select(taxon, species, iucn_sid) %>%
  distinct() %>%
  group_by(taxon) %>%
  summarize(pct_overall = round(n() / nrow(.), 3))

nppwt_top1pct <- nppwt_df %>%
  arrange(desc(all)) %>%
  head(as.integer(nrow(.) * .01))
nppwt_top1pct %>%
  group_by(taxon) %>%
  summarize(n = n(),
            npp_pct = n() / nrow(.)) %>%
  left_join(taxa_pcts, by = 'taxon') %>%
  mutate(repr = npp_pct / pct_overall)

nppwt_btm1pct <- nppwt_df %>%
  arrange(all) %>%
  head(as.integer(nrow(.) * .01))
nppwt_btm1pct %>%
  group_by(taxon) %>%
  summarize(n = n(),
            npp_pct = n() / nrow(.)) %>%
  left_join(taxa_pcts, by = 'taxon') %>%
  mutate(repr = npp_pct / pct_overall)

```


``` {r combine for figure}

### create an "all" taxa that just plops the data frame on top of itself
all_tx_imp_scores <- taxa_imp_scores %>%
  mutate(taxon = 'All') %>%
  bind_rows(taxa_imp_scores)

tx_order <- all_tx_imp_scores %>%
  filter(type == 'NPP-weighted mean') %>%
  filter(stressor == 'all') %>%
  group_by(taxon) %>%
  summarize(m = mean(imp)) %>%
  arrange(m) %>%
  mutate(taxon = fct_inorder(taxon),
         taxon = fct_relevel(taxon, 'All', after = Inf)) %>%
  pull(taxon) %>% levels()

tx_imp_df <- all_tx_imp_scores %>%
  mutate(taxon = factor(taxon, levels = tx_order),
         type = factor(type, levels = c('NPP-weighted mean', 'Unweighted mean')))

tx_avg_med <- tx_imp_df %>%
  group_by(taxon, type, stressor) %>%
  summarize(avg = mean(imp),
            med = median(imp),
            .groups = 'drop')

tx_spp_counts <- all_tx_imp_scores %>%
  select(iucn_sid, species, taxon) %>%
  distinct() %>%
  group_by(taxon) %>%
  summarize(n_spp = paste0('n = ', n()))

```

## Create panels

One panel each for total stressors (CHI), climate stressors,  non-climate.

### Panel A: total stressors

```{r}
all_imp <- tx_imp_df %>%
  filter(stressor == 'all')
all_avg_med <- tx_avg_med %>%
  filter(stressor == 'all')

# vals <- hcl.colors(4)[c(1, 2, 4)][c(2, 3)]
vals <- c('grey70', 'black')
brks <- c('Unweighted mean', 'NPP-weighted mean')
lbls <- c('Unweighted mean', 'NPP-weighted mean')

panel_a <- ggplot(all_imp, aes(x = imp, y = taxon)) +
  geom_boxplot(aes(color = type, fill = type, color = type),
               width = .3, position = position_dodge(width = -.6),
               size = .25,
               outlier.color = 'grey80', outlier.size = .02) +
  geom_vline(xintercept = 0, color = 'black') +
  geom_point(data = all_avg_med, aes(x = med, group = type),
             position = position_dodge(width = -.6),
             shape = 21, color = 'black', fill = 'black', size = 1.5,
             show.legend = FALSE) +
  geom_point(data = all_avg_med, aes(x = avg, group = type),
             position = position_dodge(width = -.6),
             shape = 21, color = 'black', fill = 'white', size = 1.5,
             show.legend = FALSE) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 1), 
                     breaks = seq(0, 1, .2)) +
  scale_fill_manual(values = vals, breaks = brks, labels = lbls) +
  scale_color_manual(values = vals, breaks = brks, labels = lbls) +
  theme_ohara() +
  theme(panel.background = element_blank(),
        axis.text.y = element_text(family = 'bentonbold', size = 7),
        axis.title.y = element_blank(),
        axis.text.x = element_text(family = 'benton', size = 7),
        axis.title.x = element_text(family = 'bentonbold', size = 7),
        legend.key.size = unit(.25, 'cm'),
        legend.title = element_blank(),
        legend.text = element_text(family = 'benton', size = 7),
        legend.position = 'bottom',
        legend.margin = margin(1, 1, 1, 1, 'pt'),
        legend.background = element_rect(fill = 'white', color = 'grey70', size = .1)) +
  labs(x = 'Mean cumulative impact')
```


### Panel B: climate stressors

```{r}
cc_imp <- tx_imp_df %>%
  filter(stressor == 'climate')
cc_avg_med <- tx_avg_med %>%
  filter(stressor == 'climate')

panel_b <- ggplot(cc_imp, aes(x = imp, y = taxon)) +
  geom_boxplot(aes(color = type, fill = type, color = type),
               width = .3, position = position_dodge(width = -.6),
               size = .25,
               outlier.color = 'grey80', outlier.size = .02) +
  geom_vline(xintercept = 0, color = 'black') +
  geom_point(data = cc_avg_med, aes(x = med, group = type),
             position = position_dodge(width = -.6),
             shape = 21, color = 'black', fill = 'black', size = 1.5,
             show.legend = FALSE) +
  geom_point(data = cc_avg_med, aes(x = avg, group = type),
             position = position_dodge(width = -.6),
             shape = 21, color = 'black', fill = 'white', size = 1.5,
             show.legend = FALSE) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 1), breaks = seq(0, 1, .2)) +
  scale_fill_manual(values = vals, breaks = brks, labels = lbls) +
  scale_color_manual(values = vals, breaks = brks, labels = lbls) +
  theme_ohara() +
  theme(panel.background = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(family = 'benton', size = 7),
        axis.title.x = element_text(family = 'bentonbold', size = 7)) +
  labs(x = 'Mean climate impact')
```

### Panel C: Non-climate stressors

```{r}
noncc_imp <- tx_imp_df %>%
  filter(stressor == 'non-climate')
noncc_avg_med <- tx_avg_med %>%
  filter(stressor == 'non-climate')

panel_c <- ggplot(noncc_imp, aes(x = imp, y = taxon)) +
  geom_boxplot(aes(color = type, fill = type, color = type),
               width = .3, position = position_dodge(width = -.6), size = .25,
               outlier.color = 'grey80', outlier.size = .02) +
  geom_vline(xintercept = 0, color = 'black') +
  geom_point(data = noncc_avg_med, aes(x = med, group = type),
             position = position_dodge(width = -.6),
             shape = 21, color = 'black', fill = 'black', size = 1.5,
             show.legend = FALSE) +
  geom_point(data = noncc_avg_med, aes(x = avg, group = type),
             position = position_dodge(width = -.6),
             shape = 21, color = 'black', fill = 'white', size = 1.5,
             show.legend = FALSE) +
  annotate('rect',
           xmin = .30, xmax = .40, ymin = 0.5, ymax = 13.5,
           fill = 'white', color = 'white') +
  geom_text(data = tx_spp_counts, aes(label = n_spp),
            x = .305, hjust = 0, color = 'black', fill = NA, 
            family = 'benton', size = 1.9) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, .40), breaks = c(0, .1, .2, .3)) +
  scale_fill_manual(values = vals, breaks = brks, labels = lbls) +
  scale_color_manual(values = vals, breaks = brks, labels = lbls) +
  theme_ohara() +
  theme(panel.background = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(family = 'benton', size = 7),
        axis.title.x = element_text(family = 'bentonbold', size = 7)) +
  labs(x = 'Mean non-climate impact')
```


## Assemble figure

```{r assemble figure}
fig1_file <- here('5_ms_figs/fig1_taxon_impact_summaries.png')
panel_a_plot <- panel_a + theme(legend.position = 'none')
panel_b_plot <- panel_b + theme(legend.position = 'none')
panel_c_plot <- panel_c + theme(legend.position = 'none')
panel_a_lgd  <- get_legend(panel_a)

### parameterize legends for easier changing of label positions:
lgd_a_xy <- c(x = .25, y = 0.01, h = .03, w = .50)

fig1 <- ggdraw() +
  ### draw panels:
  draw_plot(panel_a_plot,  x = 0.00, y = 0.03, height = .97, width = 0.415) +
  draw_plot(panel_b_plot,  x = 0.415, y = 0.03, height = .97, width = 0.255) +
  draw_plot(panel_c_plot,  x = 0.67, y = 0.03, height = .97, width = 0.33) +
  ### draw legends:
  draw_plot(panel_a_lgd, x = lgd_a_xy['x'], y = lgd_a_xy['y'], 
            height = lgd_a_xy['h'], width = lgd_a_xy['w']) +
  ### Panel labels:
  draw_label('A', x = 0.03, y = .99, hjust = 0, vjust = 1, 
             size = 10, fontfamily = 'bentonbold') +
  draw_label('B', x = 0.41, y = .99, hjust = 0, vjust = 1, 
             size = 10, fontfamily = 'bentonbold') +
  draw_label('C', x = 0.665, y = .99, hjust = 0, vjust = 1, 
             size = 10, fontfamily = 'bentonbold')

ggsave(fig1_file, width = 12, height = 8, units = 'cm', dpi = 300)

knitr::include_graphics(fig1_file)
```

