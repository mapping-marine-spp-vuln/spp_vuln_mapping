---
title: "Figure 6: Spp vs FE impacts statistically significant differences"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: 'https://raw.githubusercontent.com/oharac/src/master/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 4, fig.width = 7)

library(terra)
library(sf)
library(oharac)
library(data.table)
library(tidyverse)
library(biscale)  ### for bivariate legend
library(cowplot)
library(here)
source(here('common_fxns.R'))

```

# Summary

Create Fig. 3(?) for manuscript

# Data

Results from scripts in folder `2_process_spp_vuln_and_impacts`

# Methods

Read in the output rasters from the sensitivity analysis, showing number of stressors that are significantly different (higher, then lower) in each cell.  These rasters were originally created in script `4_analysis/5d_spp_vs_fv_sens_analysis_figs.Rmd`.

```{r}
ocean_map <- rast(here('_spatial/ocean_area_mol.tif'))
ocean_df <- as.data.frame(ocean_map, xy = TRUE)

land_sf <- read_sf(here('_spatial/ne_10m_land/ne_10m_land_no_casp.shp')) %>%
  st_transform(st_crs(ocean_map))

globe_bbox <- rbind(c(-180, -90), c(-180, 90), 
                      c(180, 90), c(180, -90), c(-180, -90)) 
globe_border <- st_polygon(list(globe_bbox)) %>%
  st_sfc(crs = 4326) %>%
  st_sf(data.frame(rgn = 'globe', geom = .)) %>%
  smoothr::densify(max_distance = 0.5) %>%
  st_transform(crs = crs(ocean_map))
```

## Maps of variation in impact from individual stressors

How many stressors have significant differences between FV and spp as species sets are randomized?  AND - do we want to just focus on areas where FV is significantly GREATER?

```{r make map of signif higher stressors by count}
sig_hi_count_f <- '../4_analysis/fe_vs_spp_sig_higher_n_stressors.tif'
sig_lo_count_f <- '../4_analysis/fe_vs_spp_sig_lower_n_stressors.tif'

sig_diff_r <- rast(c(sig_hi_count_f, sig_lo_count_f))

num_strs <- minmax(sig_diff_r) %>% max()

sig_hi_count_df <- sig_diff_r[[1]] %>%
  as.data.frame(xy = TRUE) %>%
  mutate(sum = ifelse(sum > 5, 5, sum),
         sumfct = factor(sum, levels = 1:num_strs))

sig_lo_count_df <- sig_diff_r[[2]] %>%
  as.data.frame(xy = TRUE) %>%
  mutate(sum = ifelse(sum > 5, 5, sum),
         sumfct = factor(sum, levels = 1:num_strs))

sig_diff_df <- ocean_df %>%
  left_join(sig_hi_count_df %>% select(x, y, sum_hi = sum)) %>%
  left_join(sig_lo_count_df %>% select(x, y, sum_lo = sum)) %>%
  mutate(diff = case_when(is.na(sum_hi) ~ sum_lo,
                          is.na(sum_lo) ~ sum_hi,
                          TRUE ~ sum_hi + sum_lo))

sig_diff_pct <- sig_diff_df %>%
  summarize(pct = sum(!is.na(diff)) / n())

# ggplot(sig_diff_df, aes(x, y, fill = diff)) + geom_raster() + coord_sf
```

Percent of ocean with at least 1 significantly different (higher OR lower) stressor: `r round(sig_diff_pct * 100, 2)`%

```{r prepare panel A}
panel_a <- ggplot() +
  ### background for NA cells:
  geom_raster(data = ocean_df, aes(x, y), fill = 'grey85') +
  ### plot data:
  geom_raster(data = sig_hi_count_df, aes(x, y, fill = sumfct)) +
  ### continents:
  geom_sf(data = land_sf,
          fill = 'grey96', color = NA, 
          size = .1) +
  geom_sf(data = globe_border,
          fill = NA, color = 'grey70', 
          size = .1) +
  scale_fill_viridis_d(guide = guide_legend(reverse = TRUE), breaks = 1:5, labels = c(1:4, '5+')) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank(),
        legend.key.size = unit(.35, 'cm'),
        legend.margin = margin(0, 0, 0, 0, unit = 'pt'),
        legend.text = element_text(size = 8, color = 'black', 
                                   hjust = 0, vjust = .5, angle = 0),
        legend.spacing.x = unit(0, 'cm'),
        legend.spacing.y = unit(0, 'cm'),
        legend.title = element_blank())

# panel_a
```

...or where FE CHI is significantly LOWER?

```{r prepare panel b}

panel_b <- ggplot() +
  ### background for NA cells:
  geom_raster(data = ocean_df, aes(x, y), fill = 'grey85') +
  ### plot data:
  geom_raster(data = sig_lo_count_df, aes(x, y, fill = sumfct), show.legend = FALSE) +
  ### continents:
  geom_sf(data = land_sf,
          fill = 'grey96', color = NA, 
          size = .1) +
  geom_sf(data = globe_border,
          fill = NA, color = 'grey70', 
          size = .1) +
  scale_fill_viridis_d() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank())

# panel_b
```

## Assemble figure

```{r gather pieces}
fig6_file <- here('5_ms_figs/fig6_comparing_fe_vs_spp_significance.png')
panel_a_map <- get_panel(panel_a)
panel_b_map <- get_panel(panel_b)
panel_lgd   <- get_legend(panel_a)
```

```{r}
plot_w <- 6.25; plot_h <- 2.9
### parameterize legends for easier changing of label positions:
lgd_xy <- c(x = .30, y = 0.06, h = .22, w = .1)
p_w <- 0.55
p_h <- p_w / 2 * plot_w/plot_h ### last normalizes aspect ratio
a <- c(x = 0.00, y = 0.39)
b <- c(x = 1-p_w, y = 0.0)

x <- ggdraw() +
  ### draw panels:
  draw_plot(panel_a_map,  x = a['x'], y = a['y'], height = p_h, width = p_w) +
  draw_plot(panel_b_map,  x = b['x'], y = b['y'], height = p_h, width = p_w) +
  ### draw legend:
  draw_plot(panel_lgd, x = lgd_xy['x'], y = lgd_xy['y'], 
            height = lgd_xy['h'], width = lgd_xy['w']) +
  ### Panel labels:
  draw_label('A.', x = a['x'], y = 0.95,  hjust = 0, vjust = 1, 
             size = 12, fontfamily = 'Arial', fontface = 'bold') +
  draw_label('B.', x = 1,  y = b['y'] + p_h -.05,  hjust = 1, vjust = 1, 
             size = 12, fontfamily = 'Arial', fontface = 'bold') +
  ### legend label:
  draw_label('Stressor count', x = lgd_xy['x'], y = lgd_xy['y'] + lgd_xy['h']/2,
             hjust = 1, vjust = 0.5,
             size = 10, fontfamily = 'Arial', fontface = 'bold')

ggsave(fig6_file, height = plot_h, width = plot_w, units = 'in', dpi = 300)
ggsave(fig6_file %>% str_replace('.png$', '.tif'), height = plot_h, width = plot_w, units = 'in', dpi = 300)

knitr::include_graphics(fig6_file)
```

