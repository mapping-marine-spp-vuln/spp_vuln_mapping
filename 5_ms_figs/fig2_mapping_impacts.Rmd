---
title: "Figure 2: Maps of spp and FE CHI"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 4, fig.width = 7)

library(terra)
library(sf)
library(oharac)
library(data.table)
library(tidyverse)
library(biscale)  ### for bivariate legend
library(cowplot)
library(here)
source(here('common_fxns.R'))

```

# Summary

Create Fig. 1 for manuscript

# Data

Results from scripts in folder `2_process_spp_vuln_and_impacts`

# Methods

Read in the output rasters for species-level impacts (unweighted); reclassify based on quartile/quintile.  Fig. 1A is bivariate plot of climate vs. non-climate stressors for equal weighted species average, Fig. 1B is bivariate plot of climate vs. non-climate stressors for FV-weighted FE average; Fig. 1C and 1D are %difference plots for each category.

NOTE: dropping cells with fewer than 20 species, mostly in the Arctic, a few in Antarctic.

```{r}
ocean_map <- rast(here('_spatial/ocean_area_mol.tif'))
ocean_df <- as.data.frame(ocean_map, xy = TRUE)

land_sf <- read_sf(here('_spatial/ne_10m_land/ne_10m_land_no_casp.shp')) %>%
  st_transform(st_crs(ocean_map))

nspp_mask <- rast(here('_output/nspp_maps/species_richness.tif'))
nspp_vals <- values(nspp_mask)
values(nspp_mask)[nspp_vals < 20] <- NA

chi_gps_spp <- list.files(here('_output/cumulative_impact_maps'),
                         pattern = 'species_group_chi',
                         full.names = TRUE)
chi_gps_fe <- list.files(here('_output/cumulative_impact_maps'),
                         pattern = 'funct_entity_group_chi',
                         full.names = TRUE)
climate_map_spp     <- rast(chi_gps_spp[1]) %>%
  mask(nspp_mask)
climate_map_fe     <- rast(chi_gps_fe[1]) %>%
  mask(nspp_mask)

nonclimate_map_spp  <- rast(chi_gps_spp[2:4]) %>%
  sum(na.rm = TRUE) %>%
  mask(nspp_mask)

nonclimate_map_fe  <- rast(chi_gps_fe[2:4]) %>%
  sum(na.rm = TRUE) %>%
  mask(nspp_mask)
```

### Reclassify

Reclassify values using `ntile` to get quartile values:
```{r reclass eq weight}
cc_qtile_spp <- noncc_qtile_spp <- climate_map_spp ### initialize two new maps
values(cc_qtile_spp) <- ntile(values(climate_map_spp), 4)
values(noncc_qtile_spp) <- ntile(values(nonclimate_map_spp), 4)
# plot(cc_qtile_spp, axes = FALSE, 
#      main = 'Climate impact quintile, spp avg', col = hcl.colors(4))
# plot(noncc_qtile_spp, axes = FALSE, 
#      main = 'Non-climate impact quintile, spp avg', col = hcl.colors(4))
```

```{r reclass fv weight}
cc_qtile_fe <- noncc_qtile_fe <- climate_map_fe ### initialize two new maps
values(cc_qtile_fe) <- ntile(values(climate_map_fe), 4)
values(noncc_qtile_fe) <- ntile(values(nonclimate_map_fe), 4)
# plot(cc_qtile_fe, axes = FALSE, 
#      main = 'Climate impact quintile, fv wt avg', col = hcl.colors(4))
# plot(noncc_qtile_fe, axes = FALSE, 
#      main = 'Non-climate impact quintile, fv wt avg', col = hcl.colors(4))
```

## Create panels

### Set up palettes

For the bivariate color plot, one axis of colors represents climate, the other represents non-climate; for corner values (max agreement and max disagreement), use diverging color palettes; for intermediate values use a light shading to indicate variation more subtly.

``` {r make biscale legend}
# div_clr <- c('#7b3294', '#008837', 'black')
# div_clr <- c('#a6611a', '#018571', 'black')
div_clr <- c('#e66101', '#5e3c99', 'black')
### Diverging palettes from colorbrewer2.org:
#7b3294     #a6611a     #e66101
#c2a5cf     #dfc27d     #fdb863
#f7f7f7     #f5f5f5     #f7f7f7
#a6dba0     #80cdc1     #b2abd2
#008837     #018571     #5e3c99

colors_df <- crossing(x = 1:4, y = 1:4) %>%
  mutate(bi_class = paste(x, y, sep = '-')) %>%
  mutate(bi_fill = case_when(bi_class == '1-1' ~ '#ffffdd',
                             bi_class %in% c('1-2', '2-1') ~ '#eeeeff',
                             bi_class %in% c('1-3', '3-1', '2-2') ~ '#ddddee',
                             bi_class %in% c('2-3', '3-2') ~ '#ccccdd',
                             bi_class %in% c('3-3') ~ '#bbbbcc',
                             bi_class %in% c('1-4') ~ colorspace::lighten(div_clr[1], .4),
                             bi_class %in% c('2-4') ~ colorspace::lighten(div_clr[1], .2),
                             bi_class %in% c('3-4') ~ div_clr[1],
                             bi_class %in% c('4-1') ~ colorspace::lighten(div_clr[2], .4),
                             bi_class %in% c('4-2') ~ colorspace::lighten(div_clr[2], .2),
                             bi_class %in% c('4-3') ~ div_clr[2],
                             bi_class == '4-4' ~ div_clr[3], ### black
                             TRUE ~ 'blue'))

panel_lgd_raw <- ggplot(colors_df, aes(x, y, fill = bi_class)) +
  labs(x = "CHI Hab -->",
       y = "CHI FE -->") +
  geom_tile(show.legend = FALSE, color = 'white', size = .25) +
  scale_fill_manual(breaks = colors_df$bi_class, values = colors_df$bi_fill) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme(text = element_text(face = 'bold'),
        plot.background = element_blank())
# panel_bc_lgd_raw
```

### Panel A and B: spp and FE average bivariate plot

Use a four-level bivariate color scale to capture spatial overlap of quartiles for climate and non-climate stressors.

```{r spp dataframes}
cc_spp_df <- as.data.frame(cc_qtile_spp, xy = TRUE) %>%
  setNames(c('x', 'y', 'cc_spp'))
noncc_spp_df <- as.data.frame(noncc_qtile_spp, xy = TRUE) %>%
  setNames(c('x', 'y', 'noncc_spp'))

cc_noncc_spp_df <- full_join(cc_spp_df, noncc_spp_df, by = c('x', 'y'), type = 'full') %>%
  mutate(bi_class = paste(cc_spp, noncc_spp, sep = '-'))
```

```{r panel A}
panel_a_spp <- ggplot() +
  ### background for NA cells:
  geom_raster(data = ocean_df, aes(x, y), fill = 'grey85') +
  ### plot data:
  geom_raster(data = cc_noncc_spp_df, aes(x, y, fill = bi_class), show.legend = FALSE) +
  ### continents:
  geom_sf(data = land_sf,
          fill = 'grey96', color = 'grey40', 
          size = .1) +
  # geom_sf(data = hot_cool_sf, aes(color = val), 
  #         fill = NA, size = .1,
  #         show.legend = FALSE) +
  scale_fill_manual(breaks = colors_df$bi_class, values = colors_df$bi_fill) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank())

# panel_a_spp
```

```{r FE dataframes}
cc_fe_df <- as.data.frame(cc_qtile_fe, xy = TRUE) %>%
  setNames(c('x', 'y', 'cc_fe'))
noncc_fe_df <- as.data.frame(noncc_qtile_fe, xy = TRUE) %>%
  setNames(c('x', 'y', 'noncc_fe'))

cc_noncc_fe_df <- full_join(cc_fe_df, noncc_fe_df, by = c('x', 'y'), type = 'full') %>%
  mutate(bi_class = paste(cc_fe, noncc_fe, sep = '-'))
```

```{r panel B}
panel_b_fe <- ggplot() +
  ### background for NA cells:
  geom_raster(data = ocean_df, aes(x, y), fill = 'grey85') +
  ### plot data:
  geom_raster(data = cc_noncc_fe_df, aes(x, y, fill = bi_class), show.legend = FALSE) +
  ### continents:
  geom_sf(data = land_sf,
          fill = 'grey96', color = 'grey40', 
          size = .1) +
  # geom_sf(data = hot_cool_sf, aes(color = val), 
  #         fill = NA, size = .1,
  #         show.legend = FALSE) +
  scale_fill_manual(breaks = colors_df$bi_class, values = colors_df$bi_fill) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank())

# panel_b_fe
```

```{r spp vs fe comparison}

spp_overlap_summary <- cc_noncc_spp_df %>%
  group_by(bi_class) %>%
  summarize(ncell = n(),
            pct = n() / nrow(.))
knitr::kable(spp_overlap_summary, digits = 4, 
             col.names = c('spp CHI overlap', '# of cells', '% of area'))


fe_overlap_summary <- cc_noncc_fe_df %>%
  group_by(bi_class) %>%
  summarize(ncell = n(),
            pct = n() / nrow(.))
knitr::kable(fe_overlap_summary, digits = 4, 
             col.names = c('FE CHI overlap', '# of cells', '% of area'))


fe_hotspots <- cc_noncc_fe_df %>%
  filter(bi_class %in% c('1-1', '4-4')) %>%
  select(x, y, fe_bi = bi_class)
spp_hotspots <- cc_noncc_spp_df %>%
  filter(bi_class %in% c('1-1', '4-4')) %>%
  select(x, y, spp_bi = bi_class)

similarity_df <- fe_hotspots %>%
  full_join(spp_hotspots, by = c('x', 'y')) %>%
  mutate(match = case_when(is.na(spp_bi) ~ 'b',
                           is.na(fe_bi)  ~ 'c',
                           spp_bi == fe_bi ~ 'a',
                           TRUE ~ 'X')) %>%
  group_by(match) %>%
  summarize(n_gp = n()) %>%
  spread(match, n_gp) %>%
  mutate(jaccard = a / (a + b + c),
         sorensen = 2*a / (2*a + b + c))

knitr::kable(similarity_df)

```

### Panel C and D: pct difference, spp-average vs fe-average

The categories here reflect relative impact:

$$diff = \frac{I_{FE}^C - I_{spp}^C}{I_{spp}^C} \times 100\%$$
So, a difference of +50% means $I_{FE}^C$ is 1.5 X as great as $I_{spp}^C$.

```{r panel C and D}
fe_vs_spp_stack <- rast(list(spp_cc = climate_map_spp,
                             spp_noncc = nonclimate_map_spp,
                             fe_cc = climate_map_fe,
                             fe_noncc = nonclimate_map_fe))
spp_vs_fe_df <- as.data.frame(fe_vs_spp_stack, xy = TRUE) %>%
  mutate(cell_num = 1:n())

diff_df <- spp_vs_fe_df %>%
  mutate(cc_diff = (fe_cc - spp_cc) / spp_cc * 100,
         noncc_diff = (fe_noncc - spp_noncc) / spp_noncc * 100) %>%
  select(cell_num, x, y, cc_diff, noncc_diff) %>%
  pivot_longer(names_to = 'type', values_to = 'diff', cols = c(cc_diff, noncc_diff)) %>%
  mutate(diff_cat = case_when(diff <= -50 ~ '< -50%',
                              diff <= -20 ~ '< -20%',
                              diff <= -10 ~ '< -10%',
                              diff >= +50 ~ '> +50%',
                              diff >= +20 ~ '> +20%',
                              diff >= +10 ~ '> +10%',
                              TRUE ~ NA_character_))

diff_df %>% 
  select(diff_cat, type) %>% table()

diff_df %>%
  mutate(diff_sign = ifelse(sign(diff) > 0, 'FE dominant', 'Spp dominant')) %>%
  group_by(diff_sign, type) %>%
  summarize(pct = sum(!is.na(diff_sign)) / n_distinct(diff_df$cell_num))
```


``` {r}
### these need to be in the correct order!
brks <- c('< -50%',
          '< -20%',
          '< -10%',
          '> +10%',
          '> +20%',
          '> +50%')
# lbls <- latex2exp::TeX(brks) %>% unname()
lbls <- brks

clrs <- hcl.colors(palette = 'Red-Green', rev = TRUE, n = 6)

panel_c_cc <- ggplot() +
  ### background for NA cells:
  geom_raster(data = ocean_df, aes(x, y), fill = 'grey85') +
  ### plot data:
  geom_raster(data = diff_df %>% filter(type == 'cc_diff'), 
              aes(x, y, fill = diff_cat)) +
  scale_fill_manual(breaks = brks, labels = lbls, values = clrs,
                    guide = guide_legend(reverse = TRUE),
                    na.value = 'grey96') +
  ### continents:
  geom_sf(data = land_sf,
          fill = 'grey96', color = 'grey40', 
          size = .10) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank(),
        legend.key.height = unit(.25, 'cm'),
        legend.key.width = unit(.75, 'cm'),
        legend.spacing = unit(0, 'cm'),
        legend.margin = margin(0, 0, 0, 0, unit = 'pt'),
        legend.text = element_text(size = 6, color = 'black', 
                                   hjust = 0.5, vjust = 0, angle = 0),
        legend.position = 'bottom',
        legend.direction = 'horizontal',
        legend.title = element_blank()) +
  guides(fill = guide_legend(label.position = "bottom", nrow = 1)) 

panel_d_noncc <- ggplot() +
  ### background for NA cells:
  geom_raster(data = ocean_df, aes(x, y), fill = 'grey85') +
  ### plot data:
  geom_raster(data = diff_df %>% filter(type == 'noncc_diff'), 
              aes(x, y, fill = diff_cat)) +
  scale_fill_manual(breaks = brks, labels = lbls, values = clrs,
                    na.value = 'grey96') +
  ### continents:
  geom_sf(data = land_sf,
          fill = 'grey96', color = 'grey40', 
          size = .10) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank(),
        legend.position = 'none')

# panel_c; panel_d
```

## Assemble figure

```{r gather pieces}
fig2_file <- here('5_ms_figs/fig2_mapping_impacts.png')
panel_a_map  <- get_panel(panel_a_spp)
panel_b_map  <- get_panel(panel_b_fe)
panel_c_map  <- get_panel(panel_c_cc)
panel_d_map  <- get_panel(panel_d_noncc)
panel_ab_lgd <- get_panel(panel_lgd_raw)
panel_cd_lgd <- get_legend(panel_c_cc)
```

```{r assemble figure square}

### parameterize panels for easier changing
p_w <- 0.55
p_h <- p_w / 2 * 6/5
a <- c(x = 0.00, y = 0.63)
b <- c(x = 1-p_w, y = 0.42)
c <- c(x = 0.00, y = 0.21)
d <- c(x = 1-p_w, y = 0.0)

fig2_panels <- ggdraw() +
  draw_plot(panel_a_map,  x = a['x'], y = a['y'], height = p_h, width = p_w) +
  draw_plot(panel_b_map,  x = b['x'], y = b['y'], height = p_h, width = p_w) +
  draw_plot(panel_c_map,  x = c['x'], y = c['y'], height = p_h, width = p_w) +
  draw_plot(panel_d_map,  x = d['x'], y = d['y'], height = p_h, width = p_w)

fig2_labels <- fig2_panels +
  draw_label('A', x = a['x'], y = a['y'] + p_h,  hjust = 0, vjust = 0, 
             size = 9, fontface = 'bold') +
  draw_label('B', x = 1,      y = b['y'] + p_h,  hjust = 1, vjust = 0, 
             size = 9, fontface = 'bold') +
  draw_label('C', x = c['x'], y = c['y'] + p_h,  hjust = 0, vjust = 0, 
             size = 9, fontface = 'bold') +
  draw_label('D', x = 1,      y = d['y'] + p_h,  hjust = 1, vjust = 0, 
             size = 9, fontface = 'bold') +
  draw_label('Species', x = a['x'] + .04,  y = a['y'] + p_h,  hjust = 0, vjust = 0, 
             size = 7) +
  draw_label('Funct. entity', x = 1 - .04, y = b['y'] + p_h,  hjust = 1, vjust = 0, 
             size = 7) +
  draw_label('Climate', x = c['x'] + .04,  y = c['y'] + p_h,  hjust = 0, vjust = 0, 
             size = 7) +
  draw_label('Non-climate', x = 1 - .04,   y = d['y'] + p_h,  hjust = 1, vjust = 0, 
             size = 7)

### parameterize legends for easier changing of label positions:
l1 <- c(x = .68, y = 0.80, h = .144, w = .12)
l2 <- c(x = .00, y = 0.02, h = .07, w = .44)

fig2_legends <- fig2_labels +
  ### draw legends:
  draw_plot(panel_ab_lgd, x = l1['x'], y = l1['y'],
            height = l1['h'], width = l1['w']) +
  draw_plot(panel_cd_lgd, x = l2['x'], y = l2['y'],
            height = l2['h'], width = l2['w']) +
  ### Legend labels for biscale:
  draw_label('Climate vs. non-\nclimate impacts\n(quartiles)',
             x = l1['x'] + l1['w'] + .01, y = l1['y'] + l1['h'] - .01, 
             hjust = 0, vjust = 1, angle = 0,
             size = 7, color = 'black', fontface = 'bold') +
  draw_label('Climate ->',
             x = l1['x'], y = l1['y'] - .005,
             hjust = 0, vjust = 1, angle = 0,
             size = 6, color = 'black', fontface = 'bold') +
  draw_label('Non-climate ->',
             x = l1['x'] - .005, y = l1['y'],
             hjust = 0, vjust = 0, angle = 90,
             size = 6, color = 'black', fontface = 'bold') +
  ### Legend label for diff plots
  draw_label('Funct. entity vs. species\nimpacts (percent difference)',
             x = 0, y = .15, hjust = 0, vjust = 1, angle = 0,
             size = 7, color = 'black', fontface = 'bold')


ggsave(fig2_file, width = 12, height = 10, units = 'cm', dpi = 300)

knitr::include_graphics(fig2_file)
```

