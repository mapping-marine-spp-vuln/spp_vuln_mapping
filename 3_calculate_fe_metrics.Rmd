---
title: "Calculate functional diversity metrics"
author: "Casey O'Hara"
date: "7/25/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
library(oharac)
oharac::setup()
source(here('fb_slb_fxns.R'))
```

# Summary

Using functional entities defined in a prior script based on a suite of categorical traits, in combination with spatial distribution of species from AquaMaps, calculate functional diversity metrics based on Mouillot et al (2014) and code from Sebastien Villeger: functional richness, functional vulnerability, functional redundancy, and functional over-redundancy.

# Methods

## Load data

```{r}
spp_fe <- read_csv(here('_output/functional_entities/species_fe.csv'))
am_spp_cells <- get_am_spp_cells()
am_spp_info  <- get_am_spp_info() %>%
  select(-species, species = sciname)
```

## Identify AquaMaps species included in Functional Entity calculations

Then filter the species-cell lookup to just those species, for better performance.

```{r}
am_spp_fe   <- inner_join(am_spp_info, spp_fe, by = 'species') %>%
  select(am_sid, species, occur_cells, iucn_sid, fe_code, fe_id, n_spp)

  
am_cells_fe <- oharac::dt_join(am_spp_fe, am_spp_cells, by = 'am_sid', type = 'left') %>%
  select(loiczid, am_sid, fe_code, fe_id, prob)

```

## Calculate functional diversity metrics 

This set of calculations replicates the results of Villeger's function but without resorting to a presence/absence matrix, instead just relying on the original AquaMaps species-cell table.

* spp_fe_df joined to am_spp_cell; 
* group by cell and functional group;
* calculate number of spp per functional group;
* group by cell;
* calculate functional entity metrics - 
    * functional vulnerability
    * functional redundancy
    * functional over-redundancy
    * number of species
    * number of functional groups
    * GINI coefficient-style metric?
    

```{r calc fe metrics}

fe_metrics_file <- here('_output/functional_entities', 'fe_metrics.csv')

if(!file.exists(fe_metrics_file)) {
  # system.time({
  
    am_cells_fe_thresh <- am_cells_fe %>%
      filter(prob >= .4) %>%
      select(-prob) %>%
      distinct()
    
    # system.time({
      nspp_df <- am_cells_fe_thresh %>%
        group_by(loiczid) %>%
        summarize(n_spp = n_distinct(am_sid),
                  n_fe  = n_distinct(fe_code),
                  .groups = 'drop')
    # }) ### 17 seconds
    
    ### this one is a bit slow:
    # system.time({
      nspp_fe_df <- am_cells_fe_thresh %>%
        group_by(loiczid, fe_code) %>%
        summarize(nspp_fe = n(), .groups = 'drop')
          ### using n() instead of n_distinct(); if no dupes
          ### in am_sid/loiczid/fe_code then should be fine.
    # }) ### 175 seconds
    
    # system.time({
      f_vuln_df <- nspp_fe_df %>%
        left_join(nspp_df, by = 'loiczid') %>%
        group_by(loiczid) %>%
        summarize(n_fe = first(n_fe), n_spp = first(n_spp),
                  f_vuln = sum(nspp_fe == 1) / n_fe, 
                  f_red  = mean(nspp_fe),
                  .groups = 'drop')
      f_overred_df <- nspp_fe_df %>%
        left_join(f_vuln_df) %>%
        mutate(f_over = ifelse(nspp_fe > f_red, nspp_fe - f_red, 0)) %>%
        group_by(loiczid) %>% 
        summarize(f_overred = sum(f_over) / sum(nspp_fe),
                  .groups = 'drop')
    # }) ### 7 sec
    
    fe_metrics_df <- f_vuln_df %>%
      full_join(f_overred_df, by = 'loiczid') %>%
      mutate(across(where(is.numeric), .fns = ~round(.x, 6)))
      ### rounding to 6 dec places saves a lot of storage for tifs
  # })
  
  write_csv(fe_metrics_df, fe_metrics_file)
}

```

## Map functional diversity metrics

Create and save rasters of functional diversity metrics:

* Species richness
* Functional entity richness
* Functional vulnerability (% of FEs represented by a single spp)
* Functional redundancy (mean spp count per FE)
* Functional over-redundancy (sum of spp per FE above mean, divided by total number of spp)

```{r}
fe_metrics_df <- read_csv(fe_metrics_file)

n_spp_rast  <- map_to_hcaf(fe_metrics_df, which = 'n_spp')
n_fe_rast   <- map_to_hcaf(fe_metrics_df, which = 'n_fe')
f_vuln_rast <- map_to_hcaf(fe_metrics_df, which = 'f_vuln')
f_red_rast  <- map_to_hcaf(fe_metrics_df, which = 'f_red')
f_overred_rast <- map_to_hcaf(fe_metrics_df, which = 'f_overred')

writeRaster(n_spp_rast,  here('_output/functional_entities/n_spp.tif'),  overwrite = TRUE)
writeRaster(n_fe_rast,   here('_output/functional_entities/n_fe.tif'),   overwrite = TRUE)
writeRaster(f_vuln_rast, here('_output/functional_entities/f_vuln.tif'), overwrite = TRUE)
writeRaster(f_red_rast,  here('_output/functional_entities/f_red.tif'),  overwrite = TRUE)
writeRaster(f_overred_rast, here('_output/functional_entities/f_overred.tif'), overwrite = TRUE)
```

Examine distributions of each raster.

```{r}
hist(n_spp_rast)
hist(n_fe_rast)
hist(f_vuln_rast)
hist(f_red_rast)
hist(f_overred_rast)
```

Plot each raster.
```{r}
plot_map <- function(r, main) {
  var_name <- sym(names(r))
  r_df <- as.data.frame(r, xy = TRUE)
  ggplot(r_df, aes(x, y, fill = !!var_name)) +
    geom_raster() +
    scale_fill_viridis_c() +
    coord_sf() +
    theme_void() +
    labs(title = main)
}
plot_map(n_spp_rast,  main = 'Species richness')
plot_map(log10(n_spp_rast) %>% setNames('log10_n_spp'),  main = 'log_10(Species richness)')
plot_map(n_fe_rast,   main = 'Functional richness')
plot_map(log10(n_fe_rast) %>% setNames('log10_n_fe'),  main = 'log_10(Functional richness)')
plot_map(f_vuln_rast, main = 'Functional vulnerability')
plot_map(f_red_rast,  main = 'Functional redundancy')
plot_map(log10(f_red_rast) %>% setNames('log10_f_red'),  main = 'log_10(Functional redundancy)')
plot_map(f_overred_rast, main = 'Functional overredundancy')
```
