---
title: "Gather habitat maps and process to 10 km Mollweide"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 4, fig.width = 6)

# library(raster)
library(terra)
library(oharac)
library(tidyverse)
library(here)
source(here('common_fxns.R'))
```

# Summary

Gather habitat maps from Recent Pace of Change project (Halpern et al. 2019), aggregate and reproject to Mollweide 10 km resolution.

# Data

Data prepped for Halpern et al. 2019, available from Mazu server.

# Methods

For each CHI native layer (~934m Mollweide):

* Read in habitat raster of 1 (presence) and NA (absence).
* Convert NAs to 0 then mask by ocean presence to eliminate land cells.
* Aggregate by a factor of 11 to approximate 10 km x 10 km, using a mean function - this results in approximate habitat proportional representation in the cell.
* Reproject the result to the analysis CRS/resolution and write out.

```{r}
in_hab_dir <- '/home/shares/ohi/git-annex/impact_acceleration/habitats'

hab_fs <- data.frame(raw = list.files(in_hab_dir, pattern = '.tif$', 
                                      full.names = TRUE)) %>%
  mutate(reproj = here('_data/habitat_maps', basename(raw)))

if(any(!file.exists(hab_fs$reproj))) {
  ocean_rast_chi <- rast(here_anx('_spatial/ocean_chi.tif'))

  ### load ocean and coastal rasters at analysis resolution
  ocean_a_10km <- rast(here('_spatial/ocean_area_mol.tif'))
  coastal_10km <- rast(here('_spatial/coastal_3nmi_area_mol.tif'))
}

for(i in 1:nrow(hab_fs)) {
  ### i <- 1
  in_f  <- hab_fs$raw[i]
  out_f <- hab_fs$reproj[i]
  if(file.exists(out_f)) {
    message('Reprojected habitat map ', basename(out_f), ' exists... skipping!')
    next()
  }
  message('Reading in ', in_f, ' \n  and setting NAs to 0...')
  r <- rast(in_f)

  message('... Aggregating ', basename(in_f), ' by 11x to ~ 10km resolution...')
  r_sum <- aggregate(r, fact = 11, fun = sum, na.rm = TRUE, progress = 'text')
  r_mean <- r_sum / 121

  message('... Projecting ', basename(in_f), ' to 10 km resolution Mollweide...')
  out_r <- project(r_mean, ocean_a_10km, method = 'ngb')

  writeRaster(out_r, out_f, overwrite = TRUE)
}
```

