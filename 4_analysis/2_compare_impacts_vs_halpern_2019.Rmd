---
title: "Compare spp based impacts to habitat-based impacts"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 4, fig.width = 8)

library(raster)
library(oharac)
library(data.table)
library(tidyverse)
library(here)
source(here('common_fxns.R'))
```

# Summary

Gather impact maps from "Recent pace of change in human impact on the worldâ€™s ocean" ("RPoC"), Halpern et al. 2019, reproject to CRS/res of current analysis.  Create maps comparing unweighted spp impacts, FV-weighted spp impacts, and habitat-based impacts

# Data

See scripts in `2_process_vuln_and_impacts` folder.  The habitat-based impact maps are taken from Halpern et al. (2019) - Recent Pace of Change paper: https://knb.ecoinformatics.org/view/doi:10.5063/F12B8WBS.  These have been aggregated and reprojected to the native CRS/res of the current analysis.

# Methods

## Load rasters

```{r}
ocean_a <- raster(here('_spatial/ocean_area_mol.tif'))
neritic <- raster(here('_spatial/bathy_mol_neritic.tif'))
coastal <- raster(here('_spatial/coastal_3nmi_area_mol.tif'))
npp_pel <- raster(here_anx('stressors/fishing/npp', 
                            'log_npp_present_surf_gf_mol.tif'))

nspp <- raster(here('_output/nspp_maps/nspp_in_unwt_vuln.tif'))

imp_hab_fs <- list.files(here('_data/chi_halpern_2019'), 
                         pattern = '.tif', full.names = TRUE)
imp_hab_stack <- stack(imp_hab_fs[!str_detect(imp_hab_fs, 'cumulative')])

imp_spp_unwt_stack <- list.files(here('_output/impact_maps/impact_maps_unweighted'),
                              pattern = 'mean.tif', full.names = TRUE) %>%
  stack() %>%
  setNames(str_remove_all(names(.), 'impact_unwt_|_x_.+|_mean.*'))

imp_spp_fvwt_stack <- list.files(here('_output/impact_maps/impact_maps_fv_weighted'),
                              pattern = 'mean.tif', full.names = TRUE) %>%
  stack() %>%
  setNames(str_remove_all(names(.), 'impact_fvwt_|_x_.+|_mean.*'))
```

## Fishing impacts

Assemble dataframe of values from CHI 2019 fishing layers, then join with weighted and unweighted biomass removal and bycatch layers from spp CHI.

The five fishing layers from CHI 2019 will be summed to create a single fishing layer; similarly the biomass removal and bycatch (and maybe fishing benthic destruction?). 

For these (and other plots) using a transformation to better compare low values, e.g., $\sqrt[4]x$

```{r}
flatten_layers <- function(r, lyrs) {
  raster::subset(r, lyrs) %>% 
    calc(sum, na.rm = TRUE) %>% 
    mask(ocean_a)
}
quick_map <- function(r, main = NULL, xfm = identity) {
  r <- xfm(r)
  p <- 'viridis'
  plot(r, col = hcl.colors(n = 50, palette = p), 
       main = main,
       axes = FALSE)
}
quick_map_divergent <- function(r, main = NULL) {
  p <- 'Red-Green'
  z_max <- max(maxValue(r), -minValue(r))
  z <- c(-z_max, z_max)
  plot(r, col = hcl.colors(n = 50, palette = p), 
       main = main,
       axes = FALSE, zlim = z)
}
```

``` {r}
hab_fish_rast <- flatten_layers(imp_hab_stack, which(str_detect(names(imp_hab_stack), 'fishing')))
spp_fish_unwt_rast <- flatten_layers(imp_spp_unwt_stack, c('biomass_removal', 'bycatch'))
spp_fish_fvwt_rast <- flatten_layers(imp_spp_fvwt_stack, c('biomass_removal', 'bycatch'))

# quick_map(hab_fish_rast^.25, main = '4th root Hab-based fishing')
# quick_map(spp_fish_unwt_rast^.25, main = '4th root Spp-based fishing, unweighted')
# quick_map(spp_fish_fvwt_rast^.25, main = '4th root Spp-based fishing, FV-weighted')
```

``` {r}
fish_impacts_df <- data.frame(hab = values(hab_fish_rast),
                              unwt = values(spp_fish_unwt_rast),
                              fvwt = values(spp_fish_fvwt_rast),
                              unwt_dest = values(imp_spp_unwt_stack$fishing_benthic_dest),
                              fvwt_dest = values(imp_spp_fvwt_stack$fishing_benthic_dest)) %>%
  filter(!is.na(unwt))

fish_lm_fvwt <- lm(hab ~ fvwt + fvwt_dest, data = fish_impacts_df)
fish_lm_unwt <- lm(hab ~ unwt + unwt_dest, data = fish_impacts_df)
# summary(fish_lm_fvwt)
# summary(fish_lm_unwt)
```

## Climate impacts

### SST extremes impacts

SST extremes layer for this analysis is analogous to the SST impacts from Halpern et al 2019.

``` {r}
hab_sst <- imp_hab_stack$sst_extremes
unwt_sst <- imp_spp_unwt_stack$sst_extremes
fvwt_sst <- imp_spp_fvwt_stack$sst_extremes

# quick_map(hab_sst^.25, main = '4th root Hab-based SST extremes')
# quick_map(unwt_sst^.25, main = '4th root Spp-based SST extremes, unweighted')
# quick_map(fvwt_sst^.25, main = '4th root Spp-based SST extremes, FV-weighted')
```

``` {r}
sst_impacts_df <- data.frame(hab = values(hab_sst),
                             unwt = values(unwt_sst),
                             fvwt = values(fvwt_sst)) %>%
  filter(!is.na(unwt))

sst_lm_fvwt <- lm(hab ~ fvwt, data = sst_impacts_df)
sst_lm_unwt <- lm(hab ~ unwt, data = sst_impacts_df)
# summary(sst_lm_fvwt)
# summary(sst_lm_unwt)
```


### OA impacts

``` {r}
hab_oa <- imp_hab_stack$ocean_acidification
unwt_oa <- imp_spp_unwt_stack$ocean_acidification
fvwt_oa <- imp_spp_fvwt_stack$ocean_acidification

# quick_map(hab_oa^.5, main = 'Square root Hab-based OA')
# quick_map(unwt_oa^.5, main = 'Square root Spp-based OA, unweighted')
# quick_map(fvwt_oa^.5, main = 'Square root Spp-based OA, FV-weighted')
```

``` {r}
oa_impacts_df <- data.frame(hab = values(hab_oa),
                            unwt = values(unwt_oa),
                            fvwt = values(fvwt_oa)) %>%
  filter(!is.na(unwt))

oa_lm_fvwt <- lm(hab ~ fvwt, data = oa_impacts_df)
oa_lm_unwt <- lm(hab ~ unwt, data = oa_impacts_df)
# summary(oa_lm_fvwt)
# summary(oa_lm_unwt)
```

### SLR impacts

``` {r}
hab_sea_level_rise <- imp_hab_stack$sea_level_rise %>% mask(coastal)
unwt_sea_level_rise <- imp_spp_unwt_stack$sea_level_rise %>% mask(coastal)
fvwt_sea_level_rise <- imp_spp_fvwt_stack$sea_level_rise %>% mask(coastal)

# quick_map(hab_sea_level_rise^.5, main = 'Square root Hab-based sea_level_rise')
# quick_map(unwt_sea_level_rise^.5, main = 'Square root Spp-based sea_level_rise, unweighted')
# quick_map(fvwt_sea_level_rise^.5, main = 'Square root Spp-based sea_level_rise, FV-weighted')
```

``` {r}
sea_level_rise_impacts_df <- data.frame(hab = values(hab_sea_level_rise),
                            unwt = values(unwt_sea_level_rise),
                            fvwt = values(fvwt_sea_level_rise)) %>%
  filter(!is.na(unwt))

sea_level_rise_lm_fvwt <- lm(hab ~ fvwt, data = sea_level_rise_impacts_df)
sea_level_rise_lm_unwt <- lm(hab ~ unwt, data = sea_level_rise_impacts_df)
# summary(sea_level_rise_lm_fvwt)
# summary(sea_level_rise_lm_unwt)
```

## Shipping impacts

``` {r}
hab_shipping <- imp_hab_stack$shipping
unwt_shipping <- imp_spp_unwt_stack$shipping_large
fvwt_shipping <- imp_spp_fvwt_stack$shipping_large

# quick_map(hab_shipping^.5, main = 'Square root Hab-based shipping')
# quick_map(unwt_shipping^.5, main = 'Square root Spp-based shipping, unweighted')
# quick_map(fvwt_shipping^.5, main = 'Square root Spp-based shipping, FV-weighted')
```

``` {r}
shipping_impacts_df <- data.frame(hab = values(hab_shipping),
                            unwt = values(unwt_shipping),
                            fvwt = values(fvwt_shipping)) %>%
  filter(!is.na(unwt))

shipping_lm_fvwt <- lm(hab ~ fvwt, data = shipping_impacts_df)
shipping_lm_unwt <- lm(hab ~ unwt, data = shipping_impacts_df)
# summary(shipping_lm_fvwt)
# summary(shipping_lm_unwt)
```

## Land-based impacts

### Direct human impacts

``` {r}
hab_direct_human <- imp_hab_stack$direct_human %>% mask(coastal)
unwt_direct_human <- imp_spp_unwt_stack$direct_human %>% mask(coastal)
fvwt_direct_human <- imp_spp_fvwt_stack$direct_human %>% mask(coastal)

# quick_map(hab_direct_human^.5, main = 'Square root Hab-based direct_human')
# quick_map(unwt_direct_human^.5, main = 'Square root Spp-based direct_human, unweighted')
# quick_map(fvwt_direct_human^.5, main = 'Square root Spp-based direct_human, FV-weighted')
```

``` {r}
direct_human_impacts_df <- data.frame(hab = values(hab_direct_human),
                            unwt = values(unwt_direct_human),
                            fvwt = values(fvwt_direct_human)) %>%
  filter(!is.na(unwt))

direct_human_lm_fvwt <- lm(hab ~ fvwt, data = direct_human_impacts_df)
direct_human_lm_unwt <- lm(hab ~ unwt, data = direct_human_impacts_df)
# summary(direct_human_lm_fvwt)
# summary(direct_human_lm_unwt)
```


### Nutrient pollution impacts

``` {r}
hab_nutrient <- imp_hab_stack$nutrient_pollution %>% mask(coastal)
unwt_nutrient <- imp_spp_unwt_stack$nutrient %>% mask(coastal)
fvwt_nutrient <- imp_spp_fvwt_stack$nutrient %>% mask(coastal)

# quick_map(hab_nutrient^.5, main = 'Square root Hab-based nutrient')
# quick_map(unwt_nutrient^.5, main = 'Square root Spp-based nutrient, unweighted')
# quick_map(fvwt_nutrient^.5, main = 'Square root Spp-based nutrient, FV-weighted')
```

``` {r}
nutrient_impacts_df <- data.frame(hab = values(hab_nutrient),
                            unwt = values(unwt_nutrient),
                            fvwt = values(fvwt_nutrient)) %>%
  filter(!is.na(unwt))

nutrient_lm_fvwt <- lm(hab ~ fvwt, data = nutrient_impacts_df)
nutrient_lm_unwt <- lm(hab ~ unwt, data = nutrient_impacts_df)
# summary(nutrient_lm_fvwt)
# summary(nutrient_lm_unwt)
```


### Light pollution impacts

``` {r}
hab_light_pollution <- imp_hab_stack$light_pollution %>% mask(coastal)
unwt_light_pollution <- imp_spp_unwt_stack$light %>% mask(coastal)
fvwt_light_pollution <- imp_spp_fvwt_stack$light %>% mask(coastal)

# quick_map(hab_light_pollution^.5, main = 'Square root Hab-based light_pollution')
# quick_map(unwt_light_pollution^.5, main = 'Square root Spp-based light_pollution, unweighted')
# quick_map(fvwt_light_pollution^.5, main = 'Square root Spp-based light_pollution, FV-weighted')
```

``` {r}
light_pollution_impacts_df <- data.frame(hab = values(hab_light_pollution),
                            unwt = values(unwt_light_pollution),
                            fvwt = values(fvwt_light_pollution)) %>%
  filter(!is.na(unwt))

light_pollution_lm_fvwt <- lm(hab ~ fvwt, data = light_pollution_impacts_df)
light_pollution_lm_unwt <- lm(hab ~ unwt, data = light_pollution_impacts_df)
# summary(light_pollution_lm_fvwt)
# summary(light_pollution_lm_unwt)
```

## Summarize R^2^ values

Gather the linear models comparing species-based impacts (this project) to habitat-based impacts from RCoP (Halpern et al. 2019)

```{r}
fvwt_models <- ls(pattern = 'lm_fvwt')
unwt_models <- ls(pattern = 'lm_unwt')
mdl_df <- lapply(c(fvwt_models, unwt_models),
                 FUN = function(m) {
                   x <- broom::tidy(get(m)) %>%
                     mutate(term = str_remove_all(tolower(term), '\\(|\\)'),
                            mdl = m,
                            adj_r_sq = summary(get(m))$adj.r.squared)
                 }) %>%
  bind_rows() %>%
  mutate(stressor = str_remove(mdl, '_lm.+'),
         wt  = str_extract(mdl, 'fvwt|unwt')) %>%
  select(stressor, term, estimate, statistic, adj_r_sq) %>%
  filter(term != 'intercept') %>%
  mutate(across(where(is.numeric), ~round(.x, 4)))

DT::datatable(mdl_df %>% arrange(desc(adj_r_sq)))
```

Some stressors show a rather poor correlation between the two projects.  The stressor layers *should* be similar, but the mean (unweighted or fv-weighted) vulnerability of all spp present in a cell may be quite different from the vulnerability score assigned for the representative habitats in the same cell.  To explore this further, compare the raw stressor layers between the two projects for:

* Sea level rise
* Sea surface temperature extremes
* Shipping

For fishing, the methods from 2019 aggregated geartypes and rescaled the various fishing stressors across five categories, while methods from this analysis independently applied fishing catch across taxonomic groups irrespective of gear types (though NPP rescaling was tied to water column position of gear type).  Because of these quite different methods, we can compare the original data from Watson (2018) for the assessment years in RPoC vs the assessment years used in this assessment.

For comparison, we should also compare other stressor layers that we expect to be well correlated.

### Compare SST stressors

```{r}
sst_str_hab <- raster(here('_data/chi_halpern_2019/stressors', 
                           'sst_extremes_stressor_rescaled.tif'))
sst_str_spp <- raster(here('_data/stressors_mol/sst_extremes_2020.tif'))

quick_map(sst_str_hab, main = 'SST rescaled stressor for Halpern 2019')
quick_map(sst_str_spp, main = 'SST rescaled stressor for O\'Hara 2022')

```

``` {r}
sst_strs_df <- data.frame(hab = values(sst_str_hab),
                          spp = values(sst_str_spp)) %>%
  filter(!is.na(spp))

sst_str_lm <- lm(hab ~ spp, data = sst_strs_df)
summary(sst_str_lm)
```

Many of the hottest parts of the oceans according to 2013 data match with cooler parts in 2020, and vice versa...   In the supplement for RPoC, Fig. S10 shows major shifts in SST *impacts* between 2013 (included in the RPoC analysis) and 2017 (not included in main analysis), so the low correlation between 2013 (RPoC) and 2020 (Spp CHI) impact and stressor layers is likely legitimate.  Compare 2020 (spp CHI) to 2017 data from RPoC supplement (using impact values):

```{r}
sst_hab_2017_f <- here('_data/chi_halpern_2019/sst_extremes_2017.tif')
if(!file.exists(sst_hab_2017_f)) {
  sst_hab_imp_dir <- '/home/shares/ohi/git-annex/impact_acceleration/no_sst/stressor_impact'
  sst_hab_2017_raw <- raster(file.path(sst_hab_imp_dir, 'sst_2017.tif'))
  sst_hab_2017_agg <- aggregate(sst_hab_2017_raw, fact = 11, fun = mean, progress = 'text')
  sst_hab_2017 <- sst_hab_2017_agg %>%
    projectRaster(ocean_a, method = 'bilinear')
  writeRaster(sst_hab_2017, sst_hab_2017_f)
}

sst_hab_2017 <- raster(sst_hab_2017_f)
sst_impacts_df2 <- data.frame(hab = values(hab_sst),
                              hab_2017 = values(sst_hab_2017),
                              unwt = values(unwt_sst),
                              fvwt = values(fvwt_sst)) %>%
  filter(!is.na(unwt))

sst_lm2_fvwt <- lm(hab_2017 ~ fvwt, data = sst_impacts_df2)
summary(sst_lm2_fvwt)
### R^2 = .2495

sst_lm2_unwt <- lm(hab_2017 ~ unwt, data = sst_impacts_df2)
summary(sst_lm2_unwt)
### R^2 = .2782

sst_lm2_2013_2017 <- lm(hab_2017 ~ hab, data = sst_impacts_df2)
summary(sst_lm2_2013_2017)
### R^2 = .0869
```

Comparing the 2020 SST species-based impacts to the 2017 SST habitat-based impacts drastically increases correlation over the comparison to 2013 (still far from perfect, but that is to be expected).

### Compare SLR stressors

Was SLR stressor in 2019 significantly different in pattern from 2013?

```{r}
coastal <- raster(here('_spatial/coastal_3nmi_area_mol.tif'))
slr_str_hab <- raster(here('_data/chi_halpern_2019/stressors', 
                           'sea_level_rise_stressor_rescaled.tif')) %>%
  mask(coastal)
slr_str_spp <- raster(here('_data/stressors_mol/sea_level_rise_2019.tif')) %>%
  mask(coastal)

# quick_map(slr_str_hab, main = 'SLR rescaled stressor for Halpern 2019')
# quick_map(slr_str_spp, main = 'SLR rescaled stressor for O\'Hara 2022')

```

``` {r}
slr_strs_df <- data.frame(hab = values(slr_str_hab),
                          spp = values(slr_str_spp)) %>%
  filter(!is.na(spp))

slr_str_lm <- lm(hab ~ spp, data = slr_strs_df)
summary(slr_str_lm)
```
No real correlation at all!  What if we compare 2020 layer (for this project) to 2013 layer from OHI?  Apply same methods from setup script 7 to the 2013 years (2009-2013) instead of the 2019 layers (2015-2019).  If there is little correlation between these two layers, then that shows that SLR patterns in each time period are basically independent.

We can also compare the recreated 2013 layer to the RPoC 2013 layer to see how well they correlate, to compare similarity of methods and underlying data.  Because these methods are a bit different from those used in the Hab-based CHI from Halpern 2019 (reference points, resolution, gapfilling, etc), we can expect decent correlation but not complete.

```{r}
slr_ohi_2013 <- stack(here_anx('../../git-annex/globalprep/prs_slr', 
                                'v2021/int/msla_annual_mean',
                                sprintf('msla_annual_%s.tif', 2009:2013))) %>%
  calc(mean)

slr_2013_mol <- projectRaster(slr_ohi_2013, slr_str_spp) %>%
  mask(coastal)
values(slr_2013_mol)[values(slr_2013_mol) < 0] <- 0
thresh <- quantile(values(slr_2013_mol), .999, na.rm = TRUE)
values(slr_2013_mol)[values(slr_2013_mol) > thresh] <- 1

# quick_map(slr_2013_mol, main = 'ohi 2013')
# quick_map(slr_str_hab, main = 'hab chi 2013')
# quick_map(slr_str_spp, main = 'spp chi 2019')
```

```{r}
slr_strs_df2 <- data.frame(hab = values(slr_str_hab),
                          spp = values(slr_str_spp),
                          ohi = values(slr_2013_mol)) %>%
  drop_na()

slr_str_lm2 <- lm(hab ~ ohi, data = slr_strs_df2)
summary(slr_str_lm2)
# R^2 = .4577
slr_str_lm3 <- lm(spp ~ ohi, data = slr_strs_df2)
summary(slr_str_lm3)
# R^2 = .0055

```

The 2013 layer corresponds pretty well to the 2013 layer used for RPoC, and very poorly to the 2019 layer used for this analysis.  So the method seems reasonably sound, even if the variation in the SLR mean anomaly data is still quite high even after averaging over a five year span.

### Compare shipping stressors

This analysis uses a different source for shipping data, based on AIS tracking, and excluding small ships, so rather weak correlation is not super surprising.

```{r}
shipping_str_hab <- raster(here('_data/chi_halpern_2019/stressors', 
                           'shipping_stressor_rescaled.tif'))
shipping_str_spp <- raster(here('_data/stressors_mol/shipping_large_2021.tif'))

# quick_map(shipping_str_hab, main = 'Shipping rescaled stressor for Halpern 2019')
# quick_map(shipping_str_spp, main = 'Shipping rescaled stressor for O\'Hara 2022')

```

``` {r}
shipping_strs_df <- data.frame(hab = values(shipping_str_hab),
                               spp = values(shipping_str_spp)) %>%
  filter(!is.na(spp))

shipping_str_lm <- lm(hab ~ spp, data = shipping_strs_df)
summary(shipping_str_lm)
```

## Compare fishing stressors

Here, because the methods of assigning impact are very different from those used in the RPoC study, high correlation is not necessarily expected.  It may also be that patterns of fishing in 2013 (per RPoC study) were quite different from the 2015-2017 averages used in this study (especially given the shifting SST conditions).  Rather than comparing impacts, let us compare the values from the Watson dataset for 2013 against those from 2015-2017.

```{r}
w_dir <- here_anx('../../git-annex/globalprep/_raw_data', 
                  'IMAS_GlobalFisheriesLandings/d2020')

w_cell_df <- readxl::read_excel(w_codes_xlsx, sheet = 'Cell') %>%
  janitor::clean_names() %>%
  select(-c(x5:x7))

w_catch_2017_df <- readRDS(file.path(w_dir, 'Catch2015_2019.rds')) %>%
  janitor::clean_names() %>%
  filter(i_year %in% 2015:2017) %>%
  data.table() %>%
  .[ , .(rep_ind_2017  = sum(reported_ind, na.rm = TRUE)/3,
         rep_nind_2017 = sum(reported_nind, na.rm = TRUE)/3,
         discards_2017 = (sum(discards_ind, na.rm = TRUE) + sum(discards_nind, na.rm = TRUE))/3),
     by = 'cell']

w_catch_2013_df <- readRDS(file.path(w_dir, 'Catch2010_2014.rds')) %>%
  janitor::clean_names() %>%
  filter(i_year == 2013) %>%
  data.table() %>%
  .[ , .(rep_ind_2013  = sum(reported_ind, na.rm = TRUE),
         rep_nind_2013 = sum(reported_nind, na.rm = TRUE),
         discards_2013 = sum(discards_ind, na.rm = TRUE) + sum(discards_nind, na.rm = TRUE)),
     by = 'cell']

w_2013_2017_df <- w_catch_2013_df %>%
  left_join(w_catch_2017_df, by = 'cell') %>%
  left_join(w_cell_df, by = 'cell') %>%
  mutate(rep_tot_2013 = rep_ind_2013 + rep_nind_2013,
         rep_tot_2017 = rep_ind_2017 + rep_nind_2017) %>%
  mutate(across(where(is.numeric), ~ ifelse(is.na(.x), 0, .x)))
```

``` {r}
rep_tot_2013  <- map_to_hcaf(w_2013_2017_df, by = 'cell', which = 'rep_tot_2013')
rep_tot_2017  <- map_to_hcaf(w_2013_2017_df, by = 'cell', which = 'rep_tot_2017')
rep_ind_2013  <- map_to_hcaf(w_2013_2017_df, by = 'cell', which = 'rep_ind_2013')
rep_ind_2017  <- map_to_hcaf(w_2013_2017_df, by = 'cell', which = 'rep_ind_2017')
rep_nind_2013 <- map_to_hcaf(w_2013_2017_df, by = 'cell', which = 'rep_nind_2013')
rep_nind_2017 <- map_to_hcaf(w_2013_2017_df, by = 'cell', which = 'rep_nind_2017')
discards_2013 <- map_to_hcaf(w_2013_2017_df, by = 'cell', which = 'discards_2013')
discards_2017 <- map_to_hcaf(w_2013_2017_df, by = 'cell', which = 'discards_2017')

plot(log(rep_ind_2013), main = 'log(rep ind 2013)')
plot(log(rep_ind_2017), main = 'log(rep ind 2013)')
plot(log(rep_nind_2013), main = 'log(rep nind 2013)')
plot(log(rep_nind_2017), main = 'log(rep nind 2013)')
plot(log(discards_2013), main = 'log(discards 2013)')
plot(log(discards_2017), main = 'log(discards 2013)')

ocean_a_hcaf <- raster(here('_spatial/ocean_area_wgs84_0.5deg.tif'))
rep_tot_diff <- stack(rep_tot_2017, -rep_tot_2013) %>% 
  calc(sum, na.rm = TRUE) %>% 
  mask(ocean_a_hcaf)

pwr <- 4
rt_tot_diff <- (abs(rep_tot_diff))^(1/pwr) * sign(rep_tot_diff)
rt_tot_df <- as.data.frame(rt_tot_diff, xy = TRUE) %>%
  filter(!is.na(layer))

brks <- c(5, 10, 15, 20)
lbls <- brks^pwr
ggplot(rt_tot_df, aes(x, y, fill = layer)) +
  theme_ohara() +
  geom_raster() +
  scale_fill_gradientn(colors = hcl.colors(9, palette = 'Red-Green'),
                       breaks = c(-brks, 0, brks), labels = c(-lbls, 0, lbls),
                       limits = c(-20, 20)) +
  title('Difference in total catch (4th rt xform), 2013 to 2017')
```

Visual differences in patterns... let's try some regressions!  Drop cells where no fishing occurred in either year

```{r}
# rep_ind_lm <- lm(rep_ind_2017 ~ rep_ind_2013, data = w_2013_2017_df)
# summary(rep_ind_lm)
### R^2 = .5559
# rep_nind_lm <- lm(rep_nind_2017 ~ rep_nind_2013, data = w_2013_2017_df)
# summary(rep_nind_lm)
### R^2 = .3551

rep_tot_df <- w_2013_2017_df %>%
  select(rep_tot_2013, rep_tot_2017) %>%
  filter(rep_tot_2013 + rep_tot_2017 > 0)
rep_tot_lm <- lm(rep_tot_2017 ~ rep_tot_2013, data = rep_tot_df)
summary(rep_tot_lm)
### R^2 = .5864

# discards_lm <- lm(discards_2017 ~ discards_2013, data = w_2013_2017_df)
# summary(discards_lm)
### R^2 = .2822
```


## Check seemingly non-problematic stressors

### Compare light pollution stressors

```{r}
light_str_hab <- raster(here('_data/chi_halpern_2019/stressors', 
                             'light_pollution_stressor_rescaled.tif')) %>%
  mask(coastal)
light_str_spp <- raster(here('_data/stressors_mol/light_2018.tif')) %>%
  mask(coastal)

# quick_map(light_str_hab, main = 'light pollution rescaled stressor for Halpern 2019')
# quick_map(light_str_spp, main = 'light pollution rescaled stressor for O\'Hara 2022')

```

``` {r}
light_strs_df <- data.frame(hab = values(light_str_hab),
                            spp = values(light_str_spp)) %>%
  filter(!is.na(spp))

light_str_lm <- lm(hab ~ spp, data = light_strs_df)
summary(light_str_lm)
```


### Compare direct human stressors

This seems lower correlation than it should (though still 40%)... is there some difference in methods e.g. log transform or additional masking going on?

```{r}
direct_human_str_hab <- raster(here('_data/chi_halpern_2019/stressors', 
                             'direct_human_stressor_rescaled.tif')) %>%
  mask(coastal)
direct_human_str_spp <- raster(here('_data/stressors_mol/direct_human_2020.tif')) %>%
  mask(coastal)

# quick_map(direct_human_str_hab, main = 'direct_human rescaled stressor for Halpern 2019')
# quick_map(direct_human_str_spp, main = 'direct_human rescaled stressor for O\'Hara 2022')

```

``` {r}
direct_human_strs_df <- data.frame(hab = values(direct_human_str_hab),
                            spp = values(direct_human_str_spp)) %>%
  filter(!is.na(spp))

direct_human_str_lm <- lm(hab ~ spp, data = direct_human_strs_df)
summary(direct_human_str_lm)
```


### Compare nutrient pollution stressors

This analysis includes additional nutrient pollutants, including wastewater and aquaculture along with agriculture, so not as strong a correlation but still solid.

```{r}
nutrient_str_hab <- raster(here('_data/chi_halpern_2019/stressors', 
                             'nutrient_pollution_stressor_rescaled.tif')) %>%
  mask(coastal)
nutrient_str_spp <- raster(here('_data/stressors_mol/nutrient_2020.tif')) %>%
  mask(coastal)

# quick_map(nutrient_str_hab, main = 'nutrient pollution rescaled stressor for Halpern 2019')
# quick_map(nutrient_str_spp, main = 'nutrient pollution rescaled stressor for O\'Hara 2022')

```

``` {r}
nutrient_strs_df <- data.frame(hab = values(nutrient_str_hab),
                            spp = values(nutrient_str_spp)) %>%
  filter(!is.na(spp))

nutrient_str_lm <- lm(hab ~ spp, data = nutrient_strs_df)
summary(nutrient_str_lm)
```



### Compare ocean acidification stressors

```{r}
oa_str_hab <- raster(here('_data/chi_halpern_2019/stressors', 
                             'ocean_acidification_stressor_rescaled.tif'))
oa_str_spp <- raster(here('_data/stressors_mol/ocean_acidification_2020.tif'))

# quick_map(oa_str_hab, main = 'OA rescaled stressor for Halpern 2019')
# quick_map(oa_str_spp, main = 'OA rescaled stressor for O\'Hara 2022')

```

``` {r}
oa_strs_df <- data.frame(hab = values(oa_str_hab),
                            spp = values(oa_str_spp)) %>%
  filter(!is.na(spp))

oa_str_lm <- lm(hab ~ spp, data = oa_strs_df)
summary(oa_str_lm)
```


