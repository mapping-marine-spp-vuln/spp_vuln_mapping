---
title: "Compare areas of high/low cumulative impact across methods"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 4, fig.width = 7)

library(terra)
library(oharac)
library(data.table)
library(tidyverse)
library(here)
source(here('common_fxns.R'))
```

# Summary

Compare the areas of highest and lowest impact across the three methods here: equal-weighted spp-based impacts, fv-weighted spp-based impacts, and habitat-based impacts.

# Methods

Cumulative impact as the starting point; then perhaps break out by climate, land-based, ocean-based, and fishing stressors.  

## Load cumulative impact rasters

Build up an analysis dataframe including all three CHI maps.  Include additional layers to facilitate examination of impacts by coastal (i.e., neritic) vs. open ocean, as well as by EEZ and MEOW.  Include a layer of species richness to drop any instances where species count falls below some threshold, to ensure impact scores are based on a reasonable number of species (e.g., 20 spp).

```{r build chi dataframe}
chi_fs <- list.files(here('_output/impact_maps/cumulative_maps'), pattern = '^chi_.+.tif',
                     full.names = TRUE)
chi_stack <- rast(chi_fs) %>%
  setNames(basename(chi_fs) %>% str_remove('.tif'))

nspp_r <- rast(here('_output/nspp_maps/nspp_in_unwt_vuln.tif')) %>%
  setNames('nspp')
coastal_r <- rast(here('_spatial/bathy_mol_neritic.tif')) %>%
  setNames('coastal')
eez_r <- rast(here('_spatial/eez_mol.tif')) %>%
  setNames('eez')
meow_r <- rast(here('_spatial/meow_rgns_mol.tif')) %>%
  setNames('meow')

chi_df <- data.frame(values(chi_stack),
                     values(nspp_r),
                     values(coastal_r),
                     values(eez_r),
                     values(meow_r)) %>%
  mutate(cell_id = 1:n()) %>%
  filter(nspp >= 20) %>%
  drop_na(starts_with('chi')) ### drop any cells with NA in *any* chi column - can't compare!
```

``` {r compare different species count thresholds}
nspp_df <- nspp_r %>% 
  as.data.frame(xy = TRUE) %>%
  mutate(cut = case_when(nspp < 10 ~ 'cut < 10 spp',
                         nspp < 20 ~ 'cut < 20 spp',
                         nspp < 30 ~ 'cut < 30 spp',
                         TRUE ~ 'keep'))
# table(nspp_df$cut) ### keep in mind these are cumulative...
# cut < 10 spp cut < 20 spp cut < 30 spp         keep 
#        57729        34573        39150      3548548 
ggplot(nspp_df, aes(x = x, y = y, fill = cut)) +
  geom_raster() +
  scale_fill_manual(values = c('red', 'yellow', 'blue', 'grey90')) +
  coord_sf() +
  theme_void()
```

## Reclassify for broad comparison

Examine several thresholds for comparison, e.g., top/bottom 10%, 20%, 25%.  To facilitate this, read in rasters, convert to dataframes, and convert impact values to various slices.  Cutting using an ntile method for 20 slices allows easy recategorization.

```{r reclassify each chi column by ntile}
chi_ntile_df <- chi_df %>%
  mutate(fvwt_ntile = ntile(chi_fv_weighted, n = 20),
         eqwt_ntile = ntile(chi_unweighted,  n = 20),
         habs_ntile = ntile(chi_habitat,     n = 20))
```

### Compare equal-weighted vs fv-weighted cumulative impacts

This may not be interesting for the paper - probably focus on the FV-weighted impacts in the main paper.  But there should be considerable overlap.

```{r}
### top, bottom 20%:
cols_top  <- c('red3', 'yellow', 'steelblue1', 'grey90')
cols_btm  <- c('green3', 'yellow', 'steelblue1', 'grey90')
cols_mis  <- c('yellow', 'steelblue1', 'grey90')
cols_quad <- c('red3', 'green3', 'yellow', 'steelblue1', 'grey90')

fvwt_v_eqwt_df <- chi_ntile_df %>%
  mutate(top_20 = case_when(fvwt_ntile > 16 & eqwt_ntile > 16 ~ 'both',
                            fvwt_ntile > 16 ~ 'fvwt',
                            eqwt_ntile > 16 ~ 'eqwt',
                            TRUE ~ 'x'),
         btm_20 = case_when(fvwt_ntile < 5 & eqwt_ntile < 5 ~ 'both',
                            fvwt_ntile < 5 ~ 'fvwt',
                            eqwt_ntile < 5 ~ 'eqwt',
                            TRUE ~ 'x'),
         hi_lo  = case_when(fvwt_ntile < 5 & eqwt_ntile >16 ~ 'low fv hi eq',
                            fvwt_ntile > 16 & eqwt_ntile < 5 ~ 'low eq hi fv',
                            TRUE ~ 'x'))
fvwt_eqwt_top20 <- map_to_mol(fvwt_v_eqwt_df, by = 'cell_id', which = 'top_20')
plot(fvwt_eqwt_top20, col = cols_top, axes = FALSE, 
     main = 'Overlap of TOP 20%: equal-weighted vs fv-weighted')

fvwt_eqwt_btm20 <- map_to_mol(fvwt_v_eqwt_df, by = 'cell_id', which = 'btm_20')
plot(fvwt_eqwt_btm20, axes = FALSE, col = cols_btm,
     main = 'Overlap of BOTTOM 20%: equal-weighted vs fv-weighted')

fvwt_eqwt_hi_lo <- map_to_mol(fvwt_v_eqwt_df, by = 'cell_id', which = 'hi_lo')
plot(fvwt_eqwt_hi_lo, axes = FALSE, col = cols_mis,
     main = 'Overlap of mismatch 20%: equal-weighted vs fv-weighted')

```

### Compare fv-weighted vs habitat-based cumulative impacts

This is probably what should go in the paper?

```{r}
### top, bottom 20%:
fvwt_v_hab_df <- chi_ntile_df %>%
  mutate(top_20 = case_when(fvwt_ntile > 16 & habs_ntile > 16 ~ 'both',
                            fvwt_ntile > 16 ~ 'spp',
                            habs_ntile > 16 ~ 'hab',
                            TRUE ~ 'x'),
         btm_20 = case_when(fvwt_ntile < 5 & habs_ntile < 5 ~ 'both',
                            fvwt_ntile < 5 ~ 'spp',
                            habs_ntile < 5 ~ 'hab',
                            TRUE ~ 'x'),
         hi_lo  = case_when(fvwt_ntile < 5 & habs_ntile >16 ~ 'low spp hi hab',
                            fvwt_ntile > 16 & habs_ntile < 5 ~ 'low hab hi spp',
                            TRUE ~ 'x'),
         quad   = case_when(fvwt_ntile > 16 & habs_ntile > 16 ~ 'both high',
                            fvwt_ntile <  5 & habs_ntile <  5 ~ 'both low',
                            fvwt_ntile > 16 & habs_ntile <  5 ~ 'hab lo spp hi',
                            fvwt_ntile <  5 & habs_ntile > 16 ~ 'hab hi spp lo',
                            TRUE ~ 'x'))
fvwt_hab_top20 <- map_to_mol(fvwt_v_hab_df, by = 'cell_id', which = 'top_20')
plot(fvwt_hab_top20, axes = FALSE, col = cols_top,
     main = 'Overlap of TOP 20%: habitat vs fv-weighted')

fvwt_hab_btm20 <- map_to_mol(fvwt_v_hab_df, by = 'cell_id', which = 'btm_20')
plot(fvwt_hab_btm20, axes = FALSE, col = cols_btm, 
     main = 'Overlap of BOTTOM 20%: habitat vs fv-weighted')

fvwt_hab_hi_lo <- map_to_mol(fvwt_v_hab_df, by = 'cell_id', which = 'hi_lo')
plot(fvwt_hab_hi_lo, axes = FALSE, col = cols_mis, 
     main = 'Overlap of mismatch 20%: habitat vs fv-weighted')

fvwt_hab_quad <- map_to_mol(fvwt_v_hab_df, by = 'cell_id', which = 'quad')
plot(fvwt_hab_quad, axes = FALSE, col = cols_quad, 
     main = 'Overlap of top/bottom 20%: habitat vs fv-weighted')

```

## Reclassify for coast vs open ocean comparison

Similar to above, except look at top/bottom 20% separately for continental shelf cells and open ocean cells.

```{r reclassify each chi column by ntile for coast-vs-noncoast comparison}
chi_cst_ntile_df <- chi_df %>%
  mutate(coastal = is.na(coastal)) %>%
  group_by(coastal) %>%
  mutate(spp_ntile = ntile(chi_fv_weighted, n = 20),
         hab_ntile = ntile(chi_habitat,     n = 20)) %>%
  ungroup()
```

### Compare fv-weighted vs habitat-based cumulative impacts

Focus just on the FV-weighted and habitat from here.

```{r}
### top, bottom 20%:
spp_hab_cst_df <- chi_cst_ntile_df %>%
  mutate(top_20 = case_when(spp_ntile > 16 & hab_ntile > 16 ~ 'both',
                            spp_ntile > 16 ~ 'spp',
                            hab_ntile > 16 ~ 'hab',
                            TRUE ~ 'x'),
         btm_20 = case_when(spp_ntile < 5 & hab_ntile < 5 ~ 'both',
                            spp_ntile < 5 ~ 'spp',
                            hab_ntile < 5 ~ 'hab',
                            TRUE ~ 'x'),
         hi_lo  = case_when(spp_ntile < 5 & hab_ntile >16 ~ 'low spp hi hab',
                            spp_ntile > 16 & hab_ntile < 5 ~ 'low hab hi spp',
                            TRUE ~ 'x'),
         quad   = case_when(spp_ntile > 16 & hab_ntile > 16 ~ 'both high',
                            spp_ntile <  5 & hab_ntile <  5 ~ 'both low',
                            spp_ntile > 16 & hab_ntile <  5 ~ 'hab lo spp hi',
                            spp_ntile <  5 & hab_ntile > 16 ~ 'hab hi spp lo',
                            TRUE ~ 'x'))
spp_hab_top20 <- map_to_mol(spp_hab_cst_df, by = 'cell_id', which = 'top_20')
plot(spp_hab_top20, axes = FALSE, col = cols_top,
     main = 'Overlap of TOP 20%: habitat vs species (coast vs oceanic)')

spp_hab_btm20 <- map_to_mol(spp_hab_cst_df, by = 'cell_id', which = 'btm_20')
plot(spp_hab_btm20, axes = FALSE, col = cols_btm, 
     main = 'Overlap of BOTTOM 20%: habitat vs species (coast vs oceanic)')

spp_hab_hi_lo <- map_to_mol(spp_hab_cst_df, by = 'cell_id', which = 'hi_lo')
plot(spp_hab_hi_lo, axes = FALSE, col = cols_mis, 
     main = 'Overlap of mismatch 20%: habitat vs species (coast vs oceanic)')

spp_hab_quad <- map_to_mol(spp_hab_cst_df, by = 'cell_id', which = 'quad')
plot(spp_hab_quad, axes = FALSE, col = cols_quad, 
     main = 'Overlap of top/bottom 20%: habitat vs species (coast vs oceanic)')

### and for comparison from before:
fvwt_hab_quad <- map_to_mol(fvwt_v_hab_df, by = 'cell_id', which = 'quad')
plot(fvwt_hab_quad, axes = FALSE, col = cols_quad, 
     main = 'Overlap of top/bottom 20%: habitat vs fv-weighted')

```





## Reclassify for EEZ vs ABNJ comparison

Similar to above, except look at top/bottom 20% separately for continental shelf cells and open ocean cells.

```{r reclassify each chi column by ntile for eez-abnj comparison}
chi_eez_ntile_df <- chi_df %>%
  mutate(eez = (eez != 213 & eez < 255)) %>%
  group_by(eez) %>%
  mutate(spp_ntile = ntile(chi_fv_weighted, n = 20),
         hab_ntile = ntile(chi_habitat,     n = 20)) %>%
  ungroup()
```

### Compare fv-weighted vs habitat-based cumulative impacts

Focus just on the FV-weighted and habitat from here.

```{r}
### top, bottom 20%:
spp_hab_eez_df <- chi_eez_ntile_df %>%
  mutate(top_20 = case_when(spp_ntile > 16 & hab_ntile > 16 ~ 'both',
                            spp_ntile > 16 ~ 'spp',
                            hab_ntile > 16 ~ 'hab',
                            TRUE ~ 'x'),
         btm_20 = case_when(spp_ntile < 5 & hab_ntile < 5 ~ 'both',
                            spp_ntile < 5 ~ 'spp',
                            hab_ntile < 5 ~ 'hab',
                            TRUE ~ 'x'),
         hi_lo  = case_when(spp_ntile < 5 & hab_ntile >16 ~ 'low spp hi hab',
                            spp_ntile > 16 & hab_ntile < 5 ~ 'low hab hi spp',
                            TRUE ~ 'x'),
         quad   = case_when(spp_ntile > 16 & hab_ntile > 16 ~ 'both high',
                            spp_ntile <  5 & hab_ntile <  5 ~ 'both low',
                            spp_ntile > 16 & hab_ntile <  5 ~ 'hab lo spp hi',
                            spp_ntile <  5 & hab_ntile > 16 ~ 'hab hi spp lo',
                            TRUE ~ 'x'))
spp_hab_top20 <- map_to_mol(spp_hab_eez_df, by = 'cell_id', which = 'top_20')
plot(spp_hab_top20, axes = FALSE, col = cols_top,
     main = 'Overlap of TOP 20%: habitat vs species (eez vs abnj)')

spp_hab_btm20 <- map_to_mol(spp_hab_eez_df, by = 'cell_id', which = 'btm_20')
plot(spp_hab_btm20, axes = FALSE, col = cols_btm, 
     main = 'Overlap of BOTTOM 20%: habitat vs species (eez vs abnj)')

spp_hab_hi_lo <- map_to_mol(spp_hab_eez_df, by = 'cell_id', which = 'hi_lo')
plot(spp_hab_hi_lo, axes = FALSE, col = cols_mis, 
     main = 'Overlap of mismatch 20%: habitat vs species (eez vs abnj)')

spp_hab_quad <- map_to_mol(spp_hab_eez_df, by = 'cell_id', which = 'quad')
plot(spp_hab_quad, axes = FALSE, col = cols_quad, 
     main = 'Overlap of top/bottom 20%: habitat vs species (eez vs abnj)')

### and for comparison from before:
fvwt_hab_quad <- map_to_mol(fvwt_v_hab_df, by = 'cell_id', which = 'quad')
plot(fvwt_hab_quad, axes = FALSE, col = cols_quad, 
     main = 'Overlap of top/bottom 20%: habitat vs fv-weighted')
```


