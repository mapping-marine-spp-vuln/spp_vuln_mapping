---
title: "Compare spp based CHI to hab based CHI"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 3, fig.width = 12)

library(raster)
library(oharac)
library(data.table)
library(tidyverse)
library(here)
source(here('common_fxns.R'))
```

# Summary

Gather CHI map from Halpern et al. 2019, reproject to CRS/res of current analysis.  Create maps comparing unweighted spp CHI, FV-weighted spp CHI, and habitat-based CHI.

Also, perform comparisons of ranks among these.

# Data

See script 5 for the species-based cumulative impact map methods (plus all the earlier scripts that provide the data for script 5).  The habitat-based CHI map is taken from Halpern et al. (2019) - Recent Pace of Change paper.  The at-risk spp CHI map is taken from O'Hara et al (2021).

# Methods

## Load rasters; reproject hab CHI and at-risk spp CHI

Read in, aggregate by a factor of 10 or 11 (to roughly rescale to 10 km resolution), then reproject to analysis native res.

```{r}
ocean_a  <- raster(here('_spatial/ocean_area_mol.tif'))
neritic  <- raster(here('_spatial/bathy_mol_neritic.tif'))
npp_pel  <- raster(here_anx('stressors/fishing/npp', 
                            'log_npp_present_surf_gf_mol.tif'))

nspp <- raster(here('_output/nspp_maps/nspp_in_unwt_vuln.tif'))

chi_unwt <- raster(here('_output/impact_maps/chi_unweighted.tif'))
chi_fvwt <- raster(here('_output/impact_maps/chi_fv_weighted.tif'))
```

``` {r load atrisk chi map}
chi_atrisk_file <- here('_data/chi_other_studies/chi_ohara_2021.tif')

if(!file.exists(chi_atrisk_file)) {
  n_impacted  <- raster(here_anx('chi_halpern_2019', 
                                 'tot_chi_2013_from_ohara_2021.tif'))
  nspp_atrisk <- raster(here_anx('chi_halpern_2019', 
                                 'nspp_from_ohara_2021.tif'))
  pct_atrisk_raw <- n_impacted / nspp_atrisk
  
  ### no need to aggregate; already ~ 10 km res
  chi_atrisk_reproj <- pct_atrisk_raw %>%
    projectRaster(chi_spp_unwt, method = 'bilinear', progress = 'text')
  
  writeRaster(chi_atrisk_reproj, chi_atrisk_file, overwrite = TRUE)
}
chi_atrisk <- raster(chi_atrisk_file)

```

``` {r load hab chi map}
chi_hab_file <- here('_data/chi_halpern_2019/cumulative.tif')
if(!file.exists(chi_hab_file)) {
  chi_hab_raw <- raster(here_anx('chi_other_studies/chi_2013_from_halpern_2019.tif'))
  
  scale_fact <- round(res(chi_spp_unwt) / res(chi_hab_raw))[1]
  
  chi_hab_agg <- chi_hab_raw %>% 
    aggregate(fact = scale_fact, fun = mean, na.rm = TRUE, progress = 'text')
  
  chi_hab_reproj <- chi_hab_agg %>%
    projectRaster(chi_spp_unwt, method = 'bilinear', progress = 'text')
  
  writeRaster(chi_hab_reproj, chi_hab_file, overwrite = TRUE)
}
chi_hab <- raster(chi_hab_file)
```

## Compare impact values

### Linear regression of values

#### Unweighted vs FV-weighted

```{r}
values_df <- data.frame(hab     = values(chi_hab),
                        unwt    = values(chi_unwt),
                        fvwt    = values(chi_fvwt),
                        nspp    = values(nspp),
                        npp     = values(npp_pel),
                        coastal = values(neritic),
                        ocean   = values(ocean_a),
                        cell_id = 1:ncell(chi_unwt)) %>%
  mutate(coastal = is.na(coastal)) %>%
  filter(!is.na(ocean)) %>%
  filter(nspp >= 20)

lm_unwt_fvwt <- lm(unwt ~ fvwt, data = values_df)
summary(lm_unwt_fvwt)
```

#### Unweighted vs hab

```{r}
lm_unwt_hab <- lm(unwt ~ hab, data = values_df)
summary(lm_unwt_hab)

# test_df <- data.frame(fit = fitted(lm_unwt_hab), res = resid(lm_unwt_hab))
# plot(res ~ fit, data = test_df %>% sample_n(10000)); abline(0, 0)
# qqnorm(y = test_df$res %>% sample(size = 1000)); abline(0, 1)
```

#### Unweighted vs at-risk

```{r}
lm_unwt_atrisk <- lm(unwt ~ atrisk, data = values_df)
summary(lm_unwt_atrisk)
```

#### FV-weighted vs hab

```{r}
lm_fvwt_hab <- lm(fvwt ~ hab, data = values_df)
summary(lm_fvwt_hab)
```

#### FV-weighted vs at-risk

```{r}
lm_fvwt_atrisk <- lm(fvwt ~ atrisk, data = values_df)
summary(lm_fvwt_atrisk)
```

#### Hab vs at-risk

```{r}
lm_hab_atrisk <- lm(hab ~ atrisk, data = values_df)
summary(lm_hab_atrisk)
```


## Compare impact ranks

Create blank rasters.  Set cell ranks using either:

* `data.table::frank` (fast rank) to rank cells from rasters (Use the `ties.method = 'average'` method)
* `dplyr::ntile` to group cell values into quantiles

```{r}
map_ranks  <- function(r, n_gps = NULL, coastal = FALSE) {
  r_new <- raster(r)
  ### if requested, mask to just coastal
  if(coastal) r <- mask(r, raster(here('_spatial/bathy_mol_neritic.tif')))
  
  if(is.null(n_gps)) {
    ### use full ranking:
    values(r_new) <- data.table::frank(values(r))
    
    ### data.table::frank() ranks NAs as max (default) rather than dropping...
    ### so mask and normalize (to get values 0-1):
    r_new <- mask(r_new, raster(here('_spatial/ocean_area_mol.tif')))
    r_new <- r_new / maxValue(r_new)
  } else {
    ### set to a certain number of quantiles; already drops NAs
    values(r_new) <- dplyr::ntile(values(r), n_gps) / n_gps
  }
  
  return(r_new)
}

quick_plot <- function(r, main = NULL) {
  div <- any(values(r) < 0, na.rm = TRUE)
  p <- ifelse(div, 'Red-Green', 'viridis')
  if(div) z <- c(-1, 1) else z <- c(0, 1)
  plot(r, col = hcl.colors(n = 50, palette = p), 
       # main = main, 
       axes = FALSE, zlim = z)
}
```

```{r}
### Mask to ocean to drop NA rankings
rank_hab    <- map_ranks(chi_hab,    n_gps = 20)
rank_atrisk <- map_ranks(chi_atrisk, n_gps = 20)
rank_unwt   <- map_ranks(chi_unwt,   n_gps = 20)
rank_fvwt   <- map_ranks(chi_fvwt,   n_gps = 20)

quick_plot(rank_hab,    main = 'hab chi ranked')
quick_plot(rank_atrisk, main = 'at risk spp chi ranked')
quick_plot(rank_unwt,   main = 'unwt spp chi ranked')
quick_plot(rank_fvwt,   main = 'fvwt spp chi ranked')
```

### Create rank difference rasters

Calculate rank difference maps:

* CHI unwt $\times$ CHI FV-wt
* CHI unwt $\times$ CHI hab
* CHI unwt $\times$ CHI at-risk
* CHI FV-wt $\times$ CHI hab
* CHI FV-wt $\times$ CHI at-risk
* CHI hab $\times$ CHI at-risk

```{r}
d_unwt_fvwt   <- rank_unwt - rank_fvwt
d_unwt_hab    <- rank_unwt - rank_hab
d_unwt_atrisk <- rank_fvwt - rank_atrisk
d_fvwt_hab    <- rank_fvwt - rank_hab
d_fvwt_atrisk <- rank_fvwt - rank_atrisk
d_hab_atrisk  <- rank_hab - rank_atrisk

quick_plot(d_unwt_fvwt,   main = 'unwt - fvwt')
quick_plot(d_unwt_hab,    main = 'unwt - hab')
quick_plot(d_unwt_atrisk, main = 'unwt - atrisk')
quick_plot(d_fvwt_hab,    main = 'fvwt - hab')
quick_plot(d_fvwt_atrisk, main = 'fvwt - atrisk')
quick_plot(d_hab_atrisk,  main = 'hab - atrisk')
```

### Compare values of rank differences

Check histograms of the various difference plots

```{r}
hist(d_unwt_fvwt,   main = 'unwt - fvwt')
hist(d_unwt_hab,    main = 'unwt - hab')
hist(d_unwt_atrisk, main = 'unwt - atrisk')
hist(d_fvwt_hab,    main = 'fvwt - hab')
hist(d_fvwt_atrisk, main = 'fvwt - atrisk')
hist(d_hab_atrisk,  main = 'hab - atrisk')
```

### Linear regression of ranks

#### Unweighted vs FV-weighted

```{r}
rank_df <- data.frame(hab     = values(rank_hab),
                      unwt    = values(rank_unwt),
                      fvwt    = values(rank_fvwt),
                      # atrisk  = values(rank_atrisk),
                      coastal = values(neritic),
                      cell_id = 1:ncell(rank_unwt)) %>%
  mutate(coastal = is.na(coastal)) %>%
  drop_na()

lm_unwt_fvwt <- lm(unwt ~ fvwt, data = rank_df)
summary(lm_unwt_fvwt)
```

#### Unweighted vs hab

```{r}
lm_unwt_hab <- lm(unwt ~ hab, data = rank_df)
summary(lm_unwt_hab)
```

#### Unweighted vs at-risk

```{r}
lm_unwt_atrisk <- lm(unwt ~ atrisk, data = rank_df)
summary(lm_unwt_atrisk)
```

#### FV-weighted vs hab

```{r}
lm_fvwt_hab <- lm(fvwt ~ hab, data = rank_df)
summary(lm_fvwt_hab)
```

#### FV-weighted vs at-risk

```{r}
lm_fvwt_atrisk <- lm(fvwt ~ atrisk, data = rank_df)
summary(lm_fvwt_atrisk)
```

#### Hab vs at-risk

```{r}
lm_hab_atrisk <- lm(hab ~ atrisk, data = rank_df)
summary(lm_hab_atrisk)
```



