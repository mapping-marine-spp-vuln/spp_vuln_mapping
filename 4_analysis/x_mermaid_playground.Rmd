---
title: "trying the mermaidr package"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 4, fig.width = 7)

library(terra)
library(oharac)
library(data.table)
library(tidyverse)
library(here)
library(mermaidr) # remotes::install_github("data-mermaid/mermaidr")
source(here('common_fxns.R'))
```

# Summary

Gather coral cover and fish biomass data from MERMAID sites for potential groundtruthing.

# Data

Data taken from MERMAID using the `mermaidr` package.

* Gelfand S (2022). mermaidr: Interface to the 'MERMAID' API. https://data-mermaid.github.io/mermaidr, https://github.com/data-mermaid/mermaidr.

```
@Manual{,
  title = {mermaidr: Interface to the 'MERMAID' API},
  author = {Sharla Gelfand},
  year = {2022},
  note = {https://data-mermaid.github.io/mermaidr, https://github.com/data-mermaid/mermaidr},
}
```

# Methods

Using the mermaidr package, access all public and public summary projects, then collect sample events for fish biomass, hard coral cover, and soft coral cover (both line intersect transects and point intersect transects - PIT seems to have more data).

Data contain lat-long values and years; check that observations fall within recent years, then transform the lat long to the Mollweide projection and identify which cell numbers correspond to the observations.

Classify observations as done for MERMAID:

* Hard coral: < 10% is bad; > 30% is good.
* Soft coral?
* Fish biomass: < 500 kg/ha is bad; > 500 kg/ha is good

## Fish biomass

```{r}
# mermaid_auth()
# mermaid_token()
all_prj <- mermaid_get_projects(limit = NULL)

beltfish_file <- here('_data/mermaid/beltfish_data.csv')
if(!file.exists(beltfish_file)) {
  public_beltfish_prj <- all_prj %>%
    filter(data_policy_beltfish != 'Private')
  
  chunk_size <- 20
  n_chunks <- ceiling(nrow(public_beltfish_prj) / chunk_size)
  tmp_outstem <- here('tmp/mermaid_beltfish_chunk_%s.csv')
  
  for(i in 1:n_chunks) {
    tmp_outf <- sprintf(tmp_outstem, i)
    if(!file.exists(tmp_outf)) {
      message('Processing chunk ', i, ': ', basename(tmp_outf))
      ### i <- 1
      i_chunk <- (chunk_size * (i - 1) + 1) : (chunk_size * i)
      
      pub_beltfish_chunk <- mermaid_get_project_data(
        project = public_beltfish_prj %>%
          slice(i_chunk), 
        method = 'fishbelt', data = 'sampleevents', token = NULL) %>%
        select(project, country, site, 
               latitude, longitude, 
               sample_date, biomass_kgha_avg)
      write_csv(pub_beltfish_chunk, tmp_outf)
    }
  }
  
  beltfish_all <- list.files(here('tmp'), pattern = 'mermaid_beltfish_chunk', 
                             full.names = TRUE) %>%
    lapply(read_csv) %>%
    bind_rows()
  
  write_csv(beltfish_all, beltfish_file)
}
```

## Point intercept transect coral cover

``` {r}
benthic_pit_file <- here('_data/mermaid/benthic_pit_data.csv')
if(!file.exists(benthic_pit_file)) {
  public_benthic_pit_prj <- all_prj %>%
    filter(data_policy_benthicpit != 'Private')
  
  chunk_size <- 20
  n_chunks <- ceiling(nrow(public_benthic_pit_prj) / chunk_size)
  tmp_outstem <- here('tmp/mermaid_benthic_pit_chunk_%s.csv')
  
  for(i in 1:n_chunks) {
    ### i <- 1
    tmp_outf <- sprintf(tmp_outstem, i)
    if(!file.exists(tmp_outf)) {
      message('Processing chunk ', i, ': ', basename(tmp_outf))
      ### i <- 1
      i_chunk <- (chunk_size * (i - 1) + 1) : (chunk_size * i)
      
      public_benthic_pit_chunk <- mermaid_get_project_data(
        project = public_benthic_pit_prj %>%
          slice(i_chunk), 
        method = 'benthicpit', data = 'sampleevents', token = NULL) %>%
        select(project, country, site, 
               latitude, longitude, 
               sample_date, 
               hard_coral_pit = percent_cover_benthic_category_avg_hard_coral,
               soft_coral_pit = percent_cover_benthic_category_avg_soft_coral)
      write_csv(public_benthic_pit_chunk, tmp_outf)
    }
  }
  
  benthic_pit_all <- list.files(here('tmp'), pattern = 'mermaid_benthic_pit_chunk', 
                             full.names = TRUE) %>%
    lapply(read_csv) %>%
    bind_rows()
  
  write_csv(benthic_pit_all, benthic_pit_file)
}
```

## Line intercept transect coral cover

``` {r}

benthic_lit_file <- here('_data/mermaid/benthic_lit_data.csv')

if(!file.exists(benthic_lit_file)) {
  public_benthic_lit_prj <- all_prj %>%
    filter(data_policy_benthiclit != 'Private')
  
  chunk_size <- 20
  n_chunks <- ceiling(nrow(public_benthic_lit_prj) / chunk_size)
  tmp_outstem <- here('tmp/mermaid_benthic_lit_chunk_%s.csv')
  
  for(i in 1:n_chunks) {
    ### i <- 2
    tmp_outf <- sprintf(tmp_outstem, i)
    if(!file.exists(tmp_outf)) {
      message('Processing chunk ', i, ': ', basename(tmp_outf))
      ### i <- 1
      i_chunk <- (chunk_size * (i - 1) + 1) : (chunk_size * i)
      
      public_benthic_lit_chunk <- mermaid_get_project_data(
        project = public_benthic_lit_prj %>%
          slice(i_chunk), 
        method = 'benthiclit', data = 'sampleevents', token = NULL) 
      if(nrow(public_benthic_lit_chunk) > 0) {
        public_benthic_lit_chunk <- public_benthic_lit_chunk%>%
          select(project, country, site, 
                 latitude, longitude, 
                 sample_date, 
                 hard_coral_lit = percent_cover_benthic_category_avg_hard_coral,
                 soft_coral_lit = percent_cover_benthic_category_avg_soft_coral)
      } else public_benthic_lit_chunk <- data.frame()
      write_csv(public_benthic_lit_chunk, tmp_outf)
    }
  }
  
  benthic_lit_all <- list.files(here('tmp'), pattern = 'mermaid_benthic_lit_chunk', 
                             full.names = TRUE) %>%
    lapply(read_csv) %>%
    bind_rows()
  
  write_csv(benthic_lit_all, benthic_lit_file)
}
```

