---
title: "Compare cumulative impacts per species to IUCN status"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(here)
library(oharac)
source(here('common_fxns.R'))

```

# Summary

Calculate the cumulative impact across each species range (total and coastal-only).  Relative CHI will be the total CHI (summed across all cells and all stressors) normalized by the total range (total and coastal-only).  The relative CHI is effectively the average CHI per km^2^ across the species' range.

Perform a regression of IUCN extinction risk classification as a function of relative overall CHI and overall range, and then do the same for coastal.

# Data

* Species impact scores from script 6
* IUCN extinction risk scores from IUCN

# Methods

## Read in species impacts for those spp assessed by IUCN; summarize to CHI

Summarize to cumulative impacts by entire range and by coastal range.

Each file has a row for each stressor-vulnerability match; columns are:

* `str_vuln` (chr): name of stressor/vuln combo, as <str>-<vuln>
* `impact_tot` (dbl): sum across all cells of stressor intensity $\times$ vulnerability $\times$ ocean area
* `impact_coastal` (dbl): sum across all coastal cells (â‰¤200m) of stressor intensity $\times$ vulnerability $\times$ ocean area
* `range_tot_km2` (dbl): sum of ocean area of all cells across entire range
* `range_coastal_km2` (dbl): sum of ocean area of all cells across coastal range


```{r}
spp_chi_file <- here_anx('int/spp_chi_summary.csv')

if(!file.exists(spp_chi_file)) { ### unlink(spp_chi_file)
  spp_imp_fs <- list.files(here_anx('impacts_by_species'), 
                           pattern = '^impacts_.+.csv', full.names = TRUE)
  
  spp_imp_raw_df <- parallel::mclapply(spp_imp_fs, mc.cores = 40,
                                       data.table::fread) %>%
    setNames(basename(spp_imp_fs)) %>%
    data.table::rbindlist(idcol = 'f') %>%
    rename(vuln = vulnerability)
  
  spp_ranges <- spp_imp_raw_df %>%
    select(f, range_km2, range) %>%
    distinct() %>%
    spread(range, range_km2) %>%
    rename(range_cst_km2 = coastal, range_tot_km2 = full)
  
  spp_intensity_df <- spp_imp_raw_df %>%
    select(f, vuln, stressor, intensity_tot, range) %>%
    spread(range, intensity_tot) %>%
    rename(intensity_tot = full, intensity_cst = coastal)
    
  spp_intens_cv_df <- spp_imp_raw_df %>%
    select(f, vuln, stressor, intensity_cv, range) %>%
    spread(range, intensity_cv) %>%
    rename(intensity_cv_tot = full, intensity_cv_cst = coastal)

  spp_impacts_df <- spp_imp_raw_df %>%
    select(f, vuln, stressor, impact_tot, range) %>%
    spread(range, impact_tot) %>%
    rename(impact_tot = full, impact_cst = coastal)
    
  spp_cv_df <- spp_imp_raw_df %>%
    select(f, vuln, stressor, impact_cv, range) %>%
    spread(range, impact_cv) %>%
    rename(impact_cv_tot = full, impact_cv_cst = coastal)

  spp_impacts_npp_df <- spp_imp_raw_df %>%
    select(f, vuln, stressor, impact_npp_tot, range) %>%
    spread(range, impact_npp_tot) %>%
    rename(impact_npp_tot = full, impact_npp_cst = coastal)
    
  spp_npp_cv_df <- spp_imp_raw_df %>%
    select(f, vuln, stressor, impact_npp_cv, range) %>%
    spread(range, impact_npp_cv) %>%
    rename(impact_npp_cv_tot = full, impact_npp_cv_cst = coastal)

  iucn_worms_lookup <- read_csv(here('_data/iucn_spp', 'iucn_to_worms_match.csv'))

  spp_imp_cv_df <- full_join(spp_impacts_df, spp_cv_df, 
                             by = c('f', 'vuln', 'stressor')) %>%
    full_join(spp_impacts_npp_df, by = c('f', 'vuln', 'stressor')) %>%
    full_join(spp_npp_cv_df, by = c('f', 'vuln', 'stressor')) %>%
    full_join(spp_intensity_df, by = c('f', 'vuln', 'stressor')) %>%
    full_join(spp_intens_cv_df, by = c('f', 'vuln', 'stressor')) %>%
    left_join(spp_ranges, by = 'f') %>%
    ### extract species and map info from filename
    mutate(map_src = str_extract(f, '_iucn_|_am_') %>% str_remove_all('_'),
           iucn_sid = str_extract(f, '[0-9]+') %>% as.integer(),
           spp_from_f = str_remove_all(f, 'impacts_(am|iucn)_|.csv')) %>%
    left_join(iucn_worms_lookup, by = 'iucn_sid') %>%
    mutate(sciname = ifelse(is.na(worms_name), 
                            str_replace_all(spp_from_f, '_', ' '),
                            worms_name)) %>%
    ### append iucn_sid for spp not mapped in IUCN but mapped in AM:
    left_join(iucn_worms_lookup %>% select(sciname = worms_name, iucn_sid2 = iucn_sid),
              by = c('sciname')) %>%
    mutate(iucn_sid = ifelse(is.na(iucn_sid), iucn_sid2, iucn_sid)) %>%
    select(sciname, iucn_sid, map_src, vuln, stressor, 
           impact_cst, impact_tot, impact_cv_cst, impact_cv_tot,
           impact_npp_cst, impact_npp_tot, 
           impact_npp_cv_cst, impact_npp_cv_tot,
           intensity_cst, intensity_tot, 
           intensity_cv_cst, intensity_cv_tot,
           range_cst_km2, range_tot_km2) %>%
    distinct() %>%
    filter(range_tot_km2 > 0 & !is.na(impact_tot))
    
  write_csv(spp_imp_cv_df, spp_chi_file)
}
```

## Examine means across taxa

```{r}
vuln_taxa <- get_spp_vuln() %>%
  select(species, taxon) %>%
  distinct()

spp_impacts <- read_csv(spp_chi_file) %>%
  filter(range_tot_km2 > 10000)

spp_chi <- spp_impacts %>%
  filter(stressor == 'cumulative') %>%
  mutate(eq_wt  = impact_tot / range_tot_km2,
         npp_wt = impact_npp_tot / range_tot_km2) %>%
  select(sciname, eq_wt, npp_wt, range_tot_km2) %>%
  distinct() %>%
  mutate(group = 'cumulative')

spp_no_cc <- spp_impacts %>%
  filter(vuln == 'stressor_group' & stressor != 'climate') %>%
  select(sciname, impact_tot, impact_npp_tot, range_tot_km2) %>%
  distinct() %>%
  mutate(imp_unwt_tot = impact_tot / range_tot_km2,
         imp_nppwt_tot = impact_npp_tot / range_tot_km2) %>%
  group_by(sciname) %>%
  summarize(eq_wt  = sum(imp_unwt_tot), 
            npp_wt = sum(imp_nppwt_tot),
            range_tot_km2 = first(range_tot_km2)) %>%
  mutate(group = 'non-climate')

cum_plus_non_cc <- bind_rows(spp_chi, spp_no_cc) %>%
  left_join(vuln_taxa, by = c('sciname' = 'species')) %>%
  gather(type, mean_imp, eq_wt, npp_wt) %>%
  filter(!is.na(taxon))

taxon_order <- cum_plus_non_cc %>%
  filter(type == 'eq_wt') %>%
  group_by(taxon) %>%
  summarize(med_imp = median(mean_imp)) %>%
  arrange(med_imp) %>%
  .$taxon

plot_df <- cum_plus_non_cc %>%
  mutate(taxon = factor(taxon, levels = taxon_order)) %>%
  mutate(type = factor(type, levels = c('npp_wt', 'eq_wt')))

ggplot(plot_df, 
       aes(y = taxon, x = mean_imp)) +
  geom_boxplot(aes(color = type), 
               outlier.size = .1) +
  theme_minimal() +
  facet_wrap( ~ group)

ggplot(plot_df, aes(x = log10(range_tot_km2), y = mean_imp)) +
  geom_point(aes(color = type), alpha = .3) +
  theme_minimal() +
  facet_grid(type ~ group)

```

```{r}
summary_by_taxon <- cum_plus_non_cc %>%
  group_by(taxon, type, group) %>%
  summarize(mu_tot = mean(mean_imp) %>% round(4),
            sd_tot = sd(mean_imp) %>% round(4)) %>%
  arrange(group, type, desc(mu_tot))

DT::datatable(summary_by_taxon)
```


### Assemble IUCN Red List categories for species in IUCN maps and AquaMaps maps

``` {r}
iucn_worms_lookup <- read_csv(here('_data/iucn_spp', 'iucn_to_worms_match.csv'),
                              show_col_types = FALSE)

iucn_comp <- read_csv(here('_data/iucn_spp/iucn_comp_assessed_2021-3.csv'))
iucn_assessed <- read_csv(here('_data/iucn_spp/iucn_marine_spp_info_2021-3.csv'),
                              show_col_types = FALSE) %>%
  filter(iucn_sid %in% iucn_comp$iucn_sid) %>%
  select(iucn_sid, cat, cat_score) %>%
  left_join(iucn_worms_lookup, by = 'iucn_sid') %>%
  mutate(threatened = case_when(cat == 'dd' ~ NA,
                                cat %in% c('lc', 'nt') ~ FALSE,
                                TRUE ~ TRUE),
         atrisk     = case_when(cat == 'dd' ~ NA,
                                cat %in% c('lc') ~ FALSE,
                                TRUE ~ TRUE)) %>%
  select(iucn_sid, iucn_sciname = sciname, sciname = worms_name, 
         cat, cat_score, threatened, atrisk)

```

### Combine IUCN categories with impacts

``` {r}
iucn_impacts_df <- read_csv(spp_chi_file,
                            show_col_types = FALSE) %>%
  inner_join(iucn_assessed, by = c('iucn_sid', 'sciname')) %>%
  mutate(iucn_fct = toupper(cat),
         iucn_fct = factor(iucn_fct, levels = c('LC', 'NT', 'VU', 'EN', 'CR', 'EX', 'DD')))

check_df <- iucn_impacts_df %>%
  select(sciname, iucn_sid, map_src) %>%
  distinct() %>%
  janitor::get_dupes(sciname)

spp_taxa <- assemble_worms() %>%
  select(sciname = species, phylum, class, order, family) %>%
  distinct() %>%
  inner_join(get_spp_vuln() %>% 
             select(sciname = species, taxon) %>% 
             distinct())

fished_spp <- iucn_impacts_df %>%
  filter(stressor == 'biomass_removal') %>%
  mutate(fished = impact_cst > 0 | impact_tot > 0) %>%
  select(sciname, iucn_sid, fished)

# traits <- get_spp_traits()

spp_chi_iucn_clean <- iucn_impacts_df %>%
  filter(stressor == 'cumulative') %>%
  mutate(chi_rel_tot = impact_tot / range_tot_km2,
         chi_rel_cst = impact_cst / range_cst_km2,
         chi_npp_tot = impact_npp_tot / range_tot_km2,
         chi_npp_cst = impact_npp_cst / range_cst_km2) %>%
  filter(!is.na(threatened)) %>%
  left_join(spp_taxa, by = 'sciname') %>%
  left_join(fished_spp, by = c('sciname', 'iucn_sid'))
```

## Binomial logistic regression - CHI

Perform a binomial logistic regression of threatened status (threatened/not threatened) as a function of mean cumulative impact and range.  Set up data frame to include a `threatened` column, where LC and NT are `FALSE` and VU, EN, and CR are `TRUE`.  Include range as inverse log of range, for both overall range and coastal-only range.

### Prob of threatened = TRUE as function of CHI and range

```{r}

chi_threatened_valid <- spp_chi_iucn_clean %>%
  filter(!is.na(threatened)) %>%
  mutate(log_r_tot  = log(range_tot_km2),
         log_r_cst  = log(range_cst_km2)) %>%
  left_join(get_fe_traits(), by = c('sciname' = 'species'))

```

```{r}

```

``` {r}
df_for_blr_chi <- chi_threatened_valid %>%
  select(sciname, taxon, phylum, class, atrisk, threatened, 
         starts_with('impact'), starts_with('chi'), 
         starts_with('log'), starts_with('range'),
         mob, len, wcol, trp) %>%
  distinct() %>%
  mutate(qtile_r = ntile(range_tot_km2, n = 5)) %>%
  drop_na()

df_for_blr_chi %>% group_by(qtile_r) %>% summarize(r = max(range_tot_km2))

### across all spp, coastal ranges, NPP-weighted mean and CV
mdl1 <- glm(threatened ~ chi_npp_cst + impact_npp_cv_cst + log_r_cst, 
           data = df_for_blr_chi %>% filter(qtile_r <= 4),
           family = 'binomial')
summary(mdl1) ### AIC 3952.8
#                   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       -1.57527    0.27181  -5.795 6.81e-09 ***
# chi_npp_cst        0.83270    0.14445   5.765 8.18e-09 ***
# impact_npp_cv_cst  0.20509    0.04959   4.136 3.53e-05 ***
# log_r_cst         -0.06907    0.01770  -3.902 9.52e-05 ***
with(summary(mdl1), 1 - deviance/null.deviance) ### McFadden's R^2
# 0.01617018

### similar but total ranges rather than coastal ranges
mdl2 <- glm(threatened ~ chi_npp_tot + impact_npp_cv_tot + log_r_tot, 
           data = df_for_blr_chi %>% filter(qtile_r <= 4),
           family = 'binomial')
summary(mdl2) ### AIC 3942.1
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       -1.14481    0.26082  -4.389 1.14e-05 ***
# chi_npp_tot        0.95255    0.15677   6.076 1.23e-09 ***
# impact_npp_cv_tot  0.13939    0.03849   3.622 0.000293 ***
# log_r_tot         -0.08957    0.01853  -4.835 1.33e-06 ***
with(summary(mdl2), 1 - deviance/null.deviance)
# 0.01885638

mdl2a <- glm(threatened ~ chi_npp_tot + impact_npp_cv_tot + log_r_tot, 
           data = df_for_blr_chi %>% filter(qtile_r <= 5),
           family = 'binomial')
summary(mdl2a) ### AIC not comparable to qtile <= 4 version...
#                   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       -2.17066    0.21657 -10.023  < 2e-16 ***
# chi_npp_tot        0.98133    0.15286   6.420 1.37e-10 ***
# impact_npp_cv_tot  0.23103    0.02869   8.053 8.05e-16 ***
# log_r_tot         -0.02551    0.01462  -1.745    0.081 .  
with(summary(mdl2a), 1 - deviance/null.deviance)
# 0.01651841

### NPP-weighted mean CHI, drop CV term, (log_r term
### becomes insignificant when including top 20%)
mdl3 <- glm(threatened ~ chi_npp_tot + log_r_tot, 
           data = df_for_blr_chi %>% 
             filter(qtile_r <= 4),
           family = 'binomial')
summary(mdl3) ### AIC 3952.4
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.77482    0.23767  -3.260  0.00111 ** 
# chi_npp_tot  0.83066    0.15098   5.502 3.76e-08 ***
# log_r_tot   -0.08170    0.01825  -4.478 7.55e-06 ***
with(summary(mdl3), 1 - deviance/null.deviance)
# 0.01578526

### Unweighted CHI (not NPP weighted), with no CV term - flips sign on CHI
mdl4 <- glm(threatened ~ chi_rel_tot + log_r_tot, 
           data = df_for_blr_chi %>% 
             filter(qtile_r <= 4),
           family = 'binomial')
summary(mdl4) ### AIC 3978.1
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  0.10585    0.28015   0.378   0.7056    
# chi_rel_tot -0.50470    0.22148  -2.279   0.0227 *  
# log_r_tot   -0.12226    0.01978  -6.180 6.42e-10 ***
with(summary(mdl4), 1 - deviance/null.deviance)
# 0.009358484

```

For all these models, dropping the top 20% of range improves the significance of coefficient on the log range term, though all models show significance on the other terms when all range is included.

Models 1 and 2, threatened ~ NPP-weighted mean CHI + NPP-weighted CV + inv log range, show a significant positive correlation of mean CHI with threatened status and negative correlation of log range for species in the bottom 80% of range; Model 1 uses the coastal range only, while Model 2 uses the entire range (though coastal-only species will be identical in both datasets).  Model 3 drops the CV term and still shows a positive correlation of mean CHI (full range) and negative on log range.  Model 4 includes non-NPP-weighted CHI, and shows a slightly significant but *negative* correlation on CHI.

Logically, the NPP-weighted CHI is the more appropriate comparison, as areas with greater NPP are likely to have greater abundances of spp and/or be of greater ecological importance to the species (e.g., feeding grounds); therefore impacts on those areas seem likely to cause greater problems for the population.


### Predictive power?

Do models 1, 2, or 3 have any reasonable predictive power?

```{r}

pred_1 <- df_for_blr_chi %>%
  filter(qtile_r <= 4) %>%
  mutate(prob_thr = predict(mdl1, type = 'response')) %>%
  mutate(pred_thr = prob_thr >= .5,
         correct = threatened == pred_thr)

table(pred_1 %>% select(pred_thr, threatened))
#         threatened
# pred_thr FALSE TRUE
#    FALSE  3563  748
#    TRUE      9    8

pred_2 <- df_for_blr_chi %>%
  filter(qtile_r <= 4) %>%
  mutate(prob_thr = predict(mdl2, type = 'response')) %>%
  mutate(pred_thr = prob_thr >= .5,
         correct = threatened == pred_thr)

table(pred_2 %>% select(pred_thr, threatened))
#         threatened
# pred_thr FALSE TRUE
#    FALSE  3558  747
#    TRUE     14    9

pred_3 <- df_for_blr_chi %>%
  filter(qtile_r <= 4) %>%
  mutate(prob_thr = predict(mdl3, type = 'response')) %>%
  mutate(pred_thr = prob_thr >= .5,
         correct = threatened == pred_thr)

table(pred_3 %>% select(pred_thr, threatened))


### Proportion correct
prop_correct1 <- sum(pred_1$correct) / nrow(pred_1)
# .825
prop_correct2 <- sum(pred_2$correct) / nrow(pred_2)
# .824
prop_correct3 <- sum(pred_3$correct) / nrow(pred_3)
# .826

### does it predict better than random guessing given the proportion of
### threatened being known?
prop_thr <- sum(pred_1$threatened) / nrow(pred_1)
pred_acc <- prop_thr^2 + (1 - prop_thr)^2
# .712; better than random guessing even if proportion is known

### does it predict better than the "zero rule"?
zero_rule <- sum(1 - pred_1$threatened) / nrow(pred_1)
# .825; about the same as choosing the zero rule...
```

Predictive power of this model is not great...


## Binomial logistic regression - by stressor group

Perform a binomial logistic regression of threatened status (threatened/not threatened) as a function of mean cumulative impact and range.  Set up data frame to include a `threatened` column, where LC and NT are `FALSE` and VU, EN, and CR are `TRUE`.  Include range as linear rescale (0-1) and square root of range, for both overall range and coastal-only range.

### Prob of threatened = TRUE as function of impact categories and range

Use the simple model from model 3 above, threatened ~ npp-weighted impact +  log range, but impact by stressor group rather than cumulative.

```{r}
qtile_df <- iucn_impacts_df %>%
  filter(!is.na(threatened)) %>%
  select(sciname, threatened, range_tot_km2) %>%
  distinct() %>%
  mutate(qtile_r = ntile(range_tot_km2, n = 5)) %>%
  select(sciname, threatened, qtile_r)

df_for_blr_gps <- iucn_impacts_df %>%
  filter(!is.na(threatened)) %>%
  filter(vuln == 'stressor_group') %>%
  select(sciname, atrisk, threatened, 
         stressor, vuln, impact_npp_tot, range_tot_km2) %>%
  distinct() %>%
  spread(key = stressor, value = impact_npp_tot) %>%
  mutate(log_r_tot = log(range_tot_km2)) %>%
  left_join(qtile_df, by = c('sciname', 'threatened'))

mdl5 <- glm(formula = threatened ~ land_based + ocean_based + fishing + climate + log_r_tot, 
             data = df_for_blr_gps, family = 'binomial')
summary(mdl5)
#               Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.047e+00  1.925e-01  -5.438 5.38e-08 ***
# land_based   4.022e-08  4.103e-07   0.098 0.921901    
# ocean_based  7.823e-07  1.863e-07   4.200 2.67e-05 ***
# fishing      8.215e-07  1.780e-07   4.615 3.92e-06 ***
# climate     -5.716e-08  1.621e-08  -3.526 0.000422 ***
# log_r_tot   -3.173e-02  1.530e-02  -2.074 0.038083 *  
```

