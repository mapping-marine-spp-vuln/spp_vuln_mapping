---
title: "Compare cumulative impacts per species to IUCN status"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
library(tidyverse)
library(here)
library(RColorBrewer)
library(oharac)
source(here('common_fxns.R'))

```

# Summary

Calculate the cumulative impact across each species range (total and coastal-only).  Relative CHI will be the total CHI (summed across all cells and all stressors) normalized by the total range (total and coastal-only).  The relative CHI is effectively the average CHI per km^2^ across the species' range.

Perform a regression of IUCN extinction risk classification as a function of relative overall CHI and overall range, and then do the same for coastal.

# Data

* Species impact scores from script 5
* IUCN extinction risk scores from IUCN

# Methods

## Read in species impacts for those spp assessed by IUCN; summarize to CHI

Summarize to cumulative impacts by entire range and by coastal range.

Each file has a row for each stressor-vulnerability match; columns are:

* `str_vuln` (chr): name of stressor/vuln combo, as <str>-<vuln>
* `impact_tot` (dbl): sum across all cells of stressor intensity $\times$ vulnerability $\times$ ocean area
* `impact_coastal` (dbl): sum across all coastal cells (≤200m) of stressor intensity $\times$ vulnerability $\times$ ocean area
* `range_tot_km2` (dbl): sum of ocean area of all cells across entire range
* `range_coastal_km2` (dbl): sum of ocean area of all cells across coastal range


```{r}
spp_chi_file <- here_anx('int/spp_chi_summary.csv')

if(!file.exists(spp_chi_file)) {
  spp_imp_fs <- list.files(here_anx('impacts_by_species'), 
                           pattern = '^impacts_.+.csv', full.names = TRUE)
  
  spp_imp_df <- parallel::mclapply(spp_imp_fs, mc.cores = 40,
                                   read_csv, show_col_types = FALSE) %>%
    setNames(basename(spp_imp_fs)) %>%
    bind_rows(.id = 'f')
  
  spp_ranges <- spp_imp_df %>%
    select(f, range_km2, range) %>%
    distinct() %>%
    spread(range, range_km2) %>%
    rename(range_cst_km2 = coastal, range_tot_km2 = full)
  
  iucn_worms_lookup <- read_csv(here('_data/iucn_spp', 'iucn_to_worms_match.csv'))

  spp_impacts_df <- spp_imp_df %>%
    select(-range_km2) %>%
    spread(range, impact_tot) %>%
    rename(impact_tot = full, impact_cst = coastal) %>%
    left_join(spp_ranges, by = 'f') %>%
    ### extract species and map info from filename
    mutate(map_src = str_extract(f, '_iucn_|_am_') %>% str_remove_all('_'),
           iucn_sid = str_extract(f, '[0-9]+') %>% as.integer(),
           spp_from_f = str_remove_all(f, 'impacts_(am|iucn)_|.csv')) %>%
    left_join(iucn_worms_lookup, by = 'iucn_sid') %>%
    mutate(sciname = ifelse(is.na(worms_name), 
                            str_replace_all(spp_from_f, '_', ' '),
                            worms_name)) %>%
    select('sciname', 'iucn_sid', 'map_src', 'vuln', 'stressor', 
           'impact_cst', 'impact_tot', 'range_cst_km2', 'range_tot_km2') %>%
    distinct() %>%
    filter(range_tot_km2 > 0 & !is.na(impact_tot))
    
  write_csv(spp_impacts_df, spp_chi_file)
}
```

### Assemble IUCN Red List categories for species in IUCN maps and AquaMaps maps

``` {r}
iucn_worms_lookup <- read_csv(here('_data/iucn_spp', 'iucn_to_worms_match.csv'))

iucn_assessed <- read_csv(here('_data/iucn_spp/iucn_marine_spp_info_2021-3.csv')) %>%
  select(iucn_sid, cat, cat_score) %>%
  left_join(iucn_worms_lookup, by = 'iucn_sid') %>%
  mutate(threatened = cat %in% c('vu', 'en', 'cr', 'ex'),
         atrisk     = cat %in% c('nt', 'vu', 'en', 'cr', 'ex')) %>%
  select(iucn_sid, iucn_sciname = sciname, sciname = worms_name, cat, cat_score, threatened, atrisk)
iucn_mapped <- read_csv(here('_data/iucn_spp/spp_marine_maps_2021-3.csv'))

assessed_in_am <- get_am_spp_info() %>%
  select(am_sid, am_sciname, sciname, iucn_sid) %>%
  inner_join(iucn_assessed %>% 
               select(iucn_sid, cat, threatened, atrisk) %>% distinct(), 
             by = 'iucn_sid') %>%
  select(sciname, cat, threatened, atrisk) %>%
  distinct() %>%
  mutate(map_src = 'am',
         iucn_sid = -1)

assessed_in_iucn_maps <- iucn_assessed %>%
  filter(iucn_sid %in% iucn_mapped$iucn_sid) %>%
  select(sciname, iucn_sid, cat, threatened, atrisk) %>%
  distinct() %>%
  mutate(map_src = 'iucn')

assessed_df <- bind_rows(assessed_in_am, assessed_in_iucn_maps)

```

### Combine IUCN categories with impacts

``` {r}
iucn_impacts_df <- read_csv(spp_chi_file) %>%
  mutate(iucn_sid = ifelse(is.na(iucn_sid), -1, iucn_sid)) %>%
  inner_join(assessed_df, by = c('sciname', 'iucn_sid', 'map_src')) %>%
  mutate(iucn_fct = toupper(cat),
         iucn_fct = factor(iucn_fct, levels = c('LC', 'NT', 'VU', 'EN', 'CR', 'EX', 'DD')))

check_df <- iucn_impacts_df %>%
  select(sciname, iucn_sid, map_src) %>%
  distinct() %>%
  group_by(sciname) %>%
  summarize(n = n(),
            map_src = paste(map_src, collapse = ';'))
  
```

## Try some simple tests

### Examine average CHI across different categories of extinction risk

```{r}
spp_chi_iucn_clean <- iucn_impacts_df %>%
  filter(stressor == 'cumulative') %>%
  mutate(chi_rel_tot = impact_tot / range_tot_km2,
         chi_rel_cst = impact_cst / range_cst_km2)

chi_by_cat <- spp_chi_iucn_clean %>%
  group_by(iucn_fct, map_src) %>%
  summarize(mean_tot_chi = mean(chi_rel_tot), sd_tot_chi = sd(chi_rel_tot),
            mean_cst_chi = mean(chi_rel_cst, na.rm = TRUE), sd_cst_chi = sd(chi_rel_cst, na.rm = TRUE),
            n_spp_tot = n(),
            n_spp_cst = sum(!is.na(chi_rel_cst)))

knitr::kable(chi_by_cat, digits = 4)

```


``` {r}

ggplot(spp_chi_iucn_clean) +
  geom_density(aes(x = chi_rel_tot, color = iucn_fct, fill = iucn_fct, ..scaled..),
               alpha = .3) +
  geom_vline(data = chi_by_cat, aes(xintercept = mean_tot_chi, color = iucn_fct)) +
  theme_minimal()

ggplot(spp_chi_iucn_clean) +
  geom_density(aes(x = chi_rel_cst, color = iucn_fct, fill = iucn_fct, ..scaled..),
               alpha = .3) +
  geom_vline(data = chi_by_cat, aes(xintercept = mean_cst_chi, color = iucn_fct)) +
  theme_minimal()
  
```

The means by risk category seem very clustered together and not in any particular order...

### Examine average CHI for threatened vs non-threatened

```{r}

chi_by_threatened <- spp_chi_iucn_clean %>%
  group_by(threatened, map_src) %>%
  summarize(mean_tot_chi = mean(chi_rel_tot), sd_tot_chi = sd(chi_rel_tot),
            mean_cst_chi = mean(chi_rel_cst, na.rm = TRUE), sd_cst_chi = sd(chi_rel_cst, na.rm = TRUE),
            n_spp_tot = n(),
            n_spp_cst = sum(!is.na(chi_rel_cst)))

knitr::kable(chi_by_threatened, digits = 4)
```

``` {r}
ggplot(spp_chi_iucn_clean) +
  geom_density(aes(x = chi_rel_tot, color = threatened, fill = threatened, ..scaled..),
               alpha = .3) +
  geom_vline(data = chi_by_threatened, aes(xintercept = mean_tot_chi, color = threatened)) +
  theme_minimal()

ggplot(spp_chi_iucn_clean) +
  geom_density(aes(x = chi_rel_cst, color = threatened, fill = threatened, ..scaled..),
               alpha = .3) +
  geom_vline(data = chi_by_threatened, aes(xintercept = mean_cst_chi, color = threatened)) +
  theme_minimal()
  
```

As for category, means by threatened/not-threatened seem very clustered together and not in any particular order...

### examine CHI by range

```{r}
ggplot(spp_chi_iucn_clean, aes(x = range_tot_km2, y = impact_tot)) +
  geom_point(aes(color = iucn_fct)) +
  geom_abline(slope = 1, intercept = 0, color = 'red', size = .5) +
  # scale_y_log10() +
  theme_minimal()

```

Technically possible for species to have higher total impacts than range, e.g., if high vulnerability (near 1) to multiple very intense stressor (near 1) across most of its range.

Questions:

* Are the spp near the 1:1 line due to cumulative effects, or dominated by a single stressor?  
* there seem to be a few "clusters" of slopes...

## Binomial logistic regression

Perform a binomial logistic regression of threatened status (threatened/not threatened) as a function of mean cumulative impact and range.  Set up data frame to include a `threatened` column, where LC and NT are `FALSE` and VU, EN, and CR are `TRUE`.  Include range as linear rescale (0-1) and square root of range, for both overall range and coastal-only range.

### Prob of threatened = TRUE as function of CHI and linear rescaled range

```{r}
chi_threatened_valid <- spp_chi_iucn_clean %>%
  filter(!is.na(threatened)) %>%
  mutate(r_tot_norm = range_tot_km2 / max(range_tot_km2),
         r_cst_norm = range_cst_km2 / max(range_cst_km2)) %>%
  mutate(inv_log_r_tot  = 1/log(range_tot_km2),
         inv_log_r_cst  = 1/log(range_cst_km2),
         inv_sqrt_r_tot = 1/sqrt(range_tot_km2),
         inv_sqrt_r_cst = 1/sqrt(range_cst_km2))

```

``` {r}
blr_mdl1_tot <- glm(threatened ~ chi_rel_tot + inv_sqrt_r_tot, 
                    data = chi_threatened_valid,
                    family = 'binomial')
summary(blr_mdl1_tot)
# Coefficients:
#                Estimate Std. Error z value Pr(>|z|)    
# (Intercept)    -2.02409    0.06324 -32.006  < 2e-16 ***
# chi_rel_tot    -1.23506    0.21450  -5.758 8.51e-09 ***
# inv_sqrt_r_tot 25.88438    2.63629   9.818  < 2e-16 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# (Dispersion parameter for binomial family taken to be 1)
# 
#     Null deviance: 7274.2  on 11551  degrees of freedom
# Residual deviance: 7161.7  on 11549  degrees of freedom
# AIC: 7167.7

blr_mdl1_cst <- glm(threatened ~ chi_rel_cst + inv_sqrt_r_cst, 
                    data = chi_threatened_valid,
                    family = 'binomial')
summary(blr_mdl1_cst)
# Coefficients:
#                Estimate Std. Error z value Pr(>|z|)    
# (Intercept)    -2.07659    0.06289 -33.022  < 2e-16 ***
# chi_rel_cst    -0.96569    0.20449  -4.722 2.33e-06 ***
# inv_sqrt_r_cst 21.26451    2.35908   9.014  < 2e-16 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# (Dispersion parameter for binomial family taken to be 1)
# 
#     Null deviance: 7263.9  on 11500  degrees of freedom
# Residual deviance: 7181.3  on 11498  degrees of freedom
#   (51 observations deleted due to missingness)
# AIC: 7187.3
```

### Prob of threatened = TRUE as function of CHI and square root range

```{r}

blr_mdl2_tot <- glm(threatened ~ chi_rel_tot + inv_log_r_tot, 
                    data = chi_threatened_valid,
                    family = 'binomial')
summary(blr_mdl2_tot)
# Coefficients:
#               Estimate Std. Error z value Pr(>|z|)    
# (Intercept)    -2.9653     0.1212 -24.458  < 2e-16 ***
# chi_rel_tot    -1.2617     0.2126  -5.934 2.96e-09 ***
# inv_log_r_tot  13.0842     1.3373   9.784  < 2e-16 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# (Dispersion parameter for binomial family taken to be 1)
# 
#     Null deviance: 7274.2  on 11551  degrees of freedom
# Residual deviance: 7162.5  on 11549  degrees of freedom
# AIC: 7168.5


blr_mdl2_cst <- glm(threatened ~ chi_rel_cst + inv_log_r_cst, 
                    data = chi_threatened_valid,
                    family = 'binomial')
summary(blr_mdl2_cst)
# Coefficients:
#               Estimate Std. Error z value Pr(>|z|)    
# (Intercept)    -2.9522     0.1188 -24.846  < 2e-16 ***
# chi_rel_cst    -0.9684     0.1998  -4.847 1.26e-06 ***
# inv_log_r_cst  11.7372     1.2858   9.128  < 2e-16 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# (Dispersion parameter for binomial family taken to be 1)
# 
#     Null deviance: 7263.9  on 11500  degrees of freedom
# Residual deviance: 7176.9  on 11498  degrees of freedom
#   (51 observations deleted due to missingness)
# AIC: 7182.9
```

All these models show a negative coefficient on cumulative impact - indicating that greater impacts predict LOWER probability of threatened status.  The large, positive, significant coefficients on inverse log range and inverse sqrt range are important for accounting for range size (small range size definitely seems to be correlated with threatened status).


### Compare threatened status to predicted threatened status

While all these models are not great, the first looks like a better predictor... let's see how it performs:
```{r}
blr_mdl1_tot_fitted <- blr_mdl1_tot %>%
  broom::augment(type.predict = 'response') %>%
  mutate(pred_thr = .fitted >= .50)

blr_mdl1_tot_fitted_summary <- blr_mdl1_tot_fitted %>%
  summarize(pct_thr_correct = sum(pred_thr & threatened) / n(),
            pct_nonthr_correct = sum(!pred_thr & !threatened) / n())

knitr::kable(blr_mdl1_tot_fitted_summary)

ggplot(data = blr_mdl1_tot_fitted, 
       aes(x = chi_rel_tot, y = .fitted)) +
  geom_point(aes(color = threatened)) +
  geom_smooth(aes(color = threatened), se = FALSE) +
  labs(x = "Average full-range CHI",
       y = "Probability of outcome Threatened")

ggplot(data = blr_mdl1_tot_fitted, 
       aes(x = inv_sqrt_r_tot, y = .fitted)) +
  geom_point(aes(color = threatened)) +
  geom_smooth(aes(color = threatened), se = FALSE) +
  labs(x = "Inverse sqrt total range",
       y = "Probability of outcome Threatened")

```

Clearly this model is not great.  Next steps:

Examine relationship to individual stressors, and by class.

