---
title: "Process shipping stressors"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
library(sf)
library(oharac)
oharac::setup()
source(here('common_fxns.R'))

```

# Summary

Process shipping stressors, including a layer for ship strikes and for noise pollution, to 10 km Mollweide CRS.  Also process benthic structures, including oil, gas, and wind farms.  Ship density is log-transformed per typical CHI methods - e.g., Halpern et al. 2019.

# Data

* Oil and gas structures: Data from: https://datacatalog.worldbank.org/search/dataset/0037580 (oil and gas layer)
    * Cite as: Cerdeiro, D. A., Komaromi, A., Liu, Y., & Saeed, M. (2020). World Seaborne Trade in Real Time: A Proof of Concept for Building AIS-based Nowcasts from Scratch (IMF Working Paper WP/20/57). International Monetary Fund.
* Offshore wind farms: Data from: https://www.4coffshore.com? 

# Methods

## Identify potential vessel types

From the .csvs of data over time, pull the 2020 data files, filter to just vessel types noting "rig" and the like.

``` {r}
vessel_data_dir <- "/home/shares/ohi/stressors_2021/_raw_data/Cerdeiro_2020_vessel_density/grid_message_count_annual/"

vessel_2020_fs <- list.files(file.path(vessel_data_dir, 'grid_message_count_2020'), full.names = TRUE)

vessel_type_df <- data.frame(f = vessel_2020_fs) %>%
  mutate(type = str_remove_all(basename(f), 'grid_message_count_2020_|.csv'),
         type = tolower(type))

### types: platform, rig, jack_up; consider mooring_buoy
rigs <- vessel_type_df %>%
  filter(str_detect(type, 'platform$|rig$|jack_up$|mooring_buoy$'))
```

## Prelim examination of data

Read in the data for apparent rigs.  Convert the resulting points to a raster, and check for apparent ship tracks. 
Note we can aggregate here to 0.1 degree, approximately the resolution of our Mollweide 10 km analysis resolution, to greatly reduce processing intensity.

``` {r}
rig_data <- lapply(rigs$f, FUN = function(f) {
    x <- read_csv(f) %>%
      janitor::clean_names() %>%
      mutate(across(-vessel_type, as.numeric))
    }) %>%
  bind_rows()

```

``` {r}
xyz <- rig_data %>%
  rename(x = round_lon, y = round_lat) %>%
  mutate(x = round(x, 1), y = round(y, 1)) %>%
  group_by(x, y) %>%
  summarize(z = sum(count_messages))

r_big <- rasterFromXYZ(xyz, res = 1, crs = '+init=epsg:4326', digits = 0)

plot(r_big, col = hcl.colors(20),
     main = '1.0° cells with observations (for easier visibility)',
     legend = FALSE, axes = FALSE)

r <- rasterFromXYZ(xyz, res = 0.1, crs = '+init=epsg:4326', digits = 1)

plot(r, col = hcl.colors(20),
     main = '0.1 deg cells with observations',
     legend = FALSE, axes = FALSE)
```

## Clean the data further

Drop observations where `count_messages` <= 5 (arbitrary but appears to work) to reduce or eliminate moving rigs passing through a cell.  For each remaining raw site (at 0.005 resolution), round the resolution, sum up how many raw sites are contained in the aggregated cell.  Use this to estimate the density of stationary rigs in a particular cell.

``` {r}
xyz2 <- rig_data %>%
  rename(x = round_lon, y = round_lat) %>%
  filter(count_messages > 5) %>%
  mutate(x = round(x, 1), y = round(y, 1)) %>%
  group_by(x, y) %>%
  summarize(z = n())

r_big <- rasterFromXYZ(xyz2, res = 1, crs = '+init=epsg:4326', digits = 0)

plot(r_big, col = hcl.colors(20), 
     main = '1.0° cells with observations (for easier visibility)',
     legend = FALSE, axes = FALSE)

r2 <- rasterFromXYZ(xyz2, res = 0.1, crs = '+init=epsg:4326', digits = 1)

plot(r2, col = hcl.colors(20), 
     main = '0.1 deg cells with observations',
     legend = FALSE, axes = FALSE)
```

## Finalize the data

We don't need to save the resulting data out as a raster; we can save it as a .csv that can be converted to a raster (with aggregation as needed) in a later script.  From the overall rigs dataframe, filter out locations with fewer than five pings, then what is left is presumed to be stationary (multiple pings from the same site). 

Values in result are:

`round_lat | round_lon | vessel_type`

```{r}

out_f <- here_anx('stressors/benthic_structures/benth_str_from_ais_2020.csv')
xyz3 <- rig_data %>%
  filter(count_messages > 5) %>%
  select(-count_messages) %>%
  distinct()

knitr::kable(head(xyz3))

knitr::kable(table(tolower(xyz3$vessel_type)))

write_csv(xyz3, out_f)
```

Note that this could also be multiple ship tracks that happen to intersect, but based on type and lack of apparent motion, we arrive at `r nrow(xyz3)` rigs, which is pretty close to the 1470 figure noted here: https://www.weforum.org/agenda/2015/10/where-are-the-worlds-oil-rigs/.






